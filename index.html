<!DOCTYPE html>
<html lang="en">
<head>
Â <meta charset="UTF-8">
Â <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â <title id="app-title">Hyper Availability Profile (HAP)</title>
Â <link rel="preconnect" href="https://fonts.googleapis.com">
Â <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â <style>
Â @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Roboto+Mono:wght@400;700&family=Playfair+Display:wght@700&display=swap');
Â :root {
Â --primary: #0ea5e9; --primary-light: #f0f9ff; --primary-dark: #0369a1;
Â --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
Â --border-color: #e2e8f0; --input-bg: #f1f5f9;
Â --radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
Â --pfp-bg-day: var(--primary-light);
Â --pfp-border-day: var(--primary);
Â --link-text-color: #0369a1;
Â --display-font: 'Inter', sans-serif;
Â }
Â body.dark {
Â --primary: #38bdf8; --primary-light: #1e293b; --primary-dark: #7dd3fc;
Â --bg: #020617; --card: #0f172a; --text: #e2e8f0; --muted: #94a3b8;
Â --border-color: #334155; --input-bg: #1e293b;
Â }
Â @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
Â @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
Â @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
Â @keyframes spin { 100% { transform: rotate(360deg); } }
Â @keyframes shake {
Â  0%, 100% { transform: translateX(0); }
Â  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
Â  20%, 40%, 60%, 80% { transform: translateX(5px); }
Â }
Â @keyframes unbox {
Â  0% { transform: scale(1); opacity: 1; }
Â  100% { transform: scale(1.5); opacity: 0; }
Â }
Â @keyframes feature-reveal {
Â  from { opacity: 0; transform: translateY(20px) scale(0.95); }
Â  to { opacity: 1; transform: translateY(0) scale(1); }
Â }
Â .page.active { animation: fadeIn 0.5s ease-out forwards; }
Â .card, .history-item, .search-result-item { animation: fadeSlideUp 0.6s ease-out forwards; opacity: 0; transform: translateY(15px); animation-fill-mode: both; }
Â html { font-size: 16px; scroll-behavior: smooth; }
Â body {
Â margin: 0; padding: 20px 0 100px 0;
Â font-family: var(--display-font);
Â background: var(--bg); color: var(--text);
Â -webkit-font-smoothing: antialiased;
Â transition: background-color 0.4s, color 0.4s;
Â }
Â header {
Â padding: 10px 14px; display: flex; gap: 12px; align-items: center; justify-content: center;
Â background: var(--card); box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
Â position: fixed; bottom: 0; left: 0; right: 0;
Â z-index: 100; border-top: 1px solid var(--border-color);
Â transition: transform 0.4s ease-in-out, background-color 0.4s;
Â }
Â header.hidden { transform: translateY(100%); }
Â nav { display: flex; gap: 8px; align-items: center; width: 100%; max-width: 500px; justify-content: space-around; }
Â .nav-btn {
Â background: transparent; border: none; padding: 8px 10px; border-radius: 8px;
Â cursor: pointer; color: var(--muted); font-weight: 500; font-size: 0.9rem;
Â display: flex; flex-direction: column; align-items: center; gap: 4px;
Â transition: all 0.2s ease;
Â }
Â .nav-btn.active { background: var(--primary-light); color: var(--primary-dark); }
Â .nav-btn:hover { color: var(--primary-dark); transform: translateY(-2px); }
Â .nav-btn svg { width: 24px; height: 24px; }
Â .container { max-width: 700px; margin: 0 auto; padding: 0 14px; }
Â .page { display: none; }
Â .page.active { display: block; }
Â .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; transition: background-color 0.4s, transform 0.3s ease; }
Â h1 { font-size: 2.25rem; font-weight: 700; margin: 0 0 8px 0; text-align: center; }
Â h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
Â h3 { font-size: 1.2rem; font-weight: 600; margin-top: 20px; }
Â p { color: var(--muted); line-height: 1.6; margin: 4px 0; }
Â label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--muted); }
Â input, select, textarea, button { font-size: 1rem; font-family: inherit; }
Â input[type="text"], input[type="email"], input[type="password"], input[type="url"], input[type="number"], input[type="time"], input[type="date"], input[type="tel"], select, textarea {
Â width: 100%; box-sizing: border-box; padding: 12px; border-radius: 8px;
Â border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text);
Â transition: border-color 0.3s, box-shadow 0.3s;
Â }
Â textarea { resize: vertical; min-height: 80px; }
Â input[type="color"] { width: 100%; height: 44px; padding: 0; border: none; background: transparent; cursor: pointer; }
Â input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: var(--primary); }
Â .btn {
Â background: var(--primary); color: white; border: none; padding: 12px 18px;
Â border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;
Â width: 100%; text-align: center; display: inline-flex; justify-content: center; align-items: center; gap: 8px;
Â }
Â .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
Â .btn:active { transform: translateY(0) scale(0.98); }
Â .btn.secondary { background: var(--primary-light); color: var(--primary-dark); }
Â .btn.secondary:hover { background-color: var(--primary); color: white; }
Â .btn:disabled { background-color: var(--muted); cursor: not-allowed; transform: none; box-shadow: none; }
Â .form-group { margin-bottom: 20px; }
Â #loginPage .card { margin-top: 40px; }
Â .auth-tabs { display: flex; margin-bottom: 25px; border-radius: 10px; background: var(--input-bg); padding: 5px; }
Â .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 500; transition: background-color 0.3s ease, color 0.3s; }
Â .tab.active { background-color: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
Â .social-login-btn { margin-top: 10px; background: #4285F4; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px; }
Â .social-login-btn:hover { background: #3c7ceb; }
Â .profile-header { text-align: center; margin-bottom: 30px; padding: 20px 0; }
Â #profile-pfp {
Â width: 96px; height: 96px; border-radius: 50%; margin: 0 auto 16px auto;
Â background-color: var(--pfp-bg-day); background-size: cover; background-position: center;
Â border: 3px solid var(--pfp-border-day); transition: all 0.4s;
Â display: flex; justify-content: center; align-items: center;
Â font-size: 3rem; font-weight: 700; color: var(--primary-dark);
Â }
Â .profile-emoji { font-size: 4rem; line-height: 1; margin: 16px 0; }
Â .profile-name {Â 
Â font-weight: 700; margin: 0; font-family: var(--display-font);Â 
Â display: flex; justify-content: center; align-items: center;Â 
Â font-size: 2.25rem;
Â color: var(--text);
Â }
Â .profile-name.is-owner { color: #ef4444; }
Â .role-badge-container {
Â display: flex; justify-content: center; align-items: center;
Â gap: 8px; margin: 5px auto 16px auto; flex-wrap: wrap; flex-direction: column;
Â }
Â .membership-badge {
Â font-size: 0.8rem; font-weight: 700; padding: 4px 10px;Â 
Â border-radius: 6px; color: white;
Â }
Â .tier-Member { background-color: #64748b; }
Â .tier-Plus { background-color: #a855f7; }
Â .tier-Pro { background: linear-gradient(45deg, #f59e0b, #fbbf24); }
Â .tier-Max { background: linear-gradient(45deg, #4f46e5, #7c3aed); }
Â .tier-Owner { background-color: #ef4444; }
Â .inline-verified-icon {
Â color: #0ea5e9; margin-left: 8px;
Â width: 24px; height: 24px; flex-shrink: 0;
Â }
Â .profile-message { font-size: 1.2rem; color: var(--muted); min-height: 28px; }
Â .profile-timer { font-size: 2.5rem; color: var(--primary); font-weight: 700; margin-top: 24px; min-height: 40px; }
Â .profile-country { display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; margin-top: 10px; }
Â .profile-country .flag-emoji { font-size: 1.5rem; }
Â .custom-link {
Â display: inline-flex; align-items: center; gap: 8px; background: var(--primary-light);
Â padding: 10px 15px; border-radius: 8px; text-decoration: none; color: var(--link-text-color);
Â font-weight: 500; transition: all 0.2s ease;
Â }
Â .custom-link:hover { background-color: var(--primary); color: #fff; transform: translateY(-2px); }
Â .custom-link svg { width: 18px; height: 18px; }
Â .action-links-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px; }
Â .personal-detail-item { font-size: 1rem; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }
Â .link-group, .privacy-group { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 15px; align-items: center; }
Â @media (max-width: 500px) { .link-group, .privacy-group { grid-template-columns: 1fr; } }
Â .country-select-wrapper { position: relative; }
Â .country-dropdown {
Â position: absolute; top: 100%; left: 0; right: 0;
Â background: var(--card); border: 1px solid var(--border-color); border-radius: 8px;
Â max-height: 200px; overflow-y: auto; z-index: 1000;
Â box-shadow: 0 4px 12px rgba(0,0,0,0.1);
Â }
Â .country-option { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
Â .country-option:hover { background: var(--input-bg); }
Â .country-option .flag-emoji { font-size: 1.2rem; }
Â .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-top: 20px; }
Â .analytics-metric { background: var(--input-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
Â .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary); margin: 0 0 5px 0; }
Â .metric-label { font-size: 0.9rem; color: var(--muted); font-weight: 500; }
Â .history-item { padding: 10px 0; border-left: 3px solid var(--border-color); margin-left: 10px; padding-left: 15px; position: relative; }
Â .history-item:before {
Â content: ''; position: absolute; left: -8px; top: 15px;
Â width: 13px; height: 13px; background: var(--primary); border-radius: 50%;
Â border: 3px solid var(--card); box-shadow: 0 0 0 2px var(--primary);
Â }
Â .history-status { font-weight: 600; color: var(--text); display: block; }
Â .history-time { font-size: 0.8rem; color: var(--muted); }
Â .search-result-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
Â .search-result-item a { text-decoration: none; font-weight: 600; color: var(--primary); }
Â footer { margin-top: 40px; text-align: center; color: var(--muted); font-size: 0.9rem; padding: 20px 0; border-top: 1px solid var(--border-color); }
Â footer a { color: var(--primary); text-decoration: none; margin: 0 5px; }
Â footer a:hover { text-decoration: underline; }
Â .hidden { display: none !important; }
Â #error-message { color: #ef4444; text-align: center; min-height: 24px; font-weight: bold; margin-top: 15px; }
Â #toast {
Â position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
Â background: #0f172a; color: white; padding: 12px 20px; border-radius: 8px;
Â z-index: 3000; visibility: hidden; opacity: 0; transition: all 0.4s ease;
Â text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
Â }
Â #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
Â #global-error-display {
Â position: fixed; top: 0; left: 0; right: 0; padding: 15px;
Â background: #f87171; color: white; text-align: center; font-weight: bold;
Â z-index: 5000; display: none; border-bottom: 2px solid #ef4444;
Â }
Â .btn-loading { pointer-events: none; opacity: 0.8; }
Â .btn-loading::after {
Â content: ""; border: 3px solid rgba(255, 255, 255, 0.3);
Â border-top: 3px solid white; border-radius: 50%;
Â width: 16px; height: 16px; animation: spin 1s linear infinite;
Â }
Â .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
Â .admin-table th, .admin-table td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
Â .admin-table th { background-color: var(--input-bg); }
Â .admin-table select { padding: 6px; }
Â .achievement-item { margin-bottom: 15px; }
Â .achievement-progress { width: 100%; background: var(--input-bg); border-radius: 8px; height: 10px; overflow: hidden; margin-top: 6px; }
Â .progress-bar { height: 100%; background: var(--primary); border-radius: 8px; transition: width 0.5s ease; }
Â .verification-request-card { background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
Â .verification-request-card p { margin: 0 0 10px 0; }
Â .verification-actions { display: flex; gap: 10px; margin-top: 10px; }
Â .tier-plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
Â .tier-plan-card { background: var(--input-bg); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); }
Â .tier-plan-card h3 { margin-top: 0; display: flex; align-items: center; gap: 8px; }
Â .tier-plan-card ul { list-style-type: 'âœ“ '; padding-left: 20px; color: var(--muted); }
Â .tier-plan-card ul li { margin-bottom: 8px; }
Â #top-ad-container a, #bottom-ad-container a {
Â  display: block; text-decoration: none; color: inherit;
Â  border-radius: var(--radius); transition: transform 0.2s ease;
Â }
Â #top-ad-container a:hover, #bottom-ad-container a:hover { transform: scale(1.02); }
Â #top-ad-container img { max-width: 100%; border-radius: var(--radius); display: block; }
Â #bottom-ad-container { font-weight: 500; background-color: var(--input-bg); }
Â #create-hap-promo-top {
Â  Â  padding: 10px 15px; display: flex; align-items: center;
Â  Â  justify-content: space-between; gap: 15px;
Â }
Â #create-hap-promo-top h3, #create-hap-promo-top p { margin: 0; text-align: left; }
Â #create-hap-promo-top h3 { font-size: 1rem; }
Â #create-hap-promo-top p { font-size: 0.9rem; }
Â #create-hap-promo-top .btn {
Â  Â  flex-shrink: 0; padding: 8px 12px; font-size: 0.9rem; width: auto;
Â }
Â @media (max-width: 500px) {
Â  Â  #create-hap-promo-top { flex-direction: column; text-align: center; }
Â  Â  #create-hap-promo-top h3, #create-hap-promo-top p { text-align: center; }
Â }
Â .tier-upgrade-modal {
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background-color: rgba(0,0,0,0.6); z-index: 4000;
Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s;
Â }
Â .tier-upgrade-modal.show { opacity: 1; visibility: visible; }
Â .upgrade-modal-content {
Â  Â  background: var(--card); color: var(--text); padding: 30px;
Â  Â  border-radius: var(--radius); width: 90%; max-width: 400px;
Â  Â  text-align: center; position: relative;
Â }
Â .gift-box { cursor: pointer; font-size: 6rem; transition: transform 0.2s ease; }
Â .gift-box:hover { transform: scale(1.1); animation: shake 0.5s; }
Â .gift-box.unboxing { animation: unbox 0.5s ease-out forwards; }
Â .upgrade-results { display: none; }
Â .upgrade-results.show { display: block; }
Â .unlocked-feature {
Â  Â  background-color: var(--input-bg); padding: 10px;
Â  Â  border-radius: 8px; margin-bottom: 10px; font-weight: 500;
Â  Â  animation: feature-reveal 0.5s ease-out backwards;
Â }
Â .country-stat-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
Â .country-stat-item:last-child { border-bottom: none; }
Â #views-chart-container { display: flex; justify-content: space-around; align-items: flex-end; height: 150px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 20px; }
Â .chart-bar-wrapper { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: flex-end; }
Â .chart-bar { background: var(--primary); width: 60%; margin: 0 auto; transition: height 0.5s ease-out; border-radius: 4px 4px 0 0; }
Â .chart-label { font-size: 0.8rem; color: var(--muted); margin-top: 8px; }
Â #loading-overlay {
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background: var(--bg); z-index: 9999;
Â  Â  display: flex; flex-direction: column; justify-content: center; align-items: center;
Â  Â  transition: opacity 0.5s ease;
Â }
Â #loading-overlay.hidden {
Â  Â  opacity: 0;
Â  Â  pointer-events: none;
Â }
Â .spinner {
Â  Â  width: 48px; height: 48px;
Â  Â  border: 5px solid var(--border-color);
Â  Â  border-bottom-color: var(--primary);
Â  Â  border-radius: 50%;
Â  Â  display: inline-block;
Â  Â  box-sizing: border-box;
Â  Â  animation: spin 1s linear infinite;
Â  Â  margin-bottom: 20px;
Â }
Â .modal {
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background-color: rgba(0,0,0,0.6); z-index: 4000;
Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  opacity: 0; visibility: hidden; transition: opacity 0.4s ease, visibility 0.4s;
Â }
Â .modal.show { opacity: 1; visibility: visible; }
Â .modal-content {
Â  Â  background: var(--card); color: var(--text); padding: 30px;
Â  Â  border-radius: var(--radius); width: 90%; max-width: 500px;
Â  Â  position: relative;
Â }
Â .modal-close-btn {
Â  Â  position: absolute; top: 10px; right: 10px;
Â  Â  background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);
Â }
Â </style>
</head>
<body>
Â <div id="loading-overlay">
Â  Â  <div class="spinner"></div>
Â  Â  <p>Loading Profile...</p>
Â </div>
Â <div id="global-error-display">A critical error occurred. Check the console for details.</div>
Â <header id="mainHeader" class="hidden"></header>
Â <div class="container">
Â <div id="loginPage" class="page">
Â <div class="card">
Â <h1>Hyper Availability</h1>
Â <p style="text-align: center;">Your real-time public status page.</p>
Â <div class="auth-tabs">
Â <div class="tab active" data-tab="login">Login</div>
Â <div class="tab" data-tab="signup">Sign Up</div>
Â </div>
Â <div id="login-form-container">
Â <form id="login-form">
Â <div class="form-group"><input type="email" id="login-email" placeholder="Email" required></div>
Â <div class="form-group"><input type="password" id="login-password" placeholder="Password" required></div>
Â <button type="submit" class="btn">Login</button>
Â </form>
Â <button id="google-login-btn" class="social-login-btn">
Â <svg viewBox="0 0 24 24" width="24" height="24" style="background: white; border-radius: 50%; padding: 4px;"><path fill="#EA4335" d="M5.266 9.389a6.6 6.6 0 0 1 .235-1.565h3.08v3.136H5.266z"></path><path fill="#4285F4" d="M12 21.36c-2.333 0-4.32-.778-5.755-2.072L9.36 17.06c.9.605 2.07 1.05 3.398 1.05 2.872 0 4.673-1.637 4.673-3.957 0-1.724-.96-2.91-2.5-3.69v-3.3h3.045c2.324 0 3.86 1.764 3.86 5.25 0 4.8-3.045 7.027-7.426 7.027z"></path><path fill="#FBBC05" d="M12 7.03c1.64 0 2.977.674 3.69 1.344l2.42-2.348C17.042 4.417 15.02 3 12 3 7.61 3 4.195 5.253 2.57 9.172l3.045 2.368c.57-1.897 2.37-3.67 6.385-3.67z"></path><path fill="#34A853" d="M5.504 12.87a6.22 6.22 0 0 1-.238-1.564H2.227v3.136h3.277z"></path></svg>
Â Login with Google
Â </button>
Â </div>
Â <form id="signup-form" class="hidden">
Â <h3>Create Personal Account</h3>
Â <div class="form-group"><input type="text" id="signup-name" placeholder="Display Name" required></div>
Â <div class="form-group"><input type="email" id="signup-email" placeholder="Email" required></div>
Â <div class="form-group"><input type="password" id="signup-password" placeholder="Password (min. 6 chars)" required></div>
Â <button type="submit" class="btn">Create Personal Account</button>
Â </form>
Â <p id="error-message"></p>
Â </div>
Â </div>
Â <div id="profilePage" class="page">
Â <div id="create-hap-promo-top" class="card hidden"></div>
Â <div id="top-ad-container" class="card hidden" style="padding: 10px; text-align: center;"></div>
Â <div class="profile-header">
Â <div id="profile-pfp"></div>Â 
Â <div style="padding: 0 20px 20px 20px;">
Â <h1 class="profile-name" id="profile-name">Loading...</h1>
Â <div id="membership-tier-display-container" class="role-badge-container"></div>
Â <div class="profile-emoji" id="profile-emoji">â“</div>
Â <p class="profile-message" id="profile-message">Fetching status...</p>
Â <div class="profile-timer" id="profile-timer"></div>
Â <p class="local-time-display" id="local-time-info" style="font-size: 1rem; margin-top: 10px; font-weight: 500;"></p>
Â </div>
Â </div>
Â <div class="card action-links-container" id="profile-action-links"></div>
Â <div class="card">
Â <h2>About</h2>
Â <div id="personal-details-list"><p class="muted">Loading personal info...</p></div>
Â </div>
Â <div class="card">
Â <h2>Custom Links</h2>
Â <div id="profile-links"><p class="muted">No links provided.</p></div>
Â </div>
Â <div id="share-profile-card" class="card">
Â <h2>Share Profile</h2>
Â <div style="text-align: center;">
Â <div id="qrcode-container" style="display: inline-block; padding: 15px; background: var(--card); border-radius: 8px; border: 1px solid var(--border-color); min-height: 230px;">
Â <img id="profile-qrcode-img" width="200" height="200" loading="lazy" style="display: none; border-radius: 4px;" alt="Profile QR Code">Â 
Â <p id="qrcode-placeholder" class="muted">Click button below to generate QR.</p>
Â </div>
Â </div>
Â <button id="generate-qrcode-btn" class="btn secondary" style="margin-top: 15px;">Generate QR Code</button>
Â <button id="share-status-btn" class="btn" style="margin-top: 10px;">Copy Profile Link</button>
Â </div>
Â <div id="bottom-ad-container" class="card hidden" style="padding: 20px; text-align: center;"></div>
Â <div id="create-hap-promo-bottom" class="card hidden"></div>
Â </div>
Â <div id="searchPage" class="page">
Â <div class="card">
Â <h2>HAP Directory ğŸŒ</h2>
Â <div class="form-group" style="margin-bottom: 0;">
Â <input type="text" id="user-search-input" placeholder="Search users by name...">
Â </div>
Â <button id="run-search-btn" class="btn secondary" style="margin-top: 10px;">Search / Load Directory</button>
Â <div id="search-results-list" style="margin-top: 20px;">
Â <p class="muted">Search for users by name or click 'Search' to view all public profiles.</p>
Â </div>
Â </div>
Â </div>
Â <div id="analyticsPage" class="page">
Â <div class="card">
Â <h2>Profile View Analytics ğŸ“ˆ</h2>
Â <div class="analytics-grid" id="view-analytics-grid">
Â <div class="analytics-metric"><p class="metric-value" id="views-total">0</p><p class="metric-label">Total Views</p></div>
Â <div class="analytics-metric"><p class="metric-value" id="views-unique">0</p><p class="metric-label">Unique Visitors</p></div>
Â <div class="analytics-metric"><p class="metric-value" id="views-today">0</p><p class="metric-label">Views Today</p></div>
Â <div class="analytics-metric"><p class="metric-value" id="views-week">0</p><p class="metric-label">Views Last 7 Days</p></div>
Â </div>
Â <div id="analytics-upgrade-prompt" class="hidden" style="text-align: center; margin-top: 20px;">
Â  Â  <p>Upgrade to the <strong>Personal</strong> tier for more detailed analytics!</p>
Â </div>
Â </div>
Â <div class="card" id="analytics-chart-card">
Â  Â  <h2>Last 7 Days Trend</h2>
Â  Â  <div id="views-chart-container"><p class="muted">Loading chart data...</p></div>
Â </div>
Â <div class="card" id="analytics-country-card">
Â  Â  <h2>Views by Country</h2>
Â  Â  <div id="country-stats-list"><p class="muted">Loading country data...</p></div>
Â </div>
Â <div class="card">
Â <h2>Status History Timeline (Last 10)</h2>
Â <div id="history-log"><p class="muted">Loading history...</p></div>
Â </div>
Â </div>
Â <div id="tiersPage" class="page">
Â <div class="card">
Â <h2>My Tier & Progress</h2>
Â <div id="my-plan-details"><p class="muted">Loading your plan details...</p></div>
Â </div>
Â <div class="card">
Â <div id="my-plan-progress"><p class="muted">Loading your achievement progress...</p></div>
Â </div>
Â <div class="card">
Â <h2>All Tiers & Benefits</h2>
Â <div id="all-tiers-info"><p class="muted">Loading all tiers...</p></div>
Â </div>
Â </div>
Â <div id="adminPage" class="page">
Â <div class="card">
Â <h2>ğŸ‘‘ Admin Panel</h2>
Â <p class="muted">Manage users and verification requests.</p>
Â </div>
Â <div class="card">
Â <h2>Verification Requests</h2>
Â <div id="admin-verification-requests"><p class="muted">Loading requests...</p></div>
Â </div>
Â <div class="card">
Â <h2>All Users</h2>
Â <div id="admin-all-users" style="max-height: 400px; overflow-y: auto;"><p class="muted">Loading users...</p></div>
Â </div>
Â </div>
Â <div id="settingsPage" class="page">
Â <div class="card">
Â <h2>Profile Settings</h2>
Â <div class="form-group">
Â <label for="display-name">Display Name</label>
Â <input type="text" id="display-name">
Â </div>
Â <div class="form-group">
Â <label for="themeSelect">Theme</label>
Â <select id="themeSelect">
Â <option value="auto">Auto (Day/Night)</option>
Â <option value="light">Light</option>
Â <option value="dark">Dark</option>
Â </select>
Â </div>
Â <div class="form-group" id="font-customization-field">
Â <label for="display-font">Display Name Font</label>
Â <select id="display-font">
Â <option value="Inter, sans-serif">Inter (Default)</option>
Â <option value="Poppins, sans-serif">Poppins</option>
Â <option value="Roboto Mono, monospace">Roboto Mono</option>
Â <option value="Playfair Display, serif">Playfair Display</option>
Â </select>
Â </div>
Â </div>
Â <div class="card">
Â <h2>Personal Info</h2>
Â <div class="form-group">
Â <label for="bio">Short Bio / Tagline</label>
Â <textarea id="bio" placeholder="A brief description of yourself."></textarea>
Â </div>
Â <div class="form-group">
Â <label for="birthday">Birthday</label>
Â <input type="date" id="birthday">
Â </div>
Â <div class="form-group">
Â <label for="country-search">Country</label>
Â <div class="country-select-wrapper">
Â <input type="text" id="country-search" placeholder="Search for a country...">
Â <div id="country-dropdown" class="country-dropdown hidden"></div>
Â </div>
Â <input type="hidden" id="country-code">
Â </div>
Â <div class="form-group">
Â <label for="phone-number">Public Phone Number</label>
Â <input type="tel" id="phone-number" placeholder="+1 (555) 123-4567">
Â </div>
Â <div class="form-group" id="scheduling-link-field">
Â <label for="scheduling-link">Scheduling Link (e.g., Calendly)</label>
Â <input type="url" id="scheduling-link" placeholder="https://calendly.com/yourname">
Â </div>
Â </div>
Â <div class="card">
Â <h2>Visual Customization</h2>
Â <div class="form-group" id="pfp-url-group">
Â <label for="pfp-url">Profile Picture URL</label>
Â <input type="url" id="pfp-url" placeholder="https://example.com/image.png">
Â </div>
Â <div class="form-group" id="accent-color-field">
Â <label for="accent-color">Profile Accent Color</label>
Â <input type="color" id="accent-color" value="#0ea5e9">
Â </div>
Â <div class="form-group" id="link-text-color-field">
Â <label for="link-text-color">Custom Link Text Color</label>
Â <input type="color" id="link-text-color" value="#0369a1">
Â </div>
Â </div>
Â <div class="card">
Â <h2>Update Status</h2>
Â <div class="form-group">
Â <label for="status-emoji">Current Status</label>
Â <select id="status-emoji">
Â <option value="ğŸŸ¢">ğŸŸ¢ Available</option>
Â <option value="ğŸ’»">ğŸ’» Busy</option>
Â <option value="ğŸ§ ">ğŸ§  Deep Work</option>
Â <option value="ğŸš—">ğŸš— Commuting</option>
Â <option value="â˜•">â˜• On a Break</option>
Â <option value="ğŸ”´">ğŸ”´ Do Not Disturb</option>
Â <option value="ğŸ“š">ğŸ“š School/Study</option>
Â <option value="ğŸ–ï¸">ğŸ–ï¸ Vacation/OOO</option>
Â <option value="ğŸ˜´">ğŸ˜´ Offline/Sleeping</option>
Â <option value="ğŸ½ï¸">ğŸ½ï¸ Meal Time</option>
Â <option value="ğŸ‹ï¸">ğŸ‹ï¸ Working Out</option>
Â <option value="ğŸ®">ğŸ® Gaming</option>
Â <option value="âœˆï¸">âœˆï¸ Traveling</option>
Â </select>
Â </div>
Â <div class="form-group">
Â <label for="status-message">Message</label>
Â <input type="text" id="status-message" placeholder="e.g., Drafting 2026 Strategy">
Â </div>
Â </div>
Â <div class="card">
Â <h2>Custom Links</h2>
Â <div id="custom-links-container"></div>
Â </div>
Â <div class="card">
Â <h2>Verification</h2>
Â <div id="verification-section"></div>
Â </div>
Â <div class="card hidden" id="custom-ads-settings-card">
Â  Â  <h2>Promotional Blocks ğŸ“¢</h2>
Â  Â  <p class="muted">As a Pro tier member or higher, you can display your own custom content on your public profile.</p>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="ads-enabled-toggle">Display Custom Blocks</label>
Â  Â  Â  Â  <select id="ads-enabled-toggle">
Â  Â  Â  Â  <option value="false">Disabled</option>
Â  Â  Â  Â  <option value="true">Enabled</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  Â  <div id="ad-customization-fields" class="hidden">
Â  Â  Â  Â  <h3 style="margin-top: 30px;">Top Block (Image Banner)</h3>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="top-ad-image-url">Image URL</label>
Â  Â  Â  Â  <input type="url" id="top-ad-image-url" placeholder="https://example.com/banner.png">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="top-ad-link-url">Target URL (when banner is clicked)</label>
Â  Â  Â  Â  <input type="url" id="top-ad-link-url" placeholder="https://your-project.com">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <h3 style="margin-top: 30px;">Bottom Block (Text)</h3>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="bottom-ad-text">Text Content</label>
Â  Â  Â  Â  <input type="text" id="bottom-ad-text" placeholder="Check out my new project!">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="bottom-ad-link-url">Target URL (when text is clicked)</label>
Â  Â  Â  Â  <input type="url" id="bottom-ad-link-url" placeholder="https://your-other-project.com">
Â  Â  Â  Â  </div>
Â  Â  </div>
Â </div>
Â <div class="card hidden" id="platform-ad-settings-card">
Â  Â  <h2>Platform Ad Settings</h2>
Â  Â  <p class="muted">As a Max tier user, you can control the visibility of the default 'Join HAP' promotion on your profile.</p>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="platform-ad-toggle">"Join HAP" Promotion</label>
Â  Â  Â  Â  <select id="platform-ad-toggle">
Â  Â  Â  Â  Â  Â  <option value="off">Disabled</option>
Â  Â  Â  Â  Â  Â  <option value="top">Show at Top</option>
Â  Â  Â  Â  Â  Â  <option value="bottom">Show at Bottom</option>
Â  Â  Â  Â  Â  Â  <option value="both">Show at Top & Bottom</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â </div>
Â <div class="card">
Â <button id="save-settings-btn" class="btn">Save All Changes</button>
Â <button id="logout-btn" class="btn secondary" style="margin-top: 12px;">Logout</button>
Â <button id="delete-account-btn" class="btn" style="margin-top: 20px; background-color: #ef4444; color: white;">Delete My Account Permanently</button>
Â </div>
Â </div>
Â </div>
Â <footer>
Â <p>&copy; 2025 HAP | A Demo Project</p>
Â </footer>
Â <div id="toast"></div>
Â 
Â Â <div id="tier-upgrade-modal" class="tier-upgrade-modal">
Â  Â  <div class="upgrade-modal-content">
Â  Â  Â  Â  <div id="upgrade-gift-stage">
Â  Â  Â  Â  Â  Â  <h2>You've Been Promoted!</h2>
Â  Â  Â  Â  Â  Â  <p>Click the gift to reveal your new perks!</p>
Â  Â  Â  Â  Â  Â  <div id="gift-box-icon" class="gift-box">ğŸ</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="upgrade-results-stage" class="upgrade-results">
Â  Â  Â  Â  Â  Â  <h2>Welcome to <span id="new-tier-name"></span>!</h2>
Â  Â  Â  Â  Â  Â  <p>You've unlocked these new features:</p>
Â  Â  Â  Â  Â  Â  <div id="unlocked-features-list"></div>
Â  Â  Â  Â  Â  Â  <button id="close-upgrade-modal-btn" class="btn" style="margin-top: 20px;">Awesome!</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â </div>

Â <script type="module">
Â import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
Â import {Â 
Â getAuth,Â 
Â GoogleAuthProvider,Â 
Â signInWithPopup,Â 
Â createUserWithEmailAndPassword,Â 
Â signInWithEmailAndPassword,Â 
Â onAuthStateChanged,Â 
Â signOut,
Â deleteUser,
Â updateProfile
Â } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
Â import {Â 
Â getDatabase,Â 
Â ref,Â 
Â set,Â 
Â get,Â 
Â update,
Â push,Â 
Â query,Â 
Â orderByKey,Â 
Â limitToLast
Â } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

Â const firebaseConfig = {
Â apiKey: "AIzaSyChwjwXFgIj9f64zGeIoS-q_odZm2ogFMw",
Â authDomain: "happp-96438.firebaseapp.com",
Â databaseURL: "https://happp-96438-default-rtdb.firebaseio.com",
Â projectId: "happp-96438",
Â storageBucket: "happp-96438.appspot.com",
Â messagingSenderId: "703348367691",
Â appId: "1:703348367691:web:376cd50d08d94bccf588ce"
Â };

Â const app = initializeApp(firebaseConfig);
Â const auth = getAuth(app);
Â const db = getDatabase(app);

Â window.onerror = function(message, source, lineno, colno, error) {
Â const errorDiv = document.getElementById('global-error-display');
Â if (errorDiv) {
Â errorDiv.style.display = 'block';
Â errorDiv.textContent = `CRITICAL ERROR: ${message} (Line ${lineno})`;
Â }
Â console.error("Global Error Caught:", message, source, lineno, colno, error);
Â return false;
Â };
Â 
Â function hideLoadingOverlay() {
Â  Â  const loader = document.getElementById('loading-overlay');
Â  Â  if (loader) {
Â  Â  Â  Â  loader.classList.add('hidden');
Â  Â  }
Â }

Â let countdownInterval;
Â let isPublicView = false;
Â let publicViewInterval = null;
Â let isAuthResolved = false;

Â const App = {
Â pages: ['loginPage', 'profilePage', 'searchPage', 'analyticsPage', 'settingsPage', 'tiersPage', 'adminPage'],
Â elements: {},
Â currentUser: null,
Â currentProfileData: null,
Â };

Â const USER_TIER_CONFIG = {
Â  'Member': {Â 
Â  Â  name: 'Basic', linkLimit: 1, pfp: false, qrCode: false, customFont: false, customColor: false,Â 
Â  Â  scheduling: false, analytics: 'limited', verification: false,Â 
Â  Â  canCustomizeAds: false, canControlPlatformAd: false
Â  },
Â  'Plus': {Â 
Â  Â  name: 'Personal', linkLimit: 3, pfp: true, qrCode: true, customFont: true, customColor: true,Â 
Â  Â  scheduling: false, analytics: true, verification: false,Â 
Â  Â  canCustomizeAds: false, canControlPlatformAd: false
Â  },
Â  'Pro': {Â 
Â  Â  name: 'Professional', linkLimit: 5, pfp: true, qrCode: true, customFont: true, customColor: true,Â 
Â  Â  scheduling: false, analytics: true, verification: true,Â 
Â  Â  canCustomizeAds: true, canControlPlatformAd: false
Â  },
Â  'Max': {Â 
Â  Â  name: 'Power User', linkLimit: 10, pfp: true, qrCode: true, customFont: true, customColor: true,Â 
Â  Â  scheduling: true, analytics: true, verification: true,Â 
Â  Â  canCustomizeAds: true, canControlPlatformAd: trueÂ 
Â  },
Â  'Owner': {
Â  Â  name: 'Owner', linkLimit: 10, pfp: true, qrCode: true, customFont: true, customColor: true,Â 
Â  Â  scheduling: true, analytics: true, verification: true,Â 
Â  Â  canCustomizeAds: true, canControlPlatformAd: true
Â  },
Â };
Â 
Â const ACHIEVEMENT_CONFIG = {
Â  toPlus: [
Â  Â  { id: 'profileComplete', label: 'The Basics: Fill in Bio, Birthday, and Country', goal: 1 },
Â  Â  { id: 'expressive', label: 'Express Yourself: Use 3 different statuses', goal: 3 },
Â  Â  { id: 'socialButterfly', label: 'Branch Out: Add your first custom link', goal: 1 },
Â  Â  { id: 'loyalUser', label: 'Getting Started: Log in on 3 different days', goal: 3 },
Â  Â  { id: 'firstShare', label: 'Go Public: Share your profile for the first time', goal: 1 }
Â  ],
Â  toPro: [
Â  Â  { id: 'views', label: 'Getting Noticed: Get 50 profile views', goal: 50 },
Â  Â  { id: 'picturePerfect', label: 'Picture Perfect: Add a custom profile picture', goal: 1 },
Â  Â  { id: 'loyalUser', label: 'Week-Long Streak: Log in on 7 different days', goal: 7 },
Â  Â  { id: 'expressive', label: 'Mood Changer: Use 5 different statuses', goal: 5 }
Â  ],
Â  toMax: [
Â  Â  { id: 'views', label: 'Local Celebrity: Get 150 profile views', goal: 150 },
Â  Â  { id: 'referral', label: 'Community Builder: Have someone join using your link', goal: 1 },
Â  Â  { id: 'loyalUser', label: 'Consistent Presence: Log in on 30 different days', goal: 30 },
Â  Â  { id: 'expressive', label: 'Status Guru: Use 10 different statuses', goal: 10 }
Â  ]
Â };

Â const FEATURE_FRIENDLY_NAMES = {
Â  Â  pfp: "Custom Profile Picture",
Â  Â  qrCode: "Profile QR Code Sharing",
Â  Â  customFont: "Custom Profile Font",
Â  Â  customColor: "Custom Profile Colors",
Â  Â  scheduling: "Scheduling Link Display",
Â  Â  analytics: "Profile Analytics",
Â  Â  verification: "Verification Eligibility",
Â  Â  canCustomizeAds: "Custom Promotional Blocks",
Â  Â  canControlPlatformAd: "Platform Ad Controls"
Â };

Â const VERIFICATION_QUESTIONS = [
Â "What is the primary purpose of your HAP profile? (e.g., professional networking, personal status, team coordination)",
Â "Please provide a link to an existing public profile that can help verify your identity (e.g., LinkedIn, Twitter, personal website, or official company page).",
Â "What is your full legal name?",
Â "Briefly describe why you should be granted a verified status on this platform.",
Â "Please provide a contact email or phone number that we can use to follow up on this verification request (this will be kept private)."
Â ];

Â const COUNTRY_LIST = [ {name: "Afghanistan", code: "AF"}, {name: "Ã…land Islands", code: "AX"}, {name: "Albania", code: "AL"}, {name: "Algeria", code: "DZ"}, {name: "American Samoa", code: "AS"}, {name: "Andorra", code: "AD"}, {name: "Angola", code: "AO"}, {name: "Anguilla", code: "AI"}, {name: "Antarctica", code: "AQ"}, {name: "Antigua and Barbuda", code: "AG"}, {name: "Argentina", code: "AR"}, {name: "Armenia", code: "AM"}, {name: "Aruba", code: "AW"}, {name: "Australia", code: "AU"}, {name: "Austria", code: "AT"}, {name: "Azerbaijan", code: "AZ"}, {name: "Bahamas", code: "BS"}, {name: "Bahrain", code: "BH"}, {name: "Bangladesh", code: "BD"}, {name: "Barbados", code: "BB"}, {name: "Belarus", code: "BY"}, {name: "Belgium", code: "BE"}, {name: "Belize", code: "BZ"}, {name: "Benin", code: "BJ"}, {name: "Bermuda", code: "BM"}, {name: "Bhutan", code: "BT"}, {name: "Bolivia", code: "BO"}, {name: "Bosnia and Herzegovina", code: "BA"}, {name: "Botswana", code: "BW"}, {name: "Bouvet Island", code: "BV"}, {name: "Brazil", code: "BR"}, {name: "British Indian Ocean Territory", code: "IO"}, {name: "Brunei Darussalam", code: "BN"}, {name: "Bulgaria", code: "BG"}, {name: "Burkina Faso", code: "BF"}, {name: "Burundi", code: "BI"}, {name: "Cambodia", code: "KH"}, {name: "Cameroon", code: "CM"}, {name: "Canada", code: "CA"}, {name: "Cape Verde", code: "CV"}, {name: "Cayman Islands", code: "KY"}, {name: "Central African Republic", code: "CF"}, {name: "Chad", code: "TD"}, {name: "Chile", code: "CL"}, {name: "China", code: "CN"}, {name: "Christmas Island", code: "CX"}, {name: "Cocos (Keeling) Islands", code: "CC"}, {name: "Colombia", code: "CO"}, {name: "Comoros", code: "KM"}, {name: "Congo", code: "CG"}, {name: "Congo, The Democratic Republic of the", code: "CD"}, {name: "Cook Islands", code: "CK"}, {name: "Costa Rica", code: "CR"}, {name: "Cote D'Ivoire", code: "CI"}, {name: "Croatia", code: "HR"}, {name: "Cuba", code: "CU"}, {name: "Cyprus", code: "CY"}, {name: "Czech Republic", code: "CZ"}, {name: "Denmark", code: "DK"}, {name: "Djibouti", code: "DJ"}, {name: "Dominica", code: "DM"}, {name: "Dominican Republic", code: "DO"}, {name: "Ecuador", code: "EC"}, {name: "Egypt", code: "EG"}, {name: "El Salvador", code: "SV"}, {name: "Equatorial Guinea", code: "GQ"}, {name: "Eritrea", code: "ER"}, {name: "Estonia", code: "EE"}, {name: "Ethiopia", code: "ET"}, {name: "Falkland Islands (Malvinas)", code: "FK"}, {name: "Faroe Islands", code: "FO"}, {name: "Fiji", code: "FJ"}, {name: "Finland", code: "FI"}, {name: "France", code: "FR"}, {name: "French Guiana", code: "GF"}, {name: "French Polynesia", code: "PF"}, {name: "French Southern Territories", code: "TF"}, {name: "Gabon", code: "GA"}, {name: "Gambia", code: "GM"}, {name: "Georgia", code: "GE"}, {name: "Germany", code: "DE"}, {name: "Ghana", code: "GH"}, {name: "Gibraltar", code: "GI"}, {name: "Greece", code: "GR"}, {name: "Greenland", code: "GL"}, {name: "Grenada", code: "GD"}, {name: "Guadeloupe", code: "GP"}, {name: "Guam", code: "GU"}, {name: "Guatemala", code: "GT"}, {name: "Guernsey", code: "GG"}, {name: "Guinea", code: "GN"}, {name: "Guinea-Bissau", code: "GW"}, {name: "Guyana", code: "GY"}, {name: "Haiti", code: "HT"}, {name: "Heard Island and Mcdonald Islands", code: "HM"}, {name: "Holy See (Vatican City State)", code: "VA"}, {name: "Honduras", code: "HN"}, {name: "Hong Kong", code: "HK"}, {name: "Hungary", code: "HU"}, {name: "Iceland", code: "IS"}, {name: "India", code: "IN"}, {name: "Indonesia", code: "ID"}, {name: "Iran, Islamic Republic Of", code: "IR"}, {name: "Iraq", code: "IQ"}, {name: "Ireland", code: "IE"}, {name: "Isle of Man", code: "IM"}, {name: "Israel", code: "IL"}, {name: "Italy", code: "IT"}, {name: "Jamaica", code: "JM"}, {name: "Japan", code: "JP"}, {name: "Jersey", code: "JE"}, {name: "Jordan", code: "JO"}, {name: "Kazakhstan", code: "KZ"}, {name: "Kenya", code: "KE"}, {name: "Kiribati", code: "KI"}, {name: "Korea, Democratic People'S Republic of", code: "KP"}, {name: "Korea, Republic of", code: "KR"}, {name: "Kuwait", code: "KW"}, {name: "Kyrgyzstan", code: "KG"}, {name: "Lao People'S Democratic Republic", code: "LA"}, {name: "Latvia", code: "LV"}, {name: "Lebanon", code: "LB"}, {name: "Lesotho", code: "LS"}, {name: "Liberia", code: "LR"}, {name: "Libyan Arab Jamahiriya", code: "LY"}, {name: "Liechtenstein", code: "LI"}, {name: "Lithuania", code: "LT"}, {name: "Luxembourg", code: "LU"}, {name: "Macao", code: "MO"}, {name: "Macedonia, The Former Yugoslav Republic of", code: "MK"}, {name: "Madagascar", code: "MG"}, {name: "Malawi", code: "MW"}, {name: "Malaysia", code: "MY"}, {name: "Maldives", code: "MV"}, {name: "Mali", code: "ML"}, {name: "Malta", code: "MT"}, {name: "Marshall Islands", code: "MH"}, {name: "Mauritania", code: "MR"}, {name: "Mauritius", code: "MU"}, {name: "Mayotte", code: "YT"}, {name: "Mexico", code: "MX"}, {name: "Micronesia, Federated States of", code: "FM"}, {name: "Moldova, Republic of", code: "MD"}, {name: "Monaco", code: "MC"}, {name: "Mongolia", code: "MN"}, {name: "Montserrat", code: "MS"}, {name: "Morocco", code: "MA"}, {name: "Mozambique", code: "MZ"}, {name: "Myanmar", code: "MM"}, {name: "Namibia", code: "NA"}, {name: "Nauru", code: "NR"}, {name: "Nepal", code: "NP"}, {name: "Netherlands", code: "NL"}, {name: "Netherlands Antilles", code: "AN"}, {name: "New Caledonia", code: "NC"}, {name: "New Zealand", code: "NZ"}, {name: "Nicaragua", code: "NI"}, {name: "Niger", code: "NE"}, {name: "Nigeria", code: "NG"}, {name: "Niue", code: "NU"}, {name: "Norfolk Island", code: "NF"}, {name: "Northern Mariana Islands", code: "MP"}, {name: "Norway", code: "NO"}, {name: "Oman", code: "OM"}, {name: "Pakistan", code: "PK"}, {name: "Palau", code: "PW"}, {name: "Palestinian Territory, Occupied", code: "PS"}, {name: "Panama", code: "PA"}, {name: "Papua New Guinea", code: "PG"}, {name: "Paraguay", code: "PY"}, {name: "Peru", code: "PE"}, {name: "Philippines", code: "PH"}, {name: "Pitcairn", code: "PN"}, {name: "Poland", code: "PL"}, {name: "Portugal", code: "PT"}, {name: "Puerto Rico", code: "PR"}, {name: "Qatar", code: "QA"}, {name: "Reunion", code: "RE"}, {name: "Romania", code: "RO"}, {name: "Russian Federation", code: "RU"}, {name: "RWANDA", code: "RW"}, {name: "Saint Helena", code: "SH"}, {name: "Saint Kitts and Nevis", code: "KN"}, {name: "Saint Lucia", code: "LC"}, {name: "Saint Pierre and Miquelon", code: "PM"}, {name: "Saint Vincent and the Grenadines", code: "VC"}, {name: "Samoa", code: "WS"}, {name: "San Marino", code: "SM"}, {name: "Sao Tome and Principe", code: "ST"}, {name: "Saudi Arabia", code: "SA"}, {name: "Senegal", code: "SN"}, {name: "Serbia and Montenegro", code: "CS"}, {name: "Seychelles", code: "SC"}, {name: "Sierra Leone", code: "SL"}, {name: "Singapore", code: "SG"}, {name: "Slovakia", code: "SK"}, {name: "Slovenia", code: "SI"}, {name: "Solomon Islands", code: "SB"}, {name: "Somalia", code: "SO"}, {name: "South Africa", code: "ZA"}, {name: "South Georgia and the South Sandwich Islands", code: "GS"}, {name: "Spain", code: "ES"}, {name: "Sri Lanka", code: "LK"}, {name: "Sudan", code: "SD"}, {name: "Suriname", code: "SR"}, {name: "Svalbard and Jan Mayen", code: "SJ"}, {name: "Swaziland", code: "SZ"}, {name: "Sweden", code: "SE"}, {name: "Switzerland", code: "CH"}, {name: "Syrian Arab Republic", code: "SY"}, {name: "Taiwan", code: "TW"}, {name: "Tajikistan", code: "TJ"}, {name: "Tanzania, United Republic of", code: "TZ"}, {name: "Thailand", code: "TH"}, {name: "Timor-Leste", code: "TL"}, {name: "Togo", code: "TG"}, {name: "Tokelau", code: "TK"}, {name: "Tonga", code: "TO"}, {name: "Trinidad and Tobago", code: "TT"}, {name: "Tunisia", code: "TN"}, {name: "Turkey", code: "TR"}, {name: "Turkmenistan", code: "TM"}, {name: "Turks and Caicos Islands", code: "TC"}, {name: "Tuvalu", code: "TV"}, {name: "Uganda", code: "UG"}, {name: "Ukraine", code: "UA"}, {name: "United Arab Emirates", code: "AE"}, {name: "United Kingdom", code: "GB"}, {name: "United States", code: "US"}, {name: "United States Minor Outlying Islands", code: "UM"}, {name: "Uruguay", code: "UY"}, {name: "Uzbekistan", code: "UZ"}, {name: "Vanuatu", code: "VU"}, {name: "Venezuela", code: "VE"}, {name: "Viet Nam", code: "VN"}, {name: "Virgin Islands, British", code: "VG"}, {name: "Virgin Islands, U.S.", code: "VI"}, {name: "Wallis and Futuna", code: "WF"}, {name: "Western Sahara", code: "EH"}, {name: "Yemen", code: "YE"}, {name: "Zambia", code: "ZM"}, {name: "Zimbabwe", code: "ZW"} ];

Â function showToast(message, type = 'info') {
Â const toast = App.elements.toast;
Â if (!toast) return;
Â toast.textContent = message;
Â toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#0f172a';
Â toast.classList.add('show');
Â setTimeout(() => toast.classList.remove('show'), 3000);
Â }

Â function timeToMinutes(timeStr) {
Â if (!timeStr || !timeStr.includes(':')) return 0;
Â const [hours, minutes] = timeStr.split(':').map(Number);
Â return hours * 60 + minutes;
Â }

Â function getCountryFlagEmoji(countryCode) {
Â if (!countryCode || countryCode.length !== 2) return '';
Â const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
Â return String.fromCodePoint(...codePoints);
Â }

Â function getLocalTimeData() {
Â const now = new Date();
Â const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
Â const offsetMinutes = now.getTimezoneOffset() * -1;
Â const sign = offsetMinutes >= 0 ? '+' : '-';
Â const absOffset = Math.abs(offsetMinutes);
Â const hours = String(Math.floor(absOffset / 60)).padStart(2, '0');
Â const minutes = String(absOffset % 60).padStart(2, '0');
Â return { time: timeStr, offset: `UTC${sign}${hours}:${minutes}`, hour: now.getHours() };
Â }

Â function getFriendlyAuthError(errorCode) {
Â switch (errorCode) {
Â case 'auth/invalid-credential':
Â case 'auth/wrong-password':
Â return 'Invalid email or password. Please try again.';
Â case 'auth/email-already-in-use':
Â return 'An account with this email already exists.';
Â case 'auth/weak-password':
Â return 'Your password must be at least 6 characters long.';
Â default:
Â return 'An unexpected error occurred. Please try again.';
Â }
Â }

Â async function handleEmailSignup(e) {
Â e.preventDefault();
Â const name = document.getElementById('signup-name').value.trim();
Â const email = document.getElementById('signup-email').value.trim();
Â const password = document.getElementById('signup-password').value;
Â if (!name || !email || password.length < 6) { return; }
Â try {
Â  const result = await createUserWithEmailAndPassword(auth, email, password);
Â  await updateProfile(result.user, { displayName: name });
Â  await initializeNewUser(result.user, { displayName: name });
Â } catch (error) {
Â  document.getElementById('error-message').textContent = getFriendlyAuthError(error.code);
Â }
Â }

Â async function handleGoogleLogin() {
Â const provider = new GoogleAuthProvider();
Â try {
Â  Â  const result = await signInWithPopup(auth, provider);
Â  Â  await initializeNewUser(result.user);
Â } catch (error) {
Â  document.getElementById('error-message').textContent = getFriendlyAuthError(error.code);
Â }
Â }

Â async function handleEmailLogin(e) {
Â e.preventDefault();
Â const email = document.getElementById('login-email').value.trim();
Â const password = document.getElementById('login-password').value;
Â try {
Â  await signInWithEmailAndPassword(auth, email, password);
Â } catch (error) {
Â  document.getElementById('error-message').textContent = getFriendlyAuthError(error.code);
Â }
Â }

Â function handleLogout() {
Â signOut(auth);
Â }

Â onAuthStateChanged(auth, async (user) => {
Â  Â  const wasLoggedIn = !!App.currentUser;

Â  Â  if (user) {
Â  Â  Â  Â  await setupSession(user.uid);
Â  Â  Â  Â  App.currentUser = { email: user.email, displayName: user.displayName, userId: user.uid };
Â  Â  } else {
Â  Â  Â  Â  App.currentUser = null;
Â  Â  Â  Â  App.currentProfileData = null;
Â  Â  }

Â  Â  if (!isAuthResolved) {
Â  Â  Â  Â  isAuthResolved = true;
Â  Â  Â  Â  hashChangeRouter();
Â  Â  } else if (!!App.currentUser !== wasLoggedIn) {
Â  Â  Â  Â  hashChangeRouter();
Â  Â  }
Â });

Â async function initializeNewUser(user, additionalData = {}) {
Â const userRef = ref(db, `users/${user.uid}`);
Â const snapshot = await get(userRef);
Â if (!snapshot.exists()) {
Â const today = new Date().toISOString().split('T')[0];
Â const displayName = additionalData.displayName || user.displayName || "New User";
Â const defaultPfpText = displayName.charAt(0).toUpperCase();
Â const initialProfile = {Â 
Â displayName: displayName,Â 
Â email: user.email,Â 
Â createdAt: new Date().toISOString(),
Â status: 'ğŸŸ¢',Â 
Â message: 'Just getting started!',Â 
Â theme: 'auto',Â 
Â membershipTier: 'Member',
Â verified: false,
Â pfpText: defaultPfpText,
Â adsEnabled: false,
Â platformAdDisplay: 'both',
Â achievements: {Â 
Â profileComplete: 0, socialButterfly: 0, firstShare: 0,
Â views: 0, loyalUser: 1, expressive: 0, referral: 0, picturePerfect: 0,
Â loginHistory: { [today]: true },
Â usedEmojis: {}
Â },Â 
Â updatedAt: new Date().toISOString(),
Â ...additionalData
Â };
Â await set(userRef, initialProfile);

Â const referrerId = sessionStorage.getItem('referrerId');
Â if (referrerId && referrerId !== user.uid) {
Â const referrerRef = ref(db, `users/${referrerId}/achievements/referral`);
Â const referrerSnap = await get(referrerRef);
Â await set(referrerRef, (referrerSnap.val() || 0) + 1);
Â sessionStorage.removeItem('referrerId');
Â }
Â }
Â }
Â 
Â async function setupSession(userId) {
Â if (!userId) return;
Â 
Â const userRef = ref(db, `users/${userId}`);
Â const userSnap = await get(userRef);

Â if (userSnap.exists()) {
Â const data = userSnap.val();
Â data.userId = userId;Â 
Â App.currentProfileData = data;

Â const today = new Date().toISOString().split('T')[0];
Â const loginHistory = data.achievements?.loginHistory || {};
Â if (!loginHistory[today]) {
Â const updates = {};
Â updates[`achievements/loginHistory/${today}`] = true;
Â updates['achievements/loyalUser'] = Object.keys(loginHistory).length + 1;
Â await update(userRef, updates);
Â App.currentProfileData.achievements.loyalUser = updates['achievements/loyalUser'];
Â App.currentProfileData.achievements.loginHistory = {...loginHistory, [today]: true};
Â }

Â applyVisuals(data);
Â populateSettings(data);

Â document.querySelector('#mainHeader').innerHTML = `
Â <nav>
Â <button class="nav-btn" data-page="profilePage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 0 1-1.498.07 7.502 7.502 0 0 0-15 0 .75.75 0 0 1-1.498-.07A9.005 9.005 0 0 1 9 12.55a5.5 5.5 0 0 1 3-10.05ZM12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"></path></svg><span>Profile</span></button>
Â <button class="nav-btn" data-page="tiersPage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06l-1.72-1.72V7.5h-1.5V4.06L9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5V15a.75.75 0 0 0 1.5 0V7.5h3.75a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h3.75Z"></path></svg><span>Tiers</span></button>
Â <button class="nav-btn" data-page="searchPage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg><span>Search</span></button>
Â <button id="analytics-nav-btn" class="nav-btn" data-page="analyticsPage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 4.5a.75.75 0 0 0-1.5 0V7.5a.75.75 0 0 0 1.5 0V4.5ZM17.25 5.25a.75.75 0 0 0-1.5 0V9a.75.75 0 0 0 1.5 0V5.25ZM14.25 7.5a.75.75 0 0 0-1.5 0v10.5a.75.75 0 0 0 1.5 0V7.5ZM21 9a.75.75 0 0 0-1.5 0v7.5a.75.75 0 0 0 1.5 0V9ZM3.75 12a.75.75 0 0 0-1.5 0v4.5a.75.75 0 0 0 1.5 0V12Z"></path><path fill-rule="evenodd" d="M3 3a1.5 1.5 0 0 0-1.5 1.5V19.5A1.5 1.5 0 0 0 3 21h18a1.5 1.5 0 0 0 1.5-1.5V4.5A1.5 1.5 0 0 0 21 3H3ZM5.25 19.5h13.5V4.5H5.25v15Z" clip-rule="evenodd"></path></svg><span>Analytics</span></button>
Â <button class="nav-btn" data-page="settingsPage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.64 3.023a.75.75 0 0 1 .72 0l1.517.65a.75.75 0 0 0 .841-.252l1.11-1.48A.75.75 0 0 1 17 2.25a.75.75 0 0 1 .633.368l1.11 1.48a.75.75 0 0 0 .84.253l1.518-.65a.75.75 0 0 1 .72 0l1.016.436a.75.75 0 0 1 .45 1.033l-.74 1.385a.75.75 0 0 0 .14.925l1.28.96a.75.75 0 0 1 0 1.302l-1.28.96a.75.75 0 0 0-.14.925l.74 1.385a.75.75 0 0 1-.45 1.033l-1.017.436a.75.75 0 0 1-.72 0l-1.517-.65a.75.75 0 0 0-.84.252l-1.11 1.48A.75.75 0 0 1 17 21.75a.75.75 0 0 1-.633-.368l-1.11-1.48a.75.75 0 0 0-.84-.253l-1.518.65a.75.75 0 0 1-.72 0l-1.016-.436a.75.75 0 0 1-.45-1.033l.74-1.385a.75.75 0 0 0-.14-.925l-1.28-.96a.75.75 0 0 1 0-1.302l1.28.96a.75.75 0 0 0 .14-.925l-.74-1.385a.75.75 0 0 1 .45-1.033l1.017-.436ZM12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path></svg><span>Settings</span></button>
Â <button id="admin-nav-btn" class="nav-btn hidden" data-page="adminPage"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2.25a.75.75 0 0 0 0 1.5v16.5a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5V3.75a.75.75 0 0 0 0-1.5h-15ZM5.25 21a1.5 1.5 0 0 0 1.5-1.5V3.75A1.5 1.5 0 0 0 5.25 2.25h-1.5A3 3 0 0 0 .75 5.25v13.5A3 3 0 0 0 3.75 21h1.5Zm15-1.5V3.75A1.5 1.5 0 0 0 18.75 2.25h-1.5a.75.75 0 0 0 0 1.5h1.5c.414 0 .75.336.75.75v16.5c0 .414-.336.75-.75.75h-1.5a.75.75 0 0 0 0 1.5h1.5a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-1.5ZM8.25 7.5a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5Zm.75 3.75a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg><span>Admin</span></button>
Â </nav>
Â `;
Â document.querySelector('#admin-nav-btn').classList.toggle('hidden', data.membershipTier !== 'Owner');

Â } else {
Â console.error("User account exists but no profile in users/");
Â handleLogout();
Â }
Â }

Â async function displayPublicProfile(userId) {
Â try {
Â const userRef = ref(db, `users/${userId}`);
Â const snapshot = await get(userRef);
Â let userData = snapshot.val();
Â if (userData) {
Â userData.userId = userId;
Â applyVisuals(userData);Â 
Â renderProfile(userData);
Â if (!App.currentUser || App.currentUser.userId !== userId) {
Â trackProfileView(userId);
Â }
Â } else {
Â document.body.className = '';
Â document.getElementById('profile-name').textContent = 'User Not Found';
Â document.getElementById('profile-emoji').textContent = 'âŒ';
Â document.getElementById('profile-message').textContent = 'Profile is missing or deleted.';
Â }
Â } catch (error) {
Â document.getElementById('profile-name').textContent = 'Error loading profile.';
Â console.error("Error loading public profile:", error);
Â } finally {
Â  Â  hideLoadingOverlay();
Â }
Â }

Â async function saveAndLogStatus(data) {
Â  Â  const dataWithTimestamp = { ...data, updatedAt: new Date().toISOString() };
Â  Â  const userRef = ref(db, `users/${App.currentUser.userId}`);
Â  Â  if(data.displayName !== auth.currentUser.displayName) {
Â  Â  Â  Â  await updateProfile(auth.currentUser, { displayName: data.displayName });
Â  Â  Â  Â  if (!data.pfpUrl) dataWithTimestamp.pfpText = data.displayName.charAt(0).toUpperCase();
Â  Â  }

Â  Â  const achievements = App.currentProfileData.achievements || {};
Â  Â  const achievementUpdates = {};

Â  Â  const newEmoji = data.status;
Â  Â  const newUsedEmojis = achievements.usedEmojis || {};
Â  Â  if (!newUsedEmojis[newEmoji]) {
Â  Â  Â  Â  newUsedEmojis[newEmoji] = true;
Â  Â  Â  Â  achievementUpdates['achievements/usedEmojis'] = newUsedEmojis;
Â  Â  Â  Â  achievementUpdates['achievements/expressive'] = Object.keys(newUsedEmojis).length;
Â  Â  }

Â  Â  achievementUpdates['achievements/socialButterfly'] = data.links?.length || 0;
Â  Â  achievementUpdates['achievements/picturePerfect'] = data.pfpUrl ? 1 : (achievements.picturePerfect || 0);
Â  Â  const isBasicProfileComplete = data.bio && data.birthday && data.countryCode;
Â  Â  achievementUpdates['achievements/profileComplete'] = isBasicProfileComplete ? 1 : 0;
Â  Â Â 
Â  Â  await update(userRef, { ...dataWithTimestamp, ...achievementUpdates });

Â  Â  const historyRef = ref(db, `history/${App.currentUser.userId}`);
Â  Â  await push(historyRef, { status: data.status, message: data.message, timestamp: dataWithTimestamp.updatedAt });
Â  Â Â 
Â  Â  const updatedSnapshot = await get(userRef);
Â  Â  const oldTier = App.currentProfileData.membershipTier;
Â  Â  App.currentProfileData = { ...updatedSnapshot.val(), userId: App.currentUser.userId };
Â  Â  await updateMembershipTier(App.currentUser.userId, App.currentProfileData, oldTier);

Â  Â  const finalSnapshot = await get(userRef);
Â  Â  App.currentProfileData = { ...finalSnapshot.val(), userId: App.currentUser.userId };

Â  Â  applyVisuals(App.currentProfileData);
Â  Â  renderProfile(App.currentProfileData);
Â  Â  populateSettings(App.currentProfileData);

Â  Â  if (oldTier === App.currentProfileData.membershipTier) {
Â  Â  Â  Â  showToast('Settings Saved & Status Updated! ğŸ’¾');
Â  Â  }
Â }

Â function navigateTo(pageId, isInternal = true) {
Â if(isInternal) {
Â  Â  const cleanUrl = window.location.origin + window.location.pathname;
Â  Â  history.pushState({}, '', cleanUrl);
Â }
Â window.location.hash = pageId;
Â }

Â async function hashChangeRouter() {
Â  Â  clearInterval(countdownInterval);
Â  Â  if(publicViewInterval) clearInterval(publicViewInterval);

Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  const userIdFromUrl = params.get('user');

Â  Â  if (userIdFromUrl) {
Â  Â  Â  Â  isPublicView = true;
Â  Â  Â  Â  App.pages.forEach(pId => App.elements[pId]?.classList.remove('active'));
Â  Â  Â  Â  document.body.style.paddingBottom = "20px";
Â  Â  Â  Â  App.elements.mainHeader?.classList.add('hidden');
Â  Â  Â  Â  App.elements.profilePage?.classList.add('active');
Â  Â  Â  Â  await displayPublicProfile(userIdFromUrl);
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  isPublicView = false;
Â  Â  document.body.style.paddingBottom = "100px";

Â  Â  const hash = window.location.hash.substring(1);

Â  Â  let targetPageId = 'loginPage';Â 
Â  Â Â 
Â  Â  if (App.currentUser && App.currentProfileData) {
Â  Â  Â  Â  const userTier = App.currentProfileData.membershipTier || 'Member';
Â  Â  Â  Â  const tierConfig = USER_TIER_CONFIG[userTier];
Â  Â  Â  Â  const requestedPage = App.pages.includes(hash) ? hash : 'profilePage';

Â  Â  Â  Â  if (requestedPage === 'analyticsPage' && !tierConfig.analytics) {
Â  Â  Â  Â  Â  Â  targetPageId = 'profilePage';
Â  Â  Â  Â  Â  Â  showToast("Upgrade your tier to view analytics.", "error");
Â  Â  Â  Â  } else if (requestedPage === 'adminPage' && userTier !== 'Owner') {
Â  Â  Â  Â  Â  Â  targetPageId = 'profilePage';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  targetPageId = requestedPage;
Â  Â  Â  Â  }
Â  Â  } else if (!App.currentUser) {
Â  Â  Â  Â  if (hash === 'searchPage') {
Â  Â  Â  Â  Â  Â  targetPageId = 'searchPage';
Â  Â  Â  Â  } else if (hash) {
Â  Â  Â  Â  Â  Â  sessionStorage.setItem('redirectAfterLogin', hash);
Â  Â  Â  Â  Â  Â  targetPageId = 'loginPage';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (App.currentUser) {
Â  Â  Â  Â  if(targetPageId === 'profilePage') {
Â  Â  Â  Â  Â  Â  renderProfile(App.currentProfileData);
Â  Â  Â  Â  } else if (targetPageId === 'analyticsPage') {
Â  Â  Â  Â  Â  Â  await fetchAndRenderAnalytics();
Â  Â  Â  Â  } else if (targetPageId === 'tiersPage') {
Â  Â  Â  Â  Â  Â  renderTiersPage();
Â  Â  Â  Â  } else if (targetPageId === 'adminPage') {
Â  Â  Â  Â  Â  Â  renderAdminPanel();
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if (targetPageId === 'searchPage') {
Â  Â  Â  Â  document.getElementById('search-results-list').innerHTML = '<p class="muted">Search for users by name or click \'Search\' to view all public profiles.</p>';
Â  Â  }
Â  Â Â 
Â  Â  App.pages.forEach(pId => App.elements[pId]?.classList.toggle('active', pId === targetPageId));
Â  Â  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === targetPageId));
Â  Â  App.elements.mainHeader?.classList.toggle('hidden', !App.currentUser || targetPageId === 'loginPage');
Â  Â  window.scrollTo(0, 0);
Â  Â  hideLoadingOverlay();
Â }

Â function applyVisuals(userData) {
Â  Â  if (!userData) return;
Â  Â  const theme = userData.theme || 'auto';
Â  Â  const timeData = getLocalTimeData();
Â  Â  const isNight = timeData.hour >= 20 || timeData.hour < 6;
Â  Â  document.body.className = (theme === 'dark' || (theme === 'auto' && isNight)) ? 'dark' : '';

Â  Â  const accent = userData?.profileAccentColor || '#0ea5e9';
Â  Â  document.documentElement.style.setProperty('--primary', accent);
Â  Â  document.documentElement.style.setProperty('--primary-dark', document.body.classList.contains('dark') ? '#7dd3fc' : '#0369a1');
Â  Â  document.documentElement.style.setProperty('--link-text-color', userData?.linkTextColor || '#0369a1');
Â  Â  document.documentElement.style.setProperty('--display-font', userData?.displayNameFont || 'Inter, sans-serif');

Â  Â  const pfpElement = document.getElementById('profile-pfp');
Â  Â  if (pfpElement) {
Â  Â  Â  Â  const tierConfig = USER_TIER_CONFIG[userData.membershipTier || 'Member'];
Â  Â  Â  Â  pfpElement.style.backgroundImage = 'none'; // Clear existing
Â  Â  Â  Â  if (tierConfig.pfp && userData.pfpUrl) {
Â  Â  Â  Â  Â  Â  pfpElement.setAttribute('data-src', userData.pfpUrl);
Â  Â  Â  Â  Â  Â  pfpElement.textContent = '';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  pfpElement.removeAttribute('data-src');
Â  Â  Â  Â  Â  Â  pfpElement.textContent = userData.pfpText || userData.displayName.charAt(0).toUpperCase();
Â  Â  Â  Â  }
Â  Â  Â  Â  pfpElement.style.backgroundColor = isNight ? '#1e293b' : 'var(--primary-light)';
Â  Â  Â  Â  pfpElement.style.borderColor = accent;
Â  Â  }
Â }

Â function renderProfile(data) {
Â  Â  if (!data) return;
Â  Â Â 
Â  Â  const isOwnerViewing = App.currentUser && App.currentUser.userId === data.userId;

Â  Â  document.getElementById('share-profile-card').classList.remove('hidden');

Â  Â  const profileNameEl = document.getElementById('profile-name');
Â  Â  const membershipContainer = document.getElementById('membership-tier-display-container');
Â  Â  const name = data.displayName || 'Unnamed User';
Â  Â  profileNameEl.innerHTML = name;
Â  Â  const userVerifiedIcon = `<svg class="inline-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.06-1.06l-3.103 3.103-1.53-1.53a.75.75 0 0 0-1.06 1.06l2.06 2.06a.75.75 0 0 0 1.06 0l3.64-3.64Z" clip-rule="evenodd" /></svg>`;
Â  Â  if (data.verified) profileNameEl.innerHTML += userVerifiedIcon;
Â  Â  const tier = data.membershipTier || 'Member';
Â  Â  const tierConfig = USER_TIER_CONFIG[tier];
Â  Â  profileNameEl.classList.toggle('is-owner', tier === 'Owner');
Â  Â  membershipContainer.innerHTML = `<div class="membership-badge tier-${tier}">${tierConfig.name || tier}</div>`;
Â  Â  document.getElementById('profile-emoji').textContent = data.status || 'â“';
Â  Â  document.getElementById('profile-message').textContent = data.message || 'No message set.';
Â  Â  renderPersonalDetails(data);
Â  Â  const timeData = getLocalTimeData();
Â  Â  document.getElementById('local-time-info').textContent = `Local Time: ${timeData.time} (${timeData.offset})`;
Â  Â  renderCustomLinks(data.links, document.getElementById('profile-links'), tierConfig);
Â  Â  renderActionLinks(data);

Â  Â  const qrBtn = document.getElementById('generate-qrcode-btn');
Â  Â  if (isOwnerViewing) {
Â  Â  Â  Â  if(tierConfig.qrCode) {
Â  Â  Â  Â  Â  Â  qrBtn.disabled = false;
Â  Â  Â  Â  Â  Â  qrBtn.textContent = "Generate QR Code";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  qrBtn.disabled = true;
Â  Â  Â  Â  Â  Â  qrBtn.textContent = "Upgrade to Personal for QR Code";
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  qrBtn.disabled = true;
Â  Â  Â  Â  qrBtn.textContent = tierConfig.qrCode ? "QR Code (Owner Only)" : "QR Code (Unavailable)";
Â  Â  }


Â  Â  const topAdContainer = document.getElementById('top-ad-container');
Â  Â  const bottomAdContainer = document.getElementById('bottom-ad-container');
Â  Â  topAdContainer.innerHTML = ''; topAdContainer.classList.add('hidden');
Â  Â  bottomAdContainer.innerHTML = ''; bottomAdContainer.classList.add('hidden');

Â  Â  if (tierConfig.canCustomizeAds && data.adsEnabled) {
Â  Â  Â  Â  if (data.topAd?.imageUrl && data.topAd?.linkUrl) {
Â  Â  Â  Â  Â  Â  topAdContainer.innerHTML = `<a href="${data.topAd.linkUrl}" target="_blank" rel="noopener noreferrer nofollow"><img src="${data.topAd.imageUrl}" loading="lazy" alt="Promotional Banner"></a>`;
Â  Â  Â  Â  Â  Â  topAdContainer.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  Â  if (data.bottomAd?.text && data.bottomAd?.linkUrl) {
Â  Â  Â  Â  Â  Â  bottomAdContainer.innerHTML = `<a href="${data.bottomAd.linkUrl}" target="_blank" rel="noopener noreferrer nofollow">${data.bottomAd.text}</a>`;
Â  Â  Â  Â  Â  Â  bottomAdContainer.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  const promoTop = document.getElementById('create-hap-promo-top');
Â  Â  const promoBottom = document.getElementById('create-hap-promo-bottom');
Â  Â  promoTop.innerHTML = ''; promoTop.classList.add('hidden');
Â  Â  promoBottom.innerHTML = ''; promoBottom.classList.add('hidden');

Â  Â  const topPromoHTML = isOwnerViewing
Â  Â  Â  Â  ? `<div><h3>Like this status page?</h3><p>Example ad shown to visitors.</p></div><p style="font-style: italic; margin:0;">Preview</p>`
Â  Â  Â  Â  : `<div><h3>Like this status page?</h3><p>Create your own in seconds!</p></div><button class="btn" id="promo-action-btn-top">Get Started</button>`;

Â  Â  const bottomPromoHTML = isOwnerViewing
Â  Â  Â  Â  ? `<h3 style="text-align: center;">Platform Promotion Preview</h3><p style="text-align: center;">This is an example of the ad visitors will see at the bottom of your profile.</p>`
Â  Â  Â  Â  : `<h3 style="text-align: center;">Like this status page?</h3><p style="text-align: center;">Create your own real-time availability profile in seconds!</p><div style="display: flex; justify-content: center; margin-top: 15px;"><button class="btn" id="promo-action-btn-bottom" style="flex: 0 1 250px;">Get Started Now</button></div>`;

Â  Â  let platformAdPosition = 'off';
Â  Â  if(tier === 'Member') {
Â  Â  Â  Â  platformAdPosition = 'both';
Â  Â  } else if (tier === 'Plus' || tier === 'Pro') {
Â  Â  Â  Â  platformAdPosition = 'bottom';
Â  Â  } else if (tierConfig.canControlPlatformAd) {
Â  Â  Â  Â  platformAdPosition = data.platformAdDisplay || 'off';
Â  Â  }
Â  Â Â 
Â  Â  if (platformAdPosition === 'top' || platformAdPosition === 'both') {
Â  Â  Â  Â  promoTop.innerHTML = topPromoHTML;
Â  Â  Â  Â  promoTop.classList.remove('hidden');
Â  Â  Â  Â  if (!isOwnerViewing) {
Â  Â  Â  Â  Â  Â  const btn = promoTop.querySelector('#promo-action-btn-top');
Â  Â  Â  Â  Â  Â  if(btn) btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const cleanUrl = window.location.origin + window.location.pathname;
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = cleanUrl;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  }
Â  Â  if (platformAdPosition === 'bottom' || platformAdPosition === 'both') {
Â  Â  Â  Â  promoBottom.innerHTML = bottomPromoHTML;
Â  Â  Â  Â  promoBottom.classList.remove('hidden');
Â  Â  Â  Â  if (!isOwnerViewing) {
Â  Â  Â  Â  Â  Â  const btn = promoBottom.querySelector('#promo-action-btn-bottom');
Â  Â  Â  Â  Â  Â  if(btn) btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const cleanUrl = window.location.origin + window.location.pathname;
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = cleanUrl;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  }
Â }

Â function renderPersonalDetails(data) {
Â const container = document.getElementById('personal-details-list');
Â if (!container) return;
Â let detailsHtml = '';
Â const addDetail = (label, value) => {
Â if (value) detailsHtml += `<div class="personal-detail-item"><strong>${label}:</strong> ${value}</div>`;
Â };

Â if (data.countryCode) {
Â const country = COUNTRY_LIST.find(c => c.code === data.countryCode);
Â if (country) {
Â detailsHtml += `<div class="personal-detail-item profile-country"><span class="flag-emoji">${getCountryFlagEmoji(country.code)}</span> ${country.name}</div>`;
Â }
Â }
Â addDetail('Bio', data.bio);

Â const isOwnerViewing = App.currentUser && App.currentUser.userId === data.userId;
Â if (!isPublicView || isOwnerViewing) {
Â addDetail('Phone', data.phone ? `<a href="tel:${data.phone}">${data.phone}</a>` : null);
Â addDetail('Email', data.email ? `<a href="mailto:${data.email}">${data.email}</a>` : null);
Â }
Â container.innerHTML = detailsHtml || '<p class="muted">No public details shared.</p>';
Â }

Â function renderCustomLinks(links, container, tierConfig) {
Â if (!container || !tierConfig) return;
Â container.innerHTML = '';
Â const validLinks = links ? links.filter(l => l && l.url && l.label) : [];
Â if (validLinks.length === 0) {
Â container.innerHTML = '<p class="muted">No links provided.</p>';
Â return;
Â }
Â let html = '';
Â validLinks.slice(0, tierConfig.linkLimit).forEach(link => {
Â html += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="custom-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg><span>${link.label}</span></a>`;
Â });
Â container.innerHTML = html;
Â }

Â function renderActionLinks(data) {
Â const container = document.getElementById('profile-action-links');
Â if (!container) return;
Â container.innerHTML = '';
Â let html = '';
Â if (data.schedulingLink) html += `<a href="${data.schedulingLink}" target="_blank" rel="noopener noreferrer" class="btn secondary" style="max-width: 250px;">Book a Meeting</a>`;
Â container.innerHTML = html;
Â }

Â function populateSettings(data) {
Â  Â  if (!data || !document.getElementById('display-name')) return;
Â  Â  const tier = data.membershipTier || 'Member';
Â  Â  const tierConfig = USER_TIER_CONFIG[tier] || USER_TIER_CONFIG['Member'];

Â  Â  document.getElementById('display-name').value = data.displayName || '';
Â  Â  document.getElementById('themeSelect').value = data.theme || 'auto';
Â  Â  document.getElementById('pfp-url').value = data.pfpUrl || '';
Â  Â  document.getElementById('display-font').value = data.displayNameFont || 'Inter, sans-serif';
Â  Â  document.getElementById('accent-color').value = data.profileAccentColor || '#0ea5e9';
Â  Â  document.getElementById('link-text-color').value = data.linkTextColor || '#0369a1';
Â  Â  document.getElementById('scheduling-link').value = data.schedulingLink || '';
Â  Â  document.getElementById('bio').value = data.bio || '';
Â  Â  document.getElementById('birthday').value = data.birthday || '';
Â  Â  document.getElementById('phone-number').value = data.phone || '';
Â  Â Â 
Â  Â  const countrySearch = document.getElementById('country-search'), countryCodeInput = document.getElementById('country-code');
Â  Â  if(data.countryCode) {
Â  Â  Â  Â  const country = COUNTRY_LIST.find(c => c.code === data.countryCode);
Â  Â  Â  Â  if (country) { countrySearch.value = `${getCountryFlagEmoji(country.code)} ${country.name}`; countryCodeInput.value = country.code; }
Â  Â  } else { countrySearch.value = ''; countryCodeInput.value = ''; }

Â  Â  document.getElementById('pfp-url-group').classList.toggle('hidden', !tierConfig.pfp);
Â  Â  document.getElementById('font-customization-field').classList.toggle('hidden', !tierConfig.customFont);
Â  Â  document.getElementById('scheduling-link-field').classList.toggle('hidden', !tierConfig.scheduling);
Â  Â  document.getElementById('accent-color-field').classList.toggle('hidden', !tierConfig.customColor);
Â  Â  document.getElementById('link-text-color-field').classList.toggle('hidden', !tierConfig.customColor);
Â  Â Â 
Â  Â  const linksContainer = document.getElementById('custom-links-container');
Â  Â  linksContainer.innerHTML = '';
Â  Â  const linkLimit = tierConfig.linkLimit;
Â  Â  for (let i = 0; i < linkLimit; i++) {
Â  Â  Â  Â  const link = data.links ? data.links[i] : null;
Â  Â  Â  Â  linksContainer.innerHTML += `<div class="link-group"><input type="text" id="link-label-${i}" placeholder="Link Label ${i + 1}" value="${link?.label || ''}"><input type="url" id="link-url-${i}" placeholder="URL (https://...)" value="${link?.url || ''}"></div>`;
Â  Â  }
Â  Â  if (tier !== 'Max' && tier !== 'Owner') {
Â  Â  Â  Â  linksContainer.innerHTML += `<p class="muted">Upgrade your tier to add more links!</p>`;
Â  Â  }

Â  Â  document.getElementById('status-emoji').value = data.status || 'ğŸŸ¢';
Â  Â  document.getElementById('status-message').value = data.message || '';
Â  Â  renderVerificationSettings(data);

Â  Â  const customAdCard = document.getElementById('custom-ads-settings-card');
Â  Â  customAdCard.classList.toggle('hidden', !tierConfig.canCustomizeAds);
Â  Â  if (tierConfig.canCustomizeAds) {
Â  Â  Â  Â  const adToggle = document.getElementById('ads-enabled-toggle');
Â  Â  Â  Â  const adFields = document.getElementById('ad-customization-fields');
Â  Â  Â  Â  adToggle.value = data.adsEnabled ? 'true' : 'false';
Â  Â  Â  Â  adFields.classList.toggle('hidden', !data.adsEnabled);
Â  Â  Â  Â  document.getElementById('top-ad-image-url').value = data.topAd?.imageUrl || '';
Â  Â  Â  Â  document.getElementById('top-ad-link-url').value = data.topAd?.linkUrl || '';
Â  Â  Â  Â  document.getElementById('bottom-ad-text').value = data.bottomAd?.text || '';
Â  Â  Â  Â  document.getElementById('bottom-ad-link-url').value = data.bottomAd?.linkUrl || '';
Â  Â  Â  Â  adToggle.onchange = () => adFields.classList.toggle('hidden', adToggle.value !== 'true');
Â  Â  }

Â  Â  const platformAdCard = document.getElementById('platform-ad-settings-card');
Â  Â  platformAdCard.classList.toggle('hidden', !tierConfig.canControlPlatformAd);
Â  Â  if(tierConfig.canControlPlatformAd) {
Â  Â  Â  Â  document.getElementById('platform-ad-toggle').value = data.platformAdDisplay || 'off';
Â  Â  }
Â }

Â function handlePageLoad() {
Â  Â  App.pages.forEach(pId => App.elements[pId] = document.getElementById(pId));
Â  Â  App.elements.mainHeader = document.getElementById('mainHeader');
Â  Â  App.elements.toast = document.getElementById('toast');
Â  Â  window.addEventListener('hashchange', hashChangeRouter);
Â  Â  addEventListeners();
Â  Â Â 
Â  Â  // Setup lazy loading for background images
Â  Â  const lazyImageObserver = new IntersectionObserver((entries, observer) => {
Â  Â  Â  Â  entries.forEach(entry => {
Â  Â  Â  Â  Â  Â  if (entry.isIntersecting) {
Â  Â  Â  Â  Â  Â  Â  Â  const lazyImage = entry.target;
Â  Â  Â  Â  Â  Â  Â  Â  const src = lazyImage.getAttribute('data-src');
Â  Â  Â  Â  Â  Â  Â  Â  if (src) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lazyImage.style.backgroundImage = `url(${src})`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  observer.unobserve(lazyImage);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });
Â  Â  const pfpElement = document.getElementById('profile-pfp');
Â  Â  if(pfpElement) lazyImageObserver.observe(pfpElement);
}

Â async function handleDeleteAccount() {
Â if (!App.currentUser) return;
Â const confirmation = confirm("Are you sure you want to permanently delete your account and all associated data? This action cannot be undone.");
Â if (!confirmation) return showToast("Account deletion cancelled.");

Â const accountId = App.currentUser.userId;
Â const account = auth.currentUser;
Â if (!account) return showToast("Error: No authenticated user found.", "error");

Â try {
Â await set(ref(db, `users/${accountId}`), null);
Â await set(ref(db, `history/${accountId}`), null);
Â await set(ref(db, `analytics/${accountId}`), null);
Â await deleteUser(account);
Â showToast("Account successfully deleted. ğŸ‘‹");
Â } catch (error) {
Â console.error("Account Deletion Error:", error);
Â if (error.code === 'auth/requires-recent-login') {
Â showToast("Security Alert: Please log in again to confirm this action.", "error");
Â handleLogout();Â 
Â } else {
Â showToast(`Deletion failed: ${error.message}`, "error");
Â }
Â }
Â }

Â async function handleSaveSettings() {
Â  Â  if (!App.currentUser) return;
Â  Â  const saveBtn = document.getElementById('save-settings-btn');
Â  Â  saveBtn.textContent = 'Saving...';
Â  Â  saveBtn.classList.add('btn-loading');

Â  Â  const tier = App.currentProfileData.membershipTier || 'Member';
Â  Â  const tierConfig = USER_TIER_CONFIG[tier];
Â  Â  const linkLimit = tierConfig.linkLimit || 1;
Â  Â  const customLinks = [];
Â  Â  for (let i = 0; i < linkLimit; i++) {
Â  Â  Â  Â  const label = document.getElementById(`link-label-${i}`)?.value.trim();
Â  Â  Â  Â  const url = document.getElementById(`link-url-${i}`)?.value.trim();
Â  Â  Â  Â  if (label && url) { customLinks.push({ label, url }); }
Â  Â  }

Â  Â  const dataToSave = {
Â  Â  Â  Â  displayName: document.getElementById('display-name').value,Â 
Â  Â  Â  Â  theme: document.getElementById('themeSelect').value,
Â  Â  Â  Â  pfpUrl: document.getElementById('pfp-url').value,
Â  Â  Â  Â  displayNameFont: document.getElementById('display-font').value,
Â  Â  Â  Â  profileAccentColor: document.getElementById('accent-color').value,Â 
Â  Â  Â  Â  linkTextColor: document.getElementById('link-text-color').value,
Â  Â  Â  Â  schedulingLink: document.getElementById('scheduling-link').value,Â 
Â  Â  Â  Â  bio: document.getElementById('bio').value,
Â  Â  Â  Â  birthday: document.getElementById('birthday').value,
Â  Â  Â  Â  countryCode: document.getElementById('country-code').value,
Â  Â  Â  Â  phone: document.getElementById('phone-number').value,
Â  Â  Â  Â  status: document.getElementById('status-emoji').value,
Â  Â  Â  Â  message: document.getElementById('status-message').value,
Â  Â  Â  Â  links: customLinks
Â  Â  };
Â  Â  if(!dataToSave.pfpUrl) dataToSave.pfpText = App.currentProfileData.displayName.charAt(0).toUpperCase();

Â  Â  if (tierConfig.canCustomizeAds) {
Â  Â  Â  Â  dataToSave.adsEnabled = document.getElementById('ads-enabled-toggle').value === 'true';
Â  Â  Â  Â  dataToSave.topAd = {
Â  Â  Â  Â  Â  Â  imageUrl: document.getElementById('top-ad-image-url').value.trim(),
Â  Â  Â  Â  Â  Â  linkUrl: document.getElementById('top-ad-link-url').value.trim()
Â  Â  Â  Â  };
Â  Â  Â  Â  dataToSave.bottomAd = {
Â  Â  Â  Â  Â  Â  text: document.getElementById('bottom-ad-text').value.trim(),
Â  Â  Â  Â  Â  Â  linkUrl: document.getElementById('bottom-ad-link-url').value.trim()
Â  Â  Â  Â  };
Â  Â  }
Â  Â Â 
Â  Â  if(tierConfig.canControlPlatformAd) {
Â  Â  Â  Â  dataToSave.platformAdDisplay = document.getElementById('platform-ad-toggle').value;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  await saveAndLogStatus(dataToSave);Â 
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Save settings error:", error);
Â  Â  Â  Â  showToast("Failed to save settings.", "error");
Â  Â  } finally {
Â  Â  Â  Â  saveBtn.textContent = 'Save All Changes';
Â  Â  Â  Â  saveBtn.classList.remove('btn-loading');
Â  Â  }
Â }

Â function handleGenerateQrCode() {
Â  Â  const profileId = isPublicView ? new URLSearchParams(window.location.search).get('user') : App.currentUser.userId;
Â  Â  if (!profileId) return;

Â  Â  const img = document.getElementById('profile-qrcode-img'), placeholder = document.getElementById('qrcode-placeholder');
Â  Â  const shareUrl = `${window.location.origin}${window.location.pathname}?user=${profileId}`;
Â  Â  img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;
Â  Â  img.onload = () => { img.style.display = 'block'; placeholder.classList.add('hidden'); showToast('QR Code generated! ğŸ–¼ï¸'); };
Â }

Â function handleShareStatus() {
Â  Â  const profileId = isPublicView ? new URLSearchParams(window.location.search).get('user') : App.currentUser.userId;
Â  Â  if (!profileId) return;
Â  Â Â 
Â  Â  const shareUrl = `${window.location.origin}${window.location.pathname}?user=${profileId}&ref=${profileId}`;
Â  Â  navigator.clipboard.writeText(shareUrl).then(() => {
Â  Â  Â  Â  showToast('Profile link copied to clipboard! ğŸ”—');
Â  Â  Â  Â  if (App.currentUser && App.currentUser.userId === profileId && !App.currentProfileData.achievements.firstShare) {
Â  Â  Â  Â  Â  Â  update(ref(db, `users/${profileId}/achievements`), { firstShare: 1 });
Â  Â  Â  Â  }
Â  Â  });
Â }

Â async function fetchAndRenderAnalytics() {
Â  Â  if (!App.currentUser) return;
Â  Â  const userId = App.currentUser.userId;
Â  Â  const userTier = App.currentProfileData.membershipTier || 'Member';

Â  Â  // --- Render History (Available to all tiers with analytics access) ---
Â  Â  const historyLog = document.getElementById('history-log');
Â  Â  historyLog.innerHTML = '<p class="muted">Loading history...</p>';
Â  Â  try {
Â  Â  Â  Â  const historyQuery = query(ref(db, `history/${userId}`), orderByKey(), limitToLast(10));
Â  Â  Â  Â  const snapshot = await get(historyQuery);
Â  Â  Â  Â  const historyData = snapshot.val();
Â  Â  Â  Â  if (historyData) {
Â  Â  Â  Â  Â  Â  historyLog.innerHTML = Object.values(historyData)
Â  Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
Â  Â  Â  Â  Â  Â  Â  Â  .map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(item.timestamp);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="history-item"><span class="history-status">${item.status} ${item.message || ''}</span><span class="history-time">${date.toLocaleTimeString()} - ${date.toLocaleDateString()}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  historyLog.innerHTML = '<p class="muted">No status history found.</p>';
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  historyLog.innerHTML = '<p class="muted">Error loading history.</p>';
Â  Â  Â  Â  console.error("History fetch error:", error);
Â  Â  }

Â  Â  // --- Render Core Metrics ---
Â  Â  document.getElementById('views-total').textContent = App.currentProfileData.achievements?.views || 0;

Â  Â  if (userTier === 'Member') {
Â  Â  Â  Â  document.getElementById('views-unique').textContent = 'ğŸ”’';
Â  Â  Â  Â  document.getElementById('views-today').textContent = 'ğŸ”’';
Â  Â  Â  Â  document.getElementById('views-week').textContent = 'ğŸ”’';
Â  Â  Â  Â  document.getElementById('analytics-chart-card').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('analytics-country-card').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('analytics-upgrade-prompt').classList.remove('hidden');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // --- Render Advanced Metrics (Plus tier and above) ---
Â  Â  document.getElementById('analytics-chart-card').classList.remove('hidden');
Â  Â  document.getElementById('analytics-country-card').classList.remove('hidden');
Â  Â  document.getElementById('analytics-upgrade-prompt').classList.add('hidden');

Â  Â  try {
Â  Â  Â  Â  const analyticsSnap = await get(ref(db, `analytics/${userId}`));
Â  Â  Â  Â  const analyticsData = analyticsSnap.val() || {};
Â  Â  Â  Â  const dailyViews = analyticsData.viewsByDay || {};
Â  Â  Â  Â  const countryViews = analyticsData.viewsByCountry || {};
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Calculate date-based and unique metrics
Â  Â  Â  Â  let todayViews = 0, weekViews = 0;
Â  Â  Â  Â  const uniqueVisitors = new Set();
Â  Â  Â  Â  const weeklyTrendData = Array(7).fill(0);
Â  Â  Â  Â  const today = new Date();

Â  Â  Â  Â  for (let i = 0; i < 30; i++) {
Â  Â  Â  Â  Â  Â  const date = new Date(today);
Â  Â  Â  Â  Â  Â  date.setDate(today.getDate() - i);
Â  Â  Â  Â  Â  Â  const dateString = date.toISOString().split('T')[0];
Â  Â  Â  Â  Â  Â  const dayData = dailyViews[dateString];

Â  Â  Â  Â  Â  Â  if (dayData) {
Â  Â  Â  Â  Â  Â  Â  Â  const dailyVisitorIds = Object.keys(dayData);
Â  Â  Â  Â  Â  Â  Â  Â  const viewCount = dailyVisitorIds.length;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) todayViews = viewCount;
Â  Â  Â  Â  Â  Â  Â  Â  if (i < 7) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weekViews += viewCount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weeklyTrendData[6 - i] = viewCount;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  dailyVisitorIds.forEach(id => uniqueVisitors.add(id));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('views-today').textContent = todayViews;
Â  Â  Â  Â  document.getElementById('views-week').textContent = weekViews;
Â  Â  Â  Â  document.getElementById('views-unique').textContent = uniqueVisitors.size;

Â  Â  Â  Â  // Render Country Stats
Â  Â  Â  Â  const countryListEl = document.getElementById('country-stats-list');
Â  Â  Â  Â  const sortedCountries = Object.entries(countryViews).sort((a, b) => b[1] - a[1]);
Â  Â  Â  Â  if (sortedCountries.length > 0) {
Â  Â  Â  Â  Â  Â  countryListEl.innerHTML = sortedCountries.map(([code, count]) => {
Â  Â  Â  Â  Â  Â  Â  Â  const countryName = COUNTRY_LIST.find(c => c.code === code)?.name || 'Unknown';
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="country-stat-item"><span>${getCountryFlagEmoji(code)} ${countryName}</span> <strong>${count}</strong></div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  countryListEl.innerHTML = '<p class="muted">No country data available yet.</p>';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Render 7-Day Trend Chart
Â  Â  Â  Â  const chartContainer = document.getElementById('views-chart-container');
Â  Â  Â  Â  const maxView = Math.max(...weeklyTrendData, 1); // Avoid division by zero
Â  Â  Â  Â  chartContainer.innerHTML = weeklyTrendData.map((count, i) => {
Â  Â  Â  Â  Â  Â  const date = new Date();
Â  Â  Â  Â  Â  Â  date.setDate(today.getDate() - (6 - i));
Â  Â  Â  Â  Â  Â  const dayInitial = date.toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
Â  Â  Â  Â  Â  Â  const heightPercent = (count / maxView) * 100;
Â  Â  Â  Â  Â  Â  return `<div class="chart-bar-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value" style="font-size: 1rem; height: 20px;">${count}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-bar" style="height: ${heightPercent}%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-label">${dayInitial}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }).join('');

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error("Error fetching advanced analytics:", e);
Â  Â  Â  Â  showToast("Could not load detailed analytics.", "error");
Â  Â  }
}

Â async function handleSearchUsers() {
Â const queryText = document.getElementById('user-search-input').value.toLowerCase().trim();
Â const resultsList = document.getElementById('search-results-list');
Â resultsList.innerHTML = '<p class="muted">Searching...</p>';
Â try {
Â const usersSnap = await get(ref(db, 'users'));
Â const allUsers = usersSnap.val() || {};
Â let results = [];
Â for (const userId in allUsers) {
Â const user = allUsers[userId];
Â if (user.displayName && (!queryText || user.displayName.toLowerCase().includes(queryText))) {
Â results.push({ id: userId, ...user });
Â }
Â }
Â 
Â const rank = { 'Owner': 0, 'Max': 1, 'Pro': 2, 'Plus': 3, 'Member': 4 };
Â results.sort((a, b) => {
Â const prioA = (a.membershipTier === 'Owner' ? -1 : rank[a.membershipTier]);
Â const prioB = (b.membershipTier === 'Owner' ? -1 : rank[b.membershipTier]);
Â if (prioA !== prioB) return prioA - prioB;
Â return a.displayName.localeCompare(b.displayName);
Â });

Â if (results.length > 0) {
Â resultsList.innerHTML = results.map(item => {
Â const userVerifiedIcon = `<svg class="inline-verified-icon" style="width:20px; height:20px;" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.06-1.06l-3.103 3.103-1.53-1.53a.75.75 0 0 0-1.06 1.06l2.06 2.06a.75.75 0 0 0 1.06 0l3.64-3.64Z" clip-rule="evenodd" /></svg>`;
Â const tierName = item.membershipTier || 'Member';
Â const tierClass = tierName;
Â const verifiedTick = item.verified ? userVerifiedIcon : '';
Â return `<div class="search-result-item"><div><div style="display: flex; align-items: center;"><strong style="font-size: 1.1rem;">${item.displayName}</strong>${verifiedTick}</div><div style="display:flex; gap: 8px; margin-top: 4px;"><div class="membership-badge tier-${tierClass}" style="font-size: 0.7rem; padding: 2px 8px;">${USER_TIER_CONFIG[tierName]?.name || tierName}</div><span style="font-size: 0.9rem; color: var(--muted);">${item.status} ${item.message || ''}</span></div></div><a href="?user=${item.id}" class="btn secondary" style="padding: 8px 12px; width: auto; font-size: 0.9rem;">View</a></div>`;
Â }).join('');
Â } else { resultsList.innerHTML = '<p class="muted">No results found.</p>'; }
Â } catch(e) {Â 
Â resultsList.innerHTML = '<p class="muted">Error performing search.</p>';Â 
Â console.error(e);
Â }
Â }

Â async function trackProfileView(profileId) {
Â  Â  try {
Â  Â  Â  Â  let visitorId = localStorage.getItem('hapVisitorId');
Â  Â  Â  Â  if (!visitorId) {
Â  Â  Â  Â  Â  Â  visitorId = 'visitor_' + Date.now() + Math.random().toString(36).substring(2, 15);
Â  Â  Â  Â  Â  Â  localStorage.setItem('hapVisitorId', visitorId);
Â  Â  Â  Â  }

Â  Â  Â  Â  const today = new Date().toISOString().split('T')[0];
Â  Â  Â  Â  const viewRef = ref(db, `analytics/${profileId}/viewsByDay/${today}/${visitorId}`);
Â  Â  Â  Â  const snapshot = await get(viewRef);

Â  Â  Â  Â  if (!snapshot.exists()) {
Â  Â  Â  Â  Â  Â  // Set the daily view marker
Â  Â  Â  Â  Â  Â  await set(viewRef, true);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Increment total views
Â  Â  Â  Â  Â  Â  const totalViewsRef = ref(db, `users/${profileId}/achievements/views`);
Â  Â  Â  Â  Â  Â  const totalViewsSnap = await get(totalViewsRef);
Â  Â  Â  Â  Â  Â  await set(totalViewsRef, (totalViewsSnap.val() || 0) + 1);

Â  Â  Â  Â  Â  Â  // Fetch country and increment country-specific view count
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const geoResponse = await fetch('https://ipapi.co/json/');
Â  Â  Â  Â  Â  Â  Â  Â  if (geoResponse.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const geoData = await geoResponse.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const countryCode = geoData.country_code || 'XX';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const countryRef = ref(db, `analytics/${profileId}/viewsByCountry/${countryCode}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const countrySnap = await get(countryRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await set(countryRef, (countrySnap.val() || 0) + 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (geoError) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Could not fetch geolocation data:", geoError);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Failed to track profile view:", error);
Â  Â  }
}

Â function filterCountries(inputId, dropdownId) {
Â const searchTerm = document.getElementById(inputId).value.toLowerCase();
Â const dropdown = document.getElementById(dropdownId);
Â dropdown.innerHTML = '';
Â COUNTRY_LIST.filter(c => c.name.toLowerCase().includes(searchTerm)).slice(0, 50).forEach(country => {
Â const option = document.createElement('div');
Â option.className = 'country-option';
Â option.innerHTML = `<span class="flag-emoji">${getCountryFlagEmoji(country.code)}</span> <span>${country.name}</span>`;
Â option.onclick = () => {
Â document.getElementById(inputId).value = `${getCountryFlagEmoji(country.code)} ${country.name}`;
Â document.getElementById(inputId.replace('-search', '-code')).value = country.code;
Â dropdown.classList.add('hidden');
Â };
Â dropdown.appendChild(option);
Â });
Â }

Â async function updateMembershipTier(userId, userData, oldTier) {
Â  Â  const currentTier = userData.membershipTier;
Â  Â  if (currentTier === 'Owner') return;

Â  Â  const achievements = userData.achievements || {};
Â  Â  const check = (reqs) => reqs.every(req => (achievements[req.id] || 0) >= req.goal);
Â  Â Â 
Â  Â  let newTier = currentTier;
Â  Â  if (currentTier === 'Member' && check(ACHIEVEMENT_CONFIG.toPlus)) {
Â  Â  Â  Â  newTier = 'Plus';
Â  Â  }
Â  Â  if (currentTier === 'Plus' && check(ACHIEVEMENT_CONFIG.toPro)) {
Â  Â  Â  Â  newTier = 'Pro';
Â  Â  }
Â  Â  if (currentTier === 'Pro' && check(ACHIEVEMENT_CONFIG.toMax)) {
Â  Â  Â  Â  newTier = 'Max';
Â  Â  }

Â  Â  if (newTier !== oldTier) {
Â  Â  Â  Â  await update(ref(db, `users/${userId}`), { membershipTier: newTier });
Â  Â  Â  Â  if(userId === App.currentUser?.userId) {
Â  Â  Â  Â  Â  Â  showTierUpgradeAnimation(oldTier, newTier);
Â  Â  Â  Â  }
Â  Â  }
Â }

Â function showTierUpgradeAnimation(oldTier, newTier) {
Â  Â  const oldFeatures = USER_TIER_CONFIG[oldTier];
Â  Â  const newFeatures = USER_TIER_CONFIG[newTier];
Â  Â  const unlockedFeatures = [];

Â  Â  for (const key in newFeatures) {
Â  Â  Â  Â  if (newFeatures[key] && !oldFeatures[key]) {
Â  Â  Â  Â  Â  Â  if (FEATURE_FRIENDLY_NAMES[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  unlockedFeatures.push(FEATURE_FRIENDLY_NAMES[key]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const modal = document.getElementById('tier-upgrade-modal');
Â  Â  document.getElementById('new-tier-name').textContent = newFeatures.name;
Â  Â  const featuresList = document.getElementById('unlocked-features-list');
Â  Â  featuresList.innerHTML = unlockedFeatures.map((feature, i) =>Â 
Â  Â  Â  Â  `<div class="unlocked-feature" style="animation-delay: ${i * 0.1}s">${feature}</div>`
Â  Â  ).join('');

Â  Â  modal.classList.add('show');
Â }

Â function renderVerificationSettings(data) {
Â const container = document.getElementById('verification-section');
Â container.classList.toggle('hidden', data.membershipTier === 'Member' || data.membershipTier === 'Plus');
Â let html = `<h3>Verification âœ”ï¸</h3>`;
Â const tierConfig = USER_TIER_CONFIG[data.membershipTier];

Â if (data.verified) {
Â html += `<p style="color: green; font-weight: bold;">This account is officially verified.</p>`;
Â } else if (data.verificationRequested) {
Â html += `<p style="color: orange;">Your verification request is pending review.</p>`;
Â } else if (tierConfig?.verification) {
Â html += `<p>You are eligible to apply for verification.</p><button id="request-verification-btn" class="btn secondary">Apply for Verification</button>`;
Â }
Â container.innerHTML = html;
Â container.querySelector('#request-verification-btn')?.addEventListener('click', handleRequestVerification);
Â }

Â async function handleRequestVerification() {
Â const answers = {};
Â for (let i = 0; i < VERIFICATION_QUESTIONS.length; i++) {
Â const answer = prompt(`${VERIFICATION_QUESTIONS[i]} (${i+1}/${VERIFICATION_QUESTIONS.length})`);
Â if (answer === null) {
Â showToast("Verification application cancelled.");
Â return;
Â }
Â answers[`q${i+1}`] = answer;
Â }

Â if (confirm("You are about to submit your profile and answers for manual review. Continue?")) {
Â const updates = { verificationRequested: true, verificationAnswers: answers };
Â await update(ref(db, `users/${App.currentUser.userId}`), updates);
Â showToast("Verification request submitted!");
Â const currentData = { ...App.currentProfileData, ...updates };
Â renderVerificationSettings(currentData);
Â }
Â }

Â function renderTiersPage() {
Â  Â  const detailsContainer = document.getElementById('my-plan-details');
Â  Â  const progressContainer = document.getElementById('my-plan-progress');
Â  Â  const allTiersContainer = document.getElementById('all-tiers-info');
Â  Â  if (!App.currentProfileData) return;

Â  Â  const tier = App.currentProfileData.membershipTier || 'Member';
Â  Â  const achievements = App.currentProfileData.achievements || {};
Â  Â  detailsContainer.innerHTML = `<h3>Current Tier: <span style="color: var(--primary);">${USER_TIER_CONFIG[tier].name}</span></h3><p>You unlock new perks by completing achievements and engaging with the platform.</p>`;

Â  Â  let nextTierKey, requirements;
Â  Â  if (tier === 'Member') { nextTierKey = 'Plus'; requirements = ACHIEVEMENT_CONFIG.toPlus; }
Â  Â  else if (tier === 'Plus') { nextTierKey = 'Pro'; requirements = ACHIEVEMENT_CONFIG.toPro; }
Â  Â  else if (tier === 'Pro') { nextTierKey = 'Max'; requirements = ACHIEVEMENT_CONFIG.toMax; }
Â  Â  else {
Â  Â  progressContainer.innerHTML = '<h2>You have reached the highest public tier! ğŸš€</h2><p>Thank you for being a power user!</p>';
Â  Â  }

Â  Â  if (nextTierKey && requirements) {
Â  Â  let progressHtml = `<h2>Progress to ${USER_TIER_CONFIG[nextTierKey].name}</h2>`;
Â  Â  let allGoalsMet = true;
Â  Â  requirements.forEach(req => {
Â  Â  let currentValue = achievements[req.id] || 0;
Â  Â  if(currentValue < req.goal) allGoalsMet = false;
Â  Â  const progress = Math.min((currentValue / req.goal) * 100, 100);
Â  Â  progressHtml += `<div class="achievement-item"><strong>${req.label} (${currentValue} / ${req.goal})</strong><div class="achievement-progress"><div class="progress-bar" style="width: ${progress}%; background-color: ${progress >= 100 ? '#22c55e' : 'var(--primary)'};"></div></div></div>`;
Â  Â  });
Â  Â Â 
Â  Â  if (allGoalsMet) {
Â  Â  progressHtml += `<button id="level-up-btn" class="btn" style="margin-top: 20px;">Claim Your Promotion to ${USER_TIER_CONFIG[nextTierKey].name}!</button>`;
Â  Â  }
Â  Â  progressContainer.innerHTML = progressHtml;
Â  Â  document.getElementById('level-up-btn')?.addEventListener('click', async () => {
Â  Â  Â  Â  await updateMembershipTier(App.currentUser.userId, App.currentProfileData, App.currentProfileData.membershipTier);
Â  Â  Â  Â  const finalSnapshot = await get(ref(db, `users/${App.currentUser.userId}`));
Â  Â  Â  Â  App.currentProfileData = finalSnapshot.val() || {};
Â  Â  Â  Â  renderTiersPage();
Â  Â  });
Â  Â  }

Â  Â  let allTiersHtml = '<div class="tier-plan-grid">';
Â  Â  for (const tierKey of ['Member', 'Plus', 'Pro', 'Max']) {
Â  Â  Â  Â  const config = USER_TIER_CONFIG[tierKey];
Â  Â  Â  Â  let analyticsText = 'No Analytics';
Â  Â  Â  Â  if (config.analytics === 'limited') analyticsText = 'Limited Analytics';
Â  Â  Â  Â  else if (config.analytics === true) analyticsText = 'Full Profile Analytics';
Â  Â  Â  Â Â 
Â  Â  Â  Â  allTiersHtml += `<div class="tier-plan-card"><h3><div class="membership-badge tier-${tierKey}">${config.name}</div></h3><ul><li>${config.linkLimit} Custom Link${config.linkLimit > 1 ? 's' : ''}</li><li>${config.pfp ? 'Custom Profile Picture' : 'Default Profile Picture'}</li><li>${config.qrCode ? 'Profile QR Code Sharing' : 'No QR Code Sharing'}</li><li>${config.customFont ? 'Custom Profile Font' : 'Standard Font'}</li><li>${config.customColor ? 'Custom Profile Colors' : 'Standard Colors'}</li><li>${config.scheduling ? 'Scheduling Link Display' : 'No Scheduling Link'}</li><li>${analyticsText}</li><li>${config.verification ? 'Verification Eligible' : 'Not Verification Eligible'}</li><li>${config.canCustomizeAds ? 'Custom Promo Blocks' : 'No Custom Blocks'}</li><li>${config.canControlPlatformAd ? 'Ad Controls' : 'Platform Ads On'}</li></ul></div>`;
Â  Â  }
Â  Â  allTiersHtml += '</div>';
Â  Â  allTiersContainer.innerHTML = allTiersHtml;
Â }

Â async function renderAdminPanel() {
Â const requestsContainer = document.getElementById('admin-verification-requests');
Â const usersContainer = document.getElementById('admin-all-users');
Â requestsContainer.innerHTML = usersContainer.innerHTML = '<p class="muted">Loading...</p>';
Â 
Â const usersSnap = await get(ref(db, 'users'));
Â const allUsers = usersSnap.val() || {};
Â 
Â const userRequests = Object.entries(allUsers).filter(([uid, user]) => user.verificationRequested && !user.verified).map(([uid, user]) => ({type: 'User', id: uid, data: user}));

Â if (userRequests.length > 0) {
Â requestsContainer.innerHTML = userRequests.map(req => {
Â let answersHtml = '';
Â if (req.data?.verificationAnswers) {
Â answersHtml = Object.entries(req.data.verificationAnswers).map(([key, value], index) => `<p><strong>Q${index+1}:</strong> ${value || 'Not answered'}</p>`).join('');
Â }
Â return `<div class="verification-request-card"><p><strong>Type:</strong> ${req.type}</p><p><strong>Name:</strong> ${req.data.displayName}</p><p><strong>ID:</strong> ${req.id}</p>${answersHtml ? `<div><h4>Answers:</h4>${answersHtml}</div>` : ''}<div class="verification-actions"><button class="btn approve-verify-btn" data-id="${req.id}">Approve</button><button class="btn secondary deny-verify-btn" data-id="${req.id}">Deny</button></div></div>`}).join('');
Â } else {
Â requestsContainer.innerHTML = '<p>No active verification requests.</p>';
Â }

Â usersContainer.innerHTML = `<table class="admin-table"><thead><tr><th>Name</th><th>Email</th><th>Tier</th></tr></thead><tbody>${Object.entries(allUsers).map(([uid, user]) => `<tr><td><a href="?user=${uid}" target="_blank">${user.displayName}</a></td><td>${user.email}</td><td><select class="admin-edit-field" data-uid="${uid}" data-field="membershipTier">${Object.keys(USER_TIER_CONFIG).map(t => `<option value="${t}" ${user.membershipTier === t ? 'selected' : ''}>${t}</option>`).join('')}</select></td></tr>`).join('')}</tbody></table>`;
Â 
Â document.querySelectorAll('.approve-verify-btn, .deny-verify-btn').forEach(btn => btn.addEventListener('click', handleVerificationAction));
Â document.querySelectorAll('.admin-edit-field').forEach(sel => sel.addEventListener('change', handleAdminEdit));
Â }

Â async function handleVerificationAction(e) {
Â const { id } = e.target.dataset;
Â const isApprove = e.target.classList.contains('approve-verify-btn');
Â const updates = { verified: isApprove, verificationRequested: false };
Â await update(ref(db, `users/${id}`), updates);
Â showToast(`User request ${isApprove ? 'approved' : 'denied'}.`);
Â renderAdminPanel();
Â }

Â async function handleAdminEdit(e) {
Â const { uid, field } = e.target.dataset;
Â const value = e.target.value;
Â await update(ref(db, `users/${uid}`), { [field]: value });
Â showToast(`User ${field} updated.`);
Â }

Â function addEventListeners() {
Â document.querySelector('.auth-tabs')?.addEventListener('click', e => {
Â if (e.target.classList.contains('tab')) {
Â document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
Â e.target.classList.add('active');
Â const isLogin = e.target.dataset.tab === 'login';
Â document.getElementById('login-form-container').classList.toggle('hidden', !isLogin);
Â document.getElementById('signup-form').classList.toggle('hidden', isLogin);
Â }
Â });

Â document.getElementById('signup-form')?.addEventListener('submit', handleEmailSignup);
Â document.getElementById('login-form')?.addEventListener('submit', handleEmailLogin);
Â document.getElementById('google-login-btn')?.addEventListener('click', handleGoogleLogin);
Â document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
Â document.getElementById('delete-account-btn')?.addEventListener('click', handleDeleteAccount);
Â document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
Â document.getElementById('share-status-btn')?.addEventListener('click', handleShareStatus);
Â document.getElementById('run-search-btn')?.addEventListener('click', handleSearchUsers);
Â document.getElementById('generate-qrcode-btn')?.addEventListener('click', handleGenerateQrCode);

Â App.elements.mainHeader?.addEventListener('click', e => {
Â const navBtn = e.target.closest('.nav-btn');
Â if (navBtn) navigateTo(navBtn.dataset.page);
Â });

Â const countrySearch = document.getElementById('country-search');
Â const countryDropdown = document.getElementById('country-dropdown');
Â countrySearch?.addEventListener('focus', () => { countryDropdown.classList.remove('hidden'); filterCountries('country-search', 'country-dropdown'); });
Â countrySearch?.addEventListener('keyup', () => filterCountries('country-search', 'country-dropdown'));
Â document.addEventListener('click', (e) => {
Â if (!e.target.closest('.country-select-wrapper')) countryDropdown?.classList.add('hidden');
Â });
Â 
Â const giftBox = document.getElementById('gift-box-icon');
Â giftBox.addEventListener('click', () => {
Â  Â  giftBox.classList.add('unboxing');
Â  Â  setTimeout(() => {
Â  Â  Â  Â  document.getElementById('upgrade-gift-stage').style.display = 'none';
Â  Â  Â  Â  document.getElementById('upgrade-results-stage').classList.add('show');
Â  Â  }, 500);
Â });

Â document.getElementById('close-upgrade-modal-btn').addEventListener('click', () => {
Â  Â  const modal = document.getElementById('tier-upgrade-modal');
Â  Â  modal.classList.remove('show');
Â  Â  setTimeout(() => {
Â  Â  Â  Â  document.getElementById('upgrade-gift-stage').style.display = 'block';
Â  Â  Â  Â  document.getElementById('upgrade-results-stage').classList.remove('show');
Â  Â  Â  Â  giftBox.classList.remove('unboxing');
Â  Â  Â  Â  showToast(`Your new perks are active!`);
Â  Â  }, 400);
Â });
Â }

Â document.addEventListener('DOMContentLoaded', handlePageLoad);
Â </script>
</body>
</html>
