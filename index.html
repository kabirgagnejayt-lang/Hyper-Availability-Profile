<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Hyper Availability Profile (HAP)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ADDED GOOGLE FONTS FOR CUSTOMIZATION */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Roboto+Mono:wght@400;700&family=Playfair+Display:wght@700&display=swap');

        :root {
            --primary: #0ea5e9; --primary-light: #f0f9ff; --primary-dark: #0369a1;
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
            --border-color: #e2e8f0; --input-bg: #f1f5f9;
            --radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            /* Dynamic PFP Colors */
            --pfp-bg-day: var(--primary-light);
            --pfp-border-day: var(--primary);
            /* New Customization Vars */
            --link-text-color: #0369a1;
            --display-font: 'Inter', sans-serif;
            --profile-header-bg-style: var(--card);
        }

        body.dark {
            --primary: #38bdf8; --primary-light: #1e293b; --primary-dark: #7dd3fc;
            --bg: #020617; --card: #0f172a; --text: #e2e8f0; --muted: #94a3b8;
            --border-color: #334155; --input-bg: #1e293b;
        }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .page.active { animation: fadeIn 0.5s ease-out forwards; }
        .card, .history-item, .search-result-item { animation: fadeSlideUp 0.6s ease-out forwards; animation-delay: 0.1s; opacity: 0; transform: translateY(15px); }

        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            margin: 0; padding: 20px 0 100px 0;
            font-family: var(--display-font);
            background: var(--bg); color: var(--text);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.4s, color 0.4s;
        }

        header {
            padding: 10px 14px; display: flex; gap: 12px; align-items: center; justify-content: center;
            background: var(--card); box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 100; border-top: 1px solid var(--border-color);
            transition: transform 0.4s ease-in-out, background-color 0.4s;
        }
        header.hidden { transform: translateY(100%); }
        nav { display: flex; gap: 8px; align-items: center; width: 100%; max-width: 500px; justify-content: space-around; }
        .nav-btn {
            background: transparent; border: none; padding: 8px 10px; border-radius: 8px;
            cursor: pointer; color: var(--muted); font-weight: 500; font-size: 0.9rem;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.2s ease;
        }
        .nav-btn.active { background: var(--primary-light); color: var(--primary-dark); }
        .nav-btn:hover { color: var(--primary-dark); transform: translateY(-2px); }
        .nav-btn svg { width: 24px; height: 24px; }

        .container { max-width: 700px; margin: 0 auto; padding: 0 14px; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; transition: background-color 0.4s; }

        h1 { font-size: 2.25rem; font-weight: 700; margin: 0 0 8px 0; text-align: center; }
        h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        h3 { font-size: 1.2rem; font-weight: 600; margin-top: 20px; }
        p { color: var(--muted); line-height: 1.6; margin: 4px 0; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--muted); }

        input, select, textarea, button { font-size: 1rem; font-family: inherit; }
        input[type="text"], input[type="email"], input[type="password"], input[type="url"], input[type="number"], input[type="time"], input[type="date"], input[type="tel"], select, textarea {
            width: 100%; box-sizing: border-box; padding: 12px; border-radius: 8px;
            border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        textarea { resize: vertical; min-height: 80px; }
        input[type="color"] { width: 100%; height: 44px; padding: 0; border: none; background: transparent; cursor: pointer; }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary); border-color: var(--primary); }
        input[type="file"] { padding: 10px; }
        .form-field-disabled, .form-field-disabled > * { opacity: 0.6; pointer-events: none; }
        .form-field-disabled label { text-decoration: line-through; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 18px;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;
            width: 100%; text-align: center; display: inline-flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn.secondary { background: var(--primary-light); color: var(--primary-dark); }
        .btn.secondary:hover { background-color: var(--primary); color: white; }
        .form-group { margin-bottom: 20px; }

        #loginPage .card { margin-top: 40px; }
        .auth-tabs { display: flex; margin-bottom: 25px; border-radius: 10px; background: var(--input-bg); padding: 5px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 8px; font-weight: 500; transition: background-color 0.3s ease, color 0.3s; }
        .tab.active { background-color: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .social-login-btn { margin-top: 10px; background: #4285F4; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .social-login-btn:hover { background: #3c7ceb; }


        .profile-header { text-align: center; margin-bottom: 30px; background: var(--profile-header-bg-style); transition: background 0.5s ease; padding: 20px; }
        #profile-pfp {
            width: 96px; height: 96px; border-radius: 50%; margin: 0 auto 16px auto;
            background-color: var(--pfp-bg-day); background-size: cover; background-position: center;
            border: 3px solid var(--pfp-border-day); transition: all 0.4s;
            display: flex; justify-content: center; align-items: center; /* Center text PFP */
            font-size: 3rem; font-weight: 700; color: var(--primary-dark);
        }
        .profile-emoji { font-size: 4rem; line-height: 1; margin: 16px 0; }
        
        .profile-name { 
            font-weight: 700; margin: 0; font-family: var(--display-font); 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2.25rem;
            color: var(--text);
        }
        .profile-name.is-owner { color: #ef4444; }
        
        .role-badge-container {
            display: flex; justify-content: center; align-items: center;
            gap: 8px; margin: 5px auto 16px auto; flex-wrap: wrap;
        }
        
        .membership-badge {
            font-size: 0.8rem; font-weight: 700; padding: 4px 10px; 
            border-radius: 6px; color: white;
        }
        .tier-Member { background-color: #64748b; }
        .tier-MemberPlus { background-color: #a855f7; }
        .tier-VIP { background: linear-gradient(45deg, #f59e0b, #fbbf24); }
        .tier-Max { background: linear-gradient(45deg, #4f46e5, #7c3aed); }
        .tier-Owner { background-color: #ef4444; }
        
        .inline-verified-icon {
            color: #0ea5e9; margin-left: 8px;
            width: 24px; height: 24px; flex-shrink: 0;
        }

        .profile-message { font-size: 1.2rem; color: var(--muted); min-height: 28px; }
        .profile-timer { font-size: 2.5rem; color: var(--primary); font-weight: 700; margin-top: 24px; min-height: 40px; }
        .profile-country { display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; margin-top: 10px; }
        .profile-country .flag-emoji { font-size: 1.5rem; }

        .custom-link {
            display: inline-flex; align-items: center; gap: 8px; background: var(--primary-light);
            padding: 10px 15px; border-radius: 8px; text-decoration: none; color: var(--link-text-color);
            font-weight: 500; transition: all 0.2s ease;
        }
        .custom-link:hover { background-color: var(--primary); color: #fff; transform: translateY(-2px); }
        .custom-link svg { width: 18px; height: 18px; }
        .action-links-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px; }
        .personal-detail-item { font-size: 1rem; padding: 8px 0; border-bottom: 1px dashed var(--border-color); }

        .link-group, .privacy-group { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 15px; align-items: center; }
        @media (max-width: 500px) { .link-group, .privacy-group { grid-template-columns: 1fr; } }

        .timetable-entry-card { background: var(--input-bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; }

        .country-select-wrapper { position: relative; }
        .country-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--card); border: 1px solid var(--border-color); border-radius: 8px;
            max-height: 200px; overflow-y: auto; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .country-option { padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .country-option:hover { background: var(--input-bg); }
        .country-option .flag-emoji { font-size: 1.2rem; }

        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-top: 20px; }
        .analytics-metric { background: var(--input-bg); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary); margin: 0 0 5px 0; }
        .metric-label { font-size: 0.9rem; color: var(--muted); font-weight: 500; }

        .history-item { padding: 10px 0; border-left: 3px solid var(--border-color); margin-left: 10px; padding-left: 15px; position: relative; }
        .history-item:before {
            content: ''; position: absolute; left: -8px; top: 15px;
            width: 13px; height: 13px; background: var(--primary); border-radius: 50%;
            border: 3px solid var(--card); box-shadow: 0 0 0 2px var(--primary);
        }
        .history-status { font-weight: 600; color: var(--text); display: block; }
        .history-time { font-size: 0.8rem; color: var(--muted); }
        .search-result-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .search-result-item a { text-decoration: none; font-weight: 600; color: var(--primary); }

        footer { margin-top: 40px; text-align: center; color: var(--muted); font-size: 0.9rem; padding: 20px 0; border-top: 1px solid var(--border-color); }
        footer a { color: var(--primary); text-decoration: none; margin: 0 5px; }
        footer a:hover { text-decoration: underline; }

        .hidden { display: none !important; }
        #error-message { color: #ef4444; text-align: center; min-height: 24px; font-weight: bold; margin-top: 15px; }
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #0f172a; color: white; padding: 12px 20px; border-radius: 8px;
            z-index: 3000; visibility: hidden; opacity: 0; transition: all 0.4s ease;
            text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }

        #global-error-display {
            position: fixed; top: 0; left: 0; right: 0; padding: 15px;
            background: #f87171; color: white; text-align: center; font-weight: bold;
            z-index: 5000; display: none; border-bottom: 2px solid #ef4444;
        }
        
        .btn-loading { pointer-events: none; opacity: 0.8; }
        .btn-loading::after {
            content: ""; border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite;
        }
        /* Styles for Admin Panel, My Plan & Orgs */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        .admin-table th, .admin-table td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        .admin-table th { background-color: var(--input-bg); }
        .admin-table select { padding: 6px; }

        .achievement-item { margin-bottom: 15px; }
        .achievement-progress { width: 100%; background: var(--input-bg); border-radius: 8px; height: 10px; overflow: hidden; margin-top: 6px; }
        .progress-bar { height: 100%; background: var(--primary); border-radius: 8px; transition: width 0.5s ease; }
        
        .verification-request-card { background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .verification-request-card p { margin: 0 0 10px 0; }
        .verification-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        /* Tier Plan Display Styles */
        .tier-plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .tier-plan-card { background: var(--input-bg); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border-color); }
        .tier-plan-card h3 { margin-top: 0; display: flex; align-items: center; gap: 8px; }
        .tier-plan-card ul { list-style-type: '‚úì '; padding-left: 20px; color: var(--muted); }
        .tier-plan-card ul li { margin-bottom: 8px; }

        /* Organization Specific Styles */
        #org-banner { width: 100%; height: 150px; background-size: cover; background-position: center; border-radius: var(--radius) var(--radius) 0 0; background-color: var(--input-bg); }
        #org-logo { width: 80px; height: 80px; border-radius: 50%; margin: -40px auto 10px auto; border: 4px solid var(--card); background-color: var(--card); display: block; background-size: cover; background-position: center; }
        .org-member-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .org-member-pfp { width: 40px; height: 40px; border-radius: 50%; background-color: var(--input-bg); background-size: cover; background-position: center; }
    </style>
</head>
<body>

    <div id="global-error-display">A critical error occurred. Check the console for details.</div>

    <header id="mainHeader" class="hidden">
        <nav>
            <button class="nav-btn" data-page="profilePage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 3.096 10.047 9.005 9.005 0 0 1 5.9 8.181.75.75 0 0 1-1.498.07 7.502 7.502 0 0 0-15 0 .75.75 0 0 1-1.498-.07A9.005 9.005 0 0 1 9 12.55a5.5 5.5 0 0 1 3-10.05ZM12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"></path></svg>
                <span>Profile</span>
            </button>
                <button class="nav-btn" data-page="tiersPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06l-1.72-1.72V7.5h-1.5V4.06L9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5V15a.75.75 0 0 0 1.5 0V7.5h3.75a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h3.75Z"></path></svg>
                <span>Tiers</span>
            </button>
            <button class="nav-btn" data-page="organizationsPage">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 6.375a.75.75 0 0 1 .75-.75h13.5a.75.75 0 0 1 .75.75v9a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75v-9Z"></path><path fill-rule="evenodd" d="M22.5 12c0-5.422-4.235-9.844-9.513-10.451a.75.75 0 0 0-.674.807 9.002 9.002 0 0 1-1.623 8.195.75.75 0 0 0 .341 1.018 10.46 10.46 0 0 1 5.341 5.341.75.75 0 0 0 1.018.341 9.002 9.002 0 0 1 8.195-1.623.75.75 0 0 0 .807-.674A10.5 10.5 0 0 0 22.5 12Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M1.5 12c0 5.422 4.235 9.844 9.513 10.451a.75.75 0 0 0 .674-.807 9.002 9.002 0 0 1 1.623-8.195.75.75 0 0 0-.341-1.018 10.46 10.46 0 0 1-5.341-5.341.75.75 0 0 0-1.018-.341A9.002 9.002 0 0 1 1.549 4.97a.75.75 0 0 0-.807.674A10.5 10.5 0 0 0 1.5 12Z" clip-rule="evenodd"></path></svg>
                <span>Organizations</span>
            </button>
            <button class="nav-btn" data-page="searchPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd"></path></svg>
                <span>Search</span>
            </button>
            <button id="analytics-nav-btn" class="nav-btn" data-page="analyticsPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 4.5a.75.75 0 0 0-1.5 0V7.5a.75.75 0 0 0 1.5 0V4.5ZM17.25 5.25a.75.75 0 0 0-1.5 0V9a.75.75 0 0 0 1.5 0V5.25ZM14.25 7.5a.75.75 0 0 0-1.5 0v10.5a.75.75 0 0 0 1.5 0V7.5ZM21 9a.75.75 0 0 0-1.5 0v7.5a.75.75 0 0 0 1.5 0V9ZM3.75 12a.75.75 0 0 0-1.5 0v4.5a.75.75 0 0 0 1.5 0V12Z"></path><path fill-rule="evenodd" d="M3 3a1.5 1.5 0 0 0-1.5 1.5V19.5A1.5 1.5 0 0 0 3 21h18a1.5 1.5 0 0 0 1.5-1.5V4.5A1.5 1.5 0 0 0 21 3H3ZM5.25 19.5h13.5V4.5H5.25v15Z" clip-rule="evenodd"></path></svg>
                <span>Analytics</span>
            </button>
            <button class="nav-btn" data-page="settingsPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.64 3.023a.75.75 0 0 1 .72 0l1.517.65a.75.75 0 0 0 .841-.252l1.11-1.48A.75.75 0 0 1 17 2.25a.75.75 0 0 1 .633.368l1.11 1.48a.75.75 0 0 0 .84.253l1.518-.65a.75.75 0 0 1 .72 0l1.016.436a.75.75 0 0 1 .45 1.033l-.74 1.385a.75.75 0 0 0 .14.925l1.28.96a.75.75 0 0 1 0 1.302l-1.28.96a.75.75 0 0 0-.14.925l.74 1.385a.75.75 0 0 1-.45 1.033l-1.017.436a.75.75 0 0 1-.72 0l-1.517-.65a.75.75 0 0 0-.84.252l-1.11 1.48A.75.75 0 0 1 17 21.75a.75.75 0 0 1-.633-.368l-1.11-1.48a.75.75 0 0 0-.84-.253l-1.518.65a.75.75 0 0 1-.72 0l-1.016-.436a.75.75 0 0 1-.45-1.033l.74-1.385a.75.75 0 0 0-.14-.925l-1.28-.96a.75.75 0 0 1 0-1.302l1.28.96a.75.75 0 0 0 .14-.925l-.74-1.385a.75.75 0 0 1 .45-1.033l1.017-.436ZM12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path></svg>
                <span>Settings</span>
            </button>
                <button id="admin-nav-btn" class="nav-btn hidden" data-page="adminPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 2.25a.75.75 0 0 0 0 1.5v16.5a.75.75 0 0 0 0 1.5h15a.75.75 0 0 0 0-1.5V3.75a.75.75 0 0 0 0-1.5h-15ZM5.25 21a1.5 1.5 0 0 0 1.5-1.5V3.75A1.5 1.5 0 0 0 5.25 2.25h-1.5A3 3 0 0 0 .75 5.25v13.5A3 3 0 0 0 3.75 21h1.5Zm15-1.5V3.75A1.5 1.5 0 0 0 18.75 2.25h-1.5a.75.75 0 0 0 0 1.5h1.5c.414 0 .75.336.75.75v16.5c0 .414-.336.75-.75.75h-1.5a.75.75 0 0 0 0 1.5h1.5a3 3 0 0 0 3-3V5.25a3 3 0 0 0-3-3h-1.5ZM8.25 7.5a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5Zm.75 3.75a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg>
                <span>Admin</span>
            </button>
        </nav>
    </header>

    <div class="container">

        <div id="loginPage" class="page">
            <div class="card">
                <h1>Hyper Availability</h1>
                <p style="text-align: center;">Your real-time public status page.</p>
                <div class="auth-tabs">
                    <div class="tab active" data-tab="login">Login</div>
                    <div class="tab" data-tab="signup">Sign Up</div>
                </div>

                <form id="login-form">
                    <div class="form-group"><input type="email" id="login-email" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="login-password" placeholder="Password" required></div>
                    <button type="submit" class="btn">Login with Email</button>
                </form>

                <form id="signup-form" class="hidden">
                    <div class="form-group"><input type="text" id="signup-name" placeholder="Display Name" required></div>
                    <div class="form-group"><input type="email" id="signup-email" placeholder="Email" required></div>
                    <div class="form-group"><input type="password" id="signup-password" placeholder="Password (min. 6 chars)" required></div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
                
                <button id="google-login-btn" class="social-login-btn">
                    <svg viewBox="0 0 24 24" width="24" height="24" style="background: white; border-radius: 50%; padding: 4px;"><path fill="#EA4335" d="M5.266 9.389a6.6 6.6 0 0 1 .235-1.565h3.08v3.136H5.266z"></path><path fill="#4285F4" d="M12 21.36c-2.333 0-4.32-.778-5.755-2.072L9.36 17.06c.9.605 2.07 1.05 3.398 1.05 2.872 0 4.673-1.637 4.673-3.957 0-1.724-.96-2.91-2.5-3.69v-3.3h3.045c2.324 0 3.86 1.764 3.86 5.25 0 4.8-3.045 7.027-7.426 7.027z"></path><path fill="#FBBC05" d="M12 7.03c1.64 0 2.977.674 3.69 1.344l2.42-2.348C17.042 4.417 15.02 3 12 3 7.61 3 4.195 5.253 2.57 9.172l3.045 2.368c.57-1.897 2.37-3.67 6.385-3.67z"></path><path fill="#34A853" d="M5.504 12.87a6.22 6.22 0 0 1-.238-1.564H2.227v3.136h3.277z"></path></svg>
                    Login with Google
                </button>
                
                <p id="error-message"></p>
            </div>
        </div>

        <div id="profilePage" class="page">
            <div class="card profile-header" style="padding: 0; overflow: hidden;">
                <div id="org-banner"></div>
                <div id="profile-pfp"></div> 
                
                <div style="padding: 0 20px 20px 20px;">
                    <h1 class="profile-name" id="profile-name">Loading...</h1>
                    <div id="role-and-verified-container" class="role-badge-container">
                        <div id="membership-tier-display" class="membership-badge"></div>
                    </div>
                    <div class="profile-emoji" id="profile-emoji">‚ùì</div>
                    <p class="profile-message" id="profile-message">Fetching status...</p>
                    <div class="profile-timer" id="profile-timer"></div>
                    <p class="local-time-display" id="local-time-info" style="font-size: 1rem; margin-top: 10px; font-weight: 500;"></p>
                </div>
            </div>

            <div class="card action-links-container" id="profile-action-links"></div>

            <div class="card">
                <h2>About</h2>
                <div id="personal-details-list">
                    <p class="muted">Loading personal info...</p>
                </div>
            </div>

            <div class="card">
                <h2>Custom Links</h2>
                <div id="profile-links"><p class="muted">No links provided.</p></div>
            </div>

            <div class="card">
                <h2>Share Profile</h2>
                <div style="text-align: center;">
                    <div id="qrcode-container" style="display: inline-block; padding: 15px; background: var(--card); border-radius: 8px; border: 1px solid var(--border-color); min-height: 230px;">
                        <img id="profile-qrcode-img" width="200" height="200" style="display: none; border-radius: 4px;" alt="Profile QR Code"> 
                        <p id="qrcode-placeholder" class="muted">Click button below to generate QR.</p>
                    </div>
                </div>
                <button id="generate-qrcode-btn" class="btn secondary" style="margin-top: 15px;">Generate QR Code</button>
                <button id="share-status-btn" class="btn" style="margin-top: 10px;">Copy Profile Link</button>
            </div>

            <div class="card hidden" id="create-hap-promo">
                <h3 style="text-align: center;">Like this status page?</h3>
                <p style="text-align: center;">Create your own real-time availability profile in seconds!</p>
                <div style="display: flex; justify-content: center; margin-top: 15px;">
                    <button class="btn" id="promo-action-btn" style="flex: 0 1 250px;"></button>
                </div>
            </div>
        </div>
        
        <div id="searchPage" class="page">
            <div class="card">
                <h2>HAP Directory üåê</h2>
                <div class="form-group" style="margin-bottom: 0;">
                    <input type="text" id="user-search-input" placeholder="Search users or organizations...">
                </div>
                <button id="run-search-btn" class="btn secondary" style="margin-top: 10px;">Search / Load Directory</button>
                <div id="search-results-list" style="margin-top: 20px;">
                    <p class="muted">Search for users by name or click 'Search' to view all public profiles.</p>
                </div>
            </div>
        </div>

        <div id="analyticsPage" class="page">
            <div class="card">
                <h2>Profile View Analytics üìà</h2>
                <div class="analytics-grid" id="view-analytics-grid">
                    <div class="analytics-metric"><p class="metric-value" id="views-total">0</p><p class="metric-label">Total Views</p></div>
                    <div class="analytics-metric"><p class="metric-value" id="views-today">0</p><p class="metric-label">Views Today</p></div>
                    <div class="analytics-metric"><p class="metric-value" id="views-week">0</p><p class="metric-label">Views Last 7 Days</p></div>
                    <div class="analytics-metric"><p class="metric-value" id="views-month">0</p><p class="metric-label">Views Last 30 Days</p></div>
                </div>
            </div>
            <div class="card">
                <h2>Status History Timeline (Last 10)</h2>
                <div id="history-log"><p class="muted">Loading history...</p></div>
            </div>
        </div>

        <div id="tiersPage" class="page">
            <div class="card">
                <h2>My Tier & Progress</h2>
                <div id="my-plan-details"><p class="muted">Loading your plan details...</p></div>
            </div>
            <div class="card">
                <div id="my-plan-progress"><p class="muted">Loading your achievement progress...</p></div>
            </div>
            <div class="card">
                 <h2>All Tiers & Benefits</h2>
                 <div id="all-tiers-info"><p class="muted">Loading all tiers...</p></div>
            </div>
        </div>

        <div id="organizationsPage" class="page">
        </div>

        <div id="adminPage" class="page">
            <div class="card">
                <h2>üëë Admin Panel</h2>
                <p class="muted">Manage users, organizations, and verification requests.</p>
            </div>
            <div class="card">
                <h2>Verification Requests</h2>
                <div id="admin-verification-requests"><p class="muted">Loading requests...</p></div>
            </div>
            <div class="card">
                <h2>All Users</h2>
                <div id="admin-all-users" style="max-height: 400px; overflow-y: auto;"><p class="muted">Loading users...</p></div>
            </div>
            <div class="card">
                <h2>All Organizations</h2>
                <div id="admin-all-orgs" style="max-height: 400px; overflow-y: auto;"><p class="muted">Loading organizations...</p></div>
            </div>
        </div>


        <div id="settingsPage" class="page">
            <div class="card">
                <h2>Profile Settings</h2>
                <div class="form-group">
                    <label for="display-name">Display Name</label>
                    <input type="text" id="display-name">
                </div>
                <div class="form-group">
                    <label for="themeSelect">Theme</label>
                    <select id="themeSelect">
                        <option value="auto">Auto (Day/Night)</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="form-group" id="font-customization-field">
                    <label for="display-font">Display Name Font</label>
                    <select id="display-font">
                        <option value="Inter, sans-serif">Inter (Default)</option>
                        <option value="Poppins, sans-serif">Poppins</option>
                        <option value="Roboto Mono, monospace">Roboto Mono</option>
                        <option value="Playfair Display, serif">Playfair Display</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>Personal Info</h2>
                <div class="form-group">
                    <label for="bio">Short Bio / Tagline</label>
                    <textarea id="bio" placeholder="A brief description of yourself."></textarea>
                </div>
                <div class="form-group">
                    <label for="birthday">Birthday</label>
                    <input type="date" id="birthday">
                </div>
                <div class="form-group">
                    <label for="country-search">Country</label>
                    <div class="country-select-wrapper">
                        <input type="text" id="country-search" placeholder="Search for a country...">
                        <div id="country-dropdown" class="country-dropdown hidden"></div>
                    </div>
                    <input type="hidden" id="country-code">
                </div>
                <div class="form-group">
                    <label for="phone-number">Public Phone Number</label>
                    <input type="tel" id="phone-number" placeholder="+1 (555) 123-4567">
                </div>
                <div class="form-group" id="scheduling-link-field">
                    <label for="scheduling-link">Scheduling Link (e.g., Calendly)</label>
                    <input type="url" id="scheduling-link" placeholder="https://calendly.com/yourname">
                </div>
            </div>

            <div class="card">
                <h2>Visual Customization</h2>
                <div class="form-group">
                    <label for="pfp-upload">Profile Picture (Upload)</label>
                    <input type="file" id="pfp-upload" accept="image/*">
                </div>
                <div class="form-group" id="accent-color-field">
                    <label for="accent-color">Profile Accent Color</label>
                    <input type="color" id="accent-color" value="#0ea5e9">
                </div>
                <div class="form-group" id="link-text-color-field">
                    <label for="link-text-color">Custom Link Text Color</label>
                    <input type="color" id="link-text-color" value="#0369a1">
                </div>
            </div>

            <div class="card">
                <h2>Update Status</h2>
                <div class="form-group">
                    <label for="status-emoji">Current Status</label>
                    <select id="status-emoji">
                        <option value="üü¢">üü¢ Available</option>
                        <option value="üíª">üíª Busy</option>
                        <option value="üß†">üß† Deep Work</option>
                        <option value="üöó">üöó Commuting</option>
                        <option value="‚òï">‚òï On a Break</option>
                        <option value="üî¥">üî¥ Do Not Disturb</option>
                        <option value="üìö">üìö School/Study</option>
                        <option value="üèñÔ∏è">üèñÔ∏è Vacation/OOO</option>
                        <option value="üò¥">üò¥ Offline/Sleeping</option>
                        <option value="üçΩÔ∏è">üçΩÔ∏è Meal Time</option>
                        <option value="üèãÔ∏è">üèãÔ∏è Working Out</option>
                        <option value="üéÆ">üéÆ Gaming</option>
                        <option value="‚úàÔ∏è">‚úàÔ∏è Traveling</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status-message">Message</label>
                    <input type="text" id="status-message" placeholder="e.g., Drafting 2026 Strategy">
                </div>
            </div>

            <div class="card" id="automatic-timetable-card">
                <h2>Automatic Timetable ‚è∞</h2>
                <p class="muted" style="margin-bottom: 15px;">Set your recurring weekly schedule to update your status automatically.</p>
                <div id="timetable-entries-container">
                    <p class="muted" id="no-timetable-message">No scheduled entries yet.</p>
                </div>
                <button id="add-timetable-entry-btn" class="btn secondary" style="margin-top: 15px;">Add Schedule</button>
            </div>

            <div class="card">
                <h2>Custom Links</h2>
                <div id="custom-links-container"></div>
            </div>

            <div class="card">
                <h2>Verification</h2>
                <div id="verification-section"></div>
            </div>

            <div class="card">
                <button id="save-settings-btn" class="btn">Save All Changes</button>
                <button id="logout-btn" class="btn secondary" style="margin-top: 12px;">Logout</button>
                <button id="delete-account-btn" class="btn" style="margin-top: 20px; background-color: #ef4444; color: white;">Delete My Account Permanently</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 HAP | A Demo Project</p>
    </footer>

    <div id="toast"></div>

    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            deleteUser,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            update,
            push, 
            query, 
            orderByKey, 
            limitToLast,
            orderByChild,
            equalTo
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        import { 
            getStorage, 
            ref as storageRef, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyChwjwXFgIj9f64zGeIoS-q_odZm2ogFMw",
            authDomain: "happp-96438.firebaseapp.com",
            databaseURL: "https://happp-96438-default-rtdb.firebaseio.com",
            projectId: "happp-96438",
            storageBucket: "happp-96438.appspot.com",
            messagingSenderId: "703348367691",
            appId: "1:703348367691:web:376cd50d08d94bccf588ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // --- GLOBAL ERROR HANDLING ---
        window.onerror = function(message, source, lineno, colno, error) {
            const errorDiv = document.getElementById('global-error-display');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = `CRITICAL ERROR: ${message} (Line ${lineno})`;
            }
            console.error("Global Error Caught:", message, source, lineno, colno, error);
            return false;
        };

        // --- GLOBAL STATE & CONSTANTS ---
        let countdownInterval;
        let timetableCheckInterval;
        let isPublicView = false;
        let publicViewInterval = null;
        let isAuthResolved = false;

        const App = {
            pages: ['loginPage', 'profilePage', 'searchPage', 'analyticsPage', 'settingsPage', 'tiersPage', 'adminPage', 'organizationsPage'],
            elements: {},
            currentUser: null,
            currentProfileData: null,
        };
        
        const TIER_CONFIG = {
            'Member': { name: 'Member', linkLimit: 1, timetable: false, customFont: false, customColor: false, scheduling: false, analytics: false, verification: false },
            'MemberPlus': { name: 'Member+', linkLimit: 3, timetable: false, customFont: true, customColor: false, scheduling: true, analytics: false, verification: false },
            'VIP': { name: 'VIP', linkLimit: 5, timetable: true, customFont: true, customColor: true, scheduling: true, analytics: true, verification: true },
            'Max': { name: 'Max', linkLimit: 10, timetable: true, customFont: true, customColor: true, scheduling: true, analytics: true, verification: true },
            'Owner': { name: 'Owner', linkLimit: 10, timetable: true, customFont: true, customColor: true, scheduling: true, analytics: true, verification: true },
        };
        
        const ACHIEVEMENT_CONFIG = {
            toMemberPlus: [
                { id: 'profileComplete', label: 'Profile Complete (Bio, Birthday, Country)', goal: 1 },
                { id: 'scheduler', label: 'Add 1 Timetable Entry', goal: 1 },
                { id: 'socialButterfly', label: 'Add 2 Custom Links', goal: 2 },
                { id: 'firstShare', label: 'Share Profile Once', goal: 1 },
                { id: 'views', label: 'Get 5 Profile Views', goal: 5 },
                { id: 'loyalUser', label: 'Log In on 3 Different Days', goal: 3 },
                { id: 'expressive', label: 'Use 3 Different Status Emojis', goal: 3 },
                { id: 'referral', label: 'Refer 1 New User', goal: 1 },
            ],
            toVIP: [
                { id: 'scheduler', label: 'Add 2 Timetable Entries', goal: 2 },
                { id: 'socialButterfly', label: 'Add 3 Custom Links', goal: 3 },
                { id: 'views', label: 'Get 10 Profile Views', goal: 10 },
                { id: 'loyalUser', label: 'Log In on 7 Different Days', goal: 7 },
                { id: 'expressive', label: 'Use 5 Different Status Emojis', goal: 5 },
                { id: 'referral', label: 'Refer 3 New Users', goal: 3 },
            ],
            toMax: [
                { id: 'profileComplete', label: 'Fill Out All Optional Info Fields', goal: 1 }, // Simplified goal for demo
                { id: 'scheduler', label: 'Add 2 Timetable Entries', goal: 2 },
                { id: 'socialButterfly', label: 'Add 3 Custom Links', goal: 3 },
                { id: 'views', label: 'Get 30 Profile Views', goal: 30 },
                { id: 'loyalUser', label: 'Log In on 14 Different Days', goal: 14 },
                { id: 'expressive', label: 'Use 10 Different Status Emojis', goal: 10 },
                { id: 'referral', label: 'Refer 5 New Users', goal: 5 },
            ]
        };

        const DAYS_OF_WEEK = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const COUNTRY_LIST = [ {name: "Afghanistan", code: "AF"}, {name: "√Öland Islands", code: "AX"}, {name: "Albania", code: "AL"}, {name: "Algeria", code: "DZ"}, {name: "American Samoa", code: "AS"}, {name: "Andorra", code: "AD"}, {name: "Angola", code: "AO"}, {name: "Anguilla", code: "AI"}, {name: "Antarctica", code: "AQ"}, {name: "Antigua and Barbuda", code: "AG"}, {name: "Argentina", code: "AR"}, {name: "Armenia", code: "AM"}, {name: "Aruba", code: "AW"}, {name: "Australia", code: "AU"}, {name: "Austria", code: "AT"}, {name: "Azerbaijan", code: "AZ"}, {name: "Bahamas", code: "BS"}, {name: "Bahrain", code: "BH"}, {name: "Bangladesh", code: "BD"}, {name: "Barbados", code: "BB"}, {name: "Belarus", code: "BY"}, {name: "Belgium", code: "BE"}, {name: "Belize", code: "BZ"}, {name: "Benin", code: "BJ"}, {name: "Bermuda", code: "BM"}, {name: "Bhutan", code: "BT"}, {name: "Bolivia", code: "BO"}, {name: "Bosnia and Herzegovina", code: "BA"}, {name: "Botswana", code: "BW"}, {name: "Bouvet Island", code: "BV"}, {name: "Brazil", code: "BR"}, {name: "British Indian Ocean Territory", code: "IO"}, {name: "Brunei Darussalam", code: "BN"}, {name: "Bulgaria", code: "BG"}, {name: "Burkina Faso", code: "BF"}, {name: "Burundi", code: "BI"}, {name: "Cambodia", code: "KH"}, {name: "Cameroon", code: "CM"}, {name: "Canada", code: "CA"}, {name: "Cape Verde", code: "CV"}, {name: "Cayman Islands", code: "KY"}, {name: "Central African Republic", code: "CF"}, {name: "Chad", code: "TD"}, {name: "Chile", code: "CL"}, {name: "China", code: "CN"}, {name: "Christmas Island", code: "CX"}, {name: "Cocos (Keeling) Islands", code: "CC"}, {name: "Colombia", code: "CO"}, {name: "Comoros", code: "KM"}, {name: "Congo", code: "CG"}, {name: "Congo, The Democratic Republic of the", code: "CD"}, {name: "Cook Islands", code: "CK"}, {name: "Costa Rica", code: "CR"}, {name: "Cote D'Ivoire", code: "CI"}, {name: "Croatia", code: "HR"}, {name: "Cuba", code: "CU"}, {name: "Cyprus", code: "CY"}, {name: "Czech Republic", code: "CZ"}, {name: "Denmark", code: "DK"}, {name: "Djibouti", code: "DJ"}, {name: "Dominica", code: "DM"}, {name: "Dominican Republic", code: "DO"}, {name: "Ecuador", code: "EC"}, {name: "Egypt", code: "EG"}, {name: "El Salvador", code: "SV"}, {name: "Equatorial Guinea", code: "GQ"}, {name: "Eritrea", code: "ER"}, {name: "Estonia", code: "EE"}, {name: "Ethiopia", code: "ET"}, {name: "Falkland Islands (Malvinas)", code: "FK"}, {name: "Faroe Islands", code: "FO"}, {name: "Fiji", code: "FJ"}, {name: "Finland", code: "FI"}, {name: "France", code: "FR"}, {name: "French Guiana", code: "GF"}, {name: "French Polynesia", code: "PF"}, {name: "French Southern Territories", code: "TF"}, {name: "Gabon", code: "GA"}, {name: "Gambia", code: "GM"}, {name: "Georgia", code: "GE"}, {name: "Germany", code: "DE"}, {name: "Ghana", code: "GH"}, {name: "Gibraltar", code: "GI"}, {name: "Greece", code: "GR"}, {name: "Greenland", code: "GL"}, {name: "Grenada", code: "GD"}, {name: "Guadeloupe", code: "GP"}, {name: "Guam", code: "GU"}, {name: "Guatemala", code: "GT"}, {name: "Guernsey", code: "GG"}, {name: "Guinea", code: "GN"}, {name: "Guinea-Bissau", code: "GW"}, {name: "Guyana", code: "GY"}, {name: "Haiti", code: "HT"}, {name: "Heard Island and Mcdonald Islands", code: "HM"}, {name: "Holy See (Vatican City State)", code: "VA"}, {name: "Honduras", code: "HN"}, {name: "Hong Kong", code: "HK"}, {name: "Hungary", code: "HU"}, {name: "Iceland", code: "IS"}, {name: "India", code: "IN"}, {name: "Indonesia", code: "ID"}, {name: "Iran, Islamic Republic Of", code: "IR"}, {name: "Iraq", code: "IQ"}, {name: "Ireland", code: "IE"}, {name: "Isle of Man", code: "IM"}, {name: "Israel", code: "IL"}, {name: "Italy", code: "IT"}, {name: "Jamaica", code: "JM"}, {name: "Japan", code: "JP"}, {name: "Jersey", code: "JE"}, {name: "Jordan", code: "JO"}, {name: "Kazakhstan", code: "KZ"}, {name: "Kenya", code: "KE"}, {name: "Kiribati", code: "KI"}, {name: "Korea, Democratic People'S Republic of", code: "KP"}, {name: "Korea, Republic of", code: "KR"}, {name: "Kuwait", code: "KW"}, {name: "Kyrgyzstan", code: "KG"}, {name: "Lao People'S Democratic Republic", code: "LA"}, {name: "Latvia", code: "LV"}, {name: "Lebanon", code: "LB"}, {name: "Lesotho", code: "LS"}, {name: "Liberia", code: "LR"}, {name: "Libyan Arab Jamahiriya", code: "LY"}, {name: "Liechtenstein", code: "LI"}, {name: "Lithuania", code: "LT"}, {name: "Luxembourg", code: "LU"}, {name: "Macao", code: "MO"}, {name: "Macedonia, The Former Yugoslav Republic of", code: "MK"}, {name: "Madagascar", code: "MG"}, {name: "Malawi", code: "MW"}, {name: "Malaysia", code: "MY"}, {name: "Maldives", code: "MV"}, {name: "Mali", code: "ML"}, {name: "Malta", code: "MT"}, {name: "Marshall Islands", code: "MH"}, {name: "Mauritania", code: "MR"}, {name: "Mauritius", code: "MU"}, {name: "Mayotte", code: "YT"}, {name: "Mexico", code: "MX"}, {name: "Micronesia, Federated States of", code: "FM"}, {name: "Moldova, Republic of", code: "MD"}, {name: "Monaco", code: "MC"}, {name: "Mongolia", code: "MN"}, {name: "Montserrat", code: "MS"}, {name: "Morocco", code: "MA"}, {name: "Mozambique", code: "MZ"}, {name: "Myanmar", code: "MM"}, {name: "Namibia", code: "NA"}, {name: "Nauru", code: "NR"}, {name: "Nepal", code: "NP"}, {name: "Netherlands", code: "NL"}, {name: "Netherlands Antilles", code: "AN"}, {name: "New Caledonia", code: "NC"}, {name: "New Zealand", code: "NZ"}, {name: "Nicaragua", code: "NI"}, {name: "Niger", code: "NE"}, {name: "Nigeria", code: "NG"}, {name: "Niue", code: "NU"}, {name: "Norfolk Island", code: "NF"}, {name: "Northern Mariana Islands", code: "MP"}, {name: "Norway", code: "NO"}, {name: "Oman", code: "OM"}, {name: "Pakistan", code: "PK"}, {name: "Palau", code: "PW"}, {name: "Palestinian Territory, Occupied", code: "PS"}, {name: "Panama", code: "PA"}, {name: "Papua New Guinea", code: "PG"}, {name: "Paraguay", code: "PY"}, {name: "Peru", code: "PE"}, {name: "Philippines", code: "PH"}, {name: "Pitcairn", code: "PN"}, {name: "Poland", code: "PL"}, {name: "Portugal", code: "PT"}, {name: "Puerto Rico", code: "PR"}, {name: "Qatar", code: "QA"}, {name: "Reunion", code: "RE"}, {name: "Romania", code: "RO"}, {name: "Russian Federation", code: "RU"}, {name: "RWANDA", code: "RW"}, {name: "Saint Helena", code: "SH"}, {name: "Saint Kitts and Nevis", code: "KN"}, {name: "Saint Lucia", code: "LC"}, {name: "Saint Pierre and Miquelon", code: "PM"}, {name: "Saint Vincent and the Grenadines", code: "VC"}, {name: "Samoa", code: "WS"}, {name: "San Marino", code: "SM"}, {name: "Sao Tome and Principe", code: "ST"}, {name: "Saudi Arabia", code: "SA"}, {name: "Senegal", code: "SN"}, {name: "Serbia and Montenegro", code: "CS"}, {name: "Seychelles", code: "SC"}, {name: "Sierra Leone", code: "SL"}, {name: "Singapore", code: "SG"}, {name: "Slovakia", code: "SK"}, {name: "Slovenia", code: "SI"}, {name: "Solomon Islands", code: "SB"}, {name: "Somalia", code: "SO"}, {name: "South Africa", code: "ZA"}, {name: "South Georgia and the South Sandwich Islands", code: "GS"}, {name: "Spain", code: "ES"}, {name: "Sri Lanka", code: "LK"}, {name: "Sudan", code: "SD"}, {name: "Suriname", code: "SR"}, {name: "Svalbard and Jan Mayen", code: "SJ"}, {name: "Swaziland", code: "SZ"}, {name: "Sweden", code: "SE"}, {name: "Switzerland", code: "CH"}, {name: "Syrian Arab Republic", code: "SY"}, {name: "Taiwan", code: "TW"}, {name: "Tajikistan", code: "TJ"}, {name: "Tanzania, United Republic of", code: "TZ"}, {name: "Thailand", code: "TH"}, {name: "Timor-Leste", code: "TL"}, {name: "Togo", code: "TG"}, {name: "Tokelau", code: "TK"}, {name: "Tonga", code: "TO"}, {name: "Trinidad and Tobago", code: "TT"}, {name: "Tunisia", code: "TN"}, {name: "Turkey", code: "TR"}, {name: "Turkmenistan", code: "TM"}, {name: "Turks and Caicos Islands", code: "TC"}, {name: "Tuvalu", code: "TV"}, {name: "Uganda", code: "UG"}, {name: "Ukraine", code: "UA"}, {name: "United Arab Emirates", code: "AE"}, {name: "United Kingdom", code: "GB"}, {name: "United States", code: "US"}, {name: "United States Minor Outlying Islands", code: "UM"}, {name: "Uruguay", code: "UY"}, {name: "Uzbekistan", code: "UZ"}, {name: "Vanuatu", code: "VU"}, {name: "Venezuela", code: "VE"}, {name: "Viet Nam", code: "VN"}, {name: "Virgin Islands, British", code: "VG"}, {name: "Virgin Islands, U.S.", code: "VI"}, {name: "Wallis and Futuna", code: "WF"}, {name: "Western Sahara", code: "EH"}, {name: "Yemen", code: "YE"}, {name: "Zambia", code: "ZM"}, {name: "Zimbabwe", code: "ZW"} ];

        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'info') {
            const toast = App.elements.toast;
            if (!toast) return;
            toast.textContent = message;
            toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#0f172a';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        function getCountryFlagEmoji(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }
        function getLocalTimeData() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const offsetMinutes = now.getTimezoneOffset() * -1;
            const sign = offsetMinutes >= 0 ? '+' : '-';
            const absOffset = Math.abs(offsetMinutes);
            const hours = String(Math.floor(absOffset / 60)).padStart(2, '0');
            const minutes = String(absOffset % 60).padStart(2, '0');
            return { time: timeStr, offset: `UTC${sign}${hours}:${minutes}`, hour: now.getHours() };
        }
        function getFriendlyAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-credential':
                case 'auth/wrong-password':
                    return 'Invalid email or password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Your password must be at least 6 characters long.';
                default:
                    return 'An unexpected error occurred. Please try again.';
            }
        }


        // --- AUTHENTICATION ---
        async function handleEmailSignup(e) {
            e.preventDefault();
            const displayName = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const errorMsg = document.getElementById('error-message');
            errorMsg.textContent = '';

            if (!displayName || !email || password.length < 6) {
                errorMsg.textContent = 'Please fill all fields. Password must be at least 6 characters.';
                return;
            }

            try {
                const result = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(result.user, { displayName });
                await initializeNewUser(result.user, { displayName });
            } catch (error) {
                errorMsg.textContent = getFriendlyAuthError(error.code);
            }
        }
        
        async function handleGoogleLogin() {
             const provider = new GoogleAuthProvider();
             try {
                const result = await signInWithPopup(auth, provider);
                await initializeNewUser(result.user);
             } catch (error) {
                const errorMsg = document.getElementById('error-message');
                errorMsg.textContent = getFriendlyAuthError(error.code);
             }
        }
        
        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorMsg = document.getElementById('error-message');
            errorMsg.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorMsg.textContent = getFriendlyAuthError(error.code);
            }
        }

        function handleLogout() {
            signOut(auth);
        }

        onAuthStateChanged(auth, async (user) => {
            const wasLoggedIn = !!App.currentUser;
            App.currentUser = user ? { email: user.email, displayName: user.displayName, userId: user.uid } : null;
            const isLoggedIn = !!App.currentUser;

            if (isLoggedIn) {
                await setupUserSession();
            }

            if (!isAuthResolved) {
                isAuthResolved = true;
                hashChangeRouter(); 
            }
            
            if (isLoggedIn && !wasLoggedIn) {
                const redirectTarget = sessionStorage.getItem('redirectAfterLogin');
                sessionStorage.removeItem('redirectAfterLogin');
                navigateTo(redirectTarget || 'profilePage', true);
            } else if (!isLoggedIn && wasLoggedIn) {
                App.currentProfileData = null;
                clearInterval(timetableCheckInterval);
                navigateTo('loginPage', true);
            }
        });


        // --- DATABASE INTERACTIONS & CORE LOGIC ---
        async function initializeNewUser(user, additionalData = {}) {
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);

            if (!snapshot.exists()) {
                const today = new Date().toISOString().split('T')[0];
                const displayName = additionalData.displayName || user.displayName || "New User";
                const defaultPfpText = displayName.charAt(0).toUpperCase();

                const initialProfile = { 
                    displayName: displayName, 
                    email: user.email, 
                    createdAt: new Date().toISOString(),
                    status: 'üü¢', 
                    message: 'Just getting started!', 
                    theme: 'auto', 
                    role: 'Member',
                    membershipTier: 'Member',
                    verified: false,
                    pfpText: defaultPfpText,
                    achievements: { 
                        profileComplete: 0, scheduler: 0, socialButterfly: 0, firstShare: 0,
                        views: 0, loyalUser: 1, expressive: 0, referral: 0,
                        loginHistory: { [today]: true },
                        usedEmojis: {}
                    }, 
                    updatedAt: new Date().toISOString() 
                };
                await set(userRef, initialProfile);
                
                const referrerId = sessionStorage.getItem('referrerId');
                if (referrerId && referrerId !== user.uid) {
                    const referrerRef = ref(db, `users/${referrerId}/achievements/referral`);
                    const referrerSnap = await get(referrerRef);
                    await set(referrerRef, (referrerSnap.val() || 0) + 1);
                    sessionStorage.removeItem('referrerId');
                }
            }
        }

        async function setupUserSession() {
            if (!App.currentUser) return;
            if (timetableCheckInterval) clearInterval(timetableCheckInterval);
            try {
                const userRef = ref(db, `users/${App.currentUser.userId}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    App.currentProfileData = data;
                    
                    const today = new Date().toISOString().split('T')[0];
                    const loginHistory = data.achievements?.loginHistory || {};
                    if (!loginHistory[today]) {
                       const updates = {};
                       updates[`achievements/loginHistory/${today}`] = true;
                       updates['achievements/loyalUser'] = Object.keys(loginHistory).length + 1;
                       await update(userRef, updates);
                       App.currentProfileData.achievements.loyalUser = updates['achievements/loyalUser'];
                       App.currentProfileData.achievements.loginHistory = {...loginHistory, [today]: true};
                    }

                    applyVisuals(data);
                    populateSettings(data);
                    
                    document.getElementById('admin-nav-btn').classList.toggle('hidden', data.role !== 'Owner');

                    await checkTimetableAndApplyStatus();
                    timetableCheckInterval = setInterval(checkTimetableAndApplyStatus, 60000);
                } else {
                    await initializeNewUser(auth.currentUser);
                    const newSnapshot = await get(userRef);
                    if(newSnapshot.exists()){
                        App.currentProfileData = newSnapshot.val();
                        applyVisuals(App.currentProfileData);
                        populateSettings(App.currentProfileData);
                    } else {
                        throw new Error("Failed to create and retrieve user profile after initialization.");
                    }
                }
            } catch (error) {
                console.error("Failed to load user data:", error);
                showToast("Failed to load user data.", "error");
            }
        }
        
        async function displayPublicProfile(userId) {
            try {
                const userRef = ref(db, `users/${userId}`);
                const snapshot = await get(userRef);
                let userData = snapshot.val();
                if (userData) {
                    userData.userId = userId;
                    
                    let orgData = null;
                    if(userData.organizationId) {
                        const orgSnap = await get(ref(db, `organizations/${userData.organizationId}`));
                        orgData = orgSnap.val();
                    }
                    
                    applyVisuals(userData, orgData); 
                    
                    const activeSchedule = findActiveSchedule(userData);
                    if (activeSchedule) {
                        userData.status = activeSchedule.status;
                        userData.message = activeSchedule.message;
                    }
                    App.currentProfileData = userData; 
                    
                    renderProfile(userData, orgData);

                    if (!App.currentUser || App.currentUser.userId !== userId) {
                        trackProfileView(userId);
                    }
                } else {
                    document.body.className = '';
                    document.getElementById('profile-name').textContent = 'User Not Found';
                    document.getElementById('profile-emoji').textContent = '‚ùå';
                    document.getElementById('profile-message').textContent = 'Profile is missing or deleted.';
                }
            } catch (error) {
                document.getElementById('profile-name').textContent = 'Error loading profile.';
                console.error("Error loading public profile:", error);
            }
        }
        
        async function saveAndLogStatus(data) {
            const dataWithTimestamp = { ...data, updatedAt: new Date().toISOString() };
            const userRef = ref(db, `users/${App.currentUser.userId}`);
            
            if(data.displayName !== auth.currentUser.displayName) {
                 await updateProfile(auth.currentUser, { displayName: data.displayName });
                 App.currentUser.displayName = data.displayName;
                 if (!data.pfpUrl) dataWithTimestamp.pfpText = data.displayName.charAt(0).toUpperCase();
            }

            const achievements = App.currentProfileData.achievements || {};
            const achievementUpdates = {};

            const newEmoji = data.status;
            const newUsedEmojis = achievements.usedEmojis || {};
            if (!newUsedEmojis[newEmoji]) {
                newUsedEmojis[newEmoji] = true;
                achievementUpdates['achievements/usedEmojis'] = newUsedEmojis;
                achievementUpdates['achievements/expressive'] = Object.keys(newUsedEmojis).length;
            }

            achievementUpdates['achievements/socialButterfly'] = data.links?.length || 0;

            const isMaxComplete = data.bio && data.birthday && data.countryCode && data.phone && data.schedulingLink && data.pfpUrl;
            if (isMaxComplete) {
                achievementUpdates['achievements/profileComplete'] = 2; 
            } else if (data.bio && data.birthday && data.countryCode) {
                achievementUpdates['achievements/profileComplete'] = 1; 
            } else {
                achievementUpdates['achievements/profileComplete'] = 0;
            }

            await update(userRef, { ...dataWithTimestamp, ...achievementUpdates });

            const historyRef = ref(db, `history/${App.currentUser.userId}`);
            await push(historyRef, { status: data.status, message: data.message, timestamp: dataWithTimestamp.updatedAt });
            
            const snapshot = await get(userRef);
            App.currentProfileData = snapshot.val() || {};
            
            applyVisuals(App.currentProfileData);
            renderProfile(App.currentProfileData);
            
            await updateMembershipTier(App.currentUser.userId);
            
            showToast('Settings Saved & Status Updated! üíæ');
            navigateTo('profilePage');
        }

        // --- ROUTING & NAVIGATION ---
        function navigateTo(pageId, isInternal = false) {
            const currentHash = window.location.hash.substring(1);
            if (pageId === currentHash && !isInternal) return;

            if (isInternal) {
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.pushState({}, '', cleanUrl);
            }
            window.location.hash = pageId;
        }

        async function hashChangeRouter() {
            clearInterval(countdownInterval);
            if(publicViewInterval) clearInterval(publicViewInterval);
            
            if (!isAuthResolved) return;

            const params = new URLSearchParams(window.location.search);
            const userIdFromUrl = params.get('user');
            const orgIdFromUrl = params.get('org');
            const refIdFromUrl = params.get('ref');
            
            if(refIdFromUrl && !App.currentUser) {
                sessionStorage.setItem('referrerId', refIdFromUrl);
            }

            if (userIdFromUrl || orgIdFromUrl) {
                isPublicView = true;
                
                App.pages.forEach(pId => App.elements[pId]?.classList.remove('active'));
                
                document.body.style.paddingBottom = "20px";
                App.elements.mainHeader?.classList.add('hidden');
                
                if (userIdFromUrl) {
                    App.elements.profilePage?.classList.add('active');
                    await displayPublicProfile(userIdFromUrl);
                    publicViewInterval = setInterval(() => displayPublicProfile(userIdFromUrl), 30000);
                }
                if(orgIdFromUrl) {
                    App.elements.organizationsPage?.classList.add('active');
                    await renderOrganizationsPage(orgIdFromUrl);
                }

                const promoCard = document.getElementById('create-hap-promo');
                const tier = App.currentProfileData?.membershipTier;
                const isOrgVerified = App.currentProfileData?.type === 'org' && App.currentProfileData?.verified;

                if (promoCard) {
                    promoCard.classList.toggle('hidden', tier === 'Max' || tier === 'Owner' || isOrgVerified);
                    const promoBtn = document.getElementById('promo-action-btn');
                    if (App.currentUser) {
                        if (App.currentUser.userId === userIdFromUrl) {
                            promoCard.classList.add('hidden');
                        } else {
                            promoBtn.textContent = 'Go to My Dashboard';
                            promoBtn.onclick = () => navigateTo('profilePage', true);
                        }
                    } else {
                        promoBtn.textContent = 'Get Started Now';
                        promoBtn.onclick = () => navigateTo('loginPage', true);
                    }
                }
                return;
            }
            
            isPublicView = false;
            document.getElementById('create-hap-promo')?.classList.add('hidden');
            document.body.style.paddingBottom = "100px";

            const hash = window.location.hash.substring(1);
            let targetPageId = App.pages.includes(hash) ? hash : (App.currentUser ? 'profilePage' : 'loginPage');
            
            if (!App.currentUser && targetPageId !== 'loginPage' && targetPageId !== 'searchPage') {
                sessionStorage.setItem('redirectAfterLogin', targetPageId);
                targetPageId = 'loginPage';
            }

            if (App.currentUser) {
                if (targetPageId === 'adminPage' && App.currentProfileData.role !== 'Owner') {
                    targetPageId = 'profilePage';
                }

                if(targetPageId === 'profilePage' && App.currentProfileData) {
                    const orgSnap = App.currentProfileData.organizationId ? await get(ref(db, `organizations/${App.currentProfileData.organizationId}`)) : null;
                    renderProfile(App.currentProfileData, orgSnap?.val());
                } else if (targetPageId === 'analyticsPage') {
                    await fetchAndRenderAnalytics();
                } else if (targetPageId === 'tiersPage') {
                    renderTiersPage();
                } else if (targetPageId === 'adminPage') {
                    renderAdminPanel();
                } else if (targetPageId === 'organizationsPage') {
                    await renderOrganizationsPage();
                }
            } else if (targetPageId === 'searchPage') {
                document.getElementById('search-results-list').innerHTML = '<p class="muted">Search for users by name or click \'Search\' to view all public profiles.</p>';
            }
            
            App.pages.forEach(pId => App.elements[pId]?.classList.toggle('active', pId === targetPageId));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === targetPageId));
            App.elements.mainHeader?.classList.toggle('hidden', !App.currentUser || targetPageId === 'loginPage');
            window.scrollTo(0, 0);
        }

        // --- UI RENDERING & DOM MANIPULATION ---
        function applyVisuals(userData, orgData = null) {
            if (!userData) return;
            const theme = userData.theme || 'auto';
            const timeData = getLocalTimeData();
            const isNight = timeData.hour >= 20 || timeData.hour < 6;
            
            document.body.className = (theme === 'dark' || (theme === 'auto' && isNight)) ? 'dark' : '';
            
            const accent = orgData?.brandColor || userData.profileAccentColor || '#0ea5e9';
            document.documentElement.style.setProperty('--primary', accent);
            document.documentElement.style.setProperty('--primary-dark', document.body.classList.contains('dark') ? '#7dd3fc' : '#0369a1'); 
            document.documentElement.style.setProperty('--link-text-color', userData.linkTextColor || '#0369a1');
            document.documentElement.style.setProperty('--display-font', userData.displayNameFont || 'Inter, sans-serif');
            
            const pfpElement = document.getElementById('profile-pfp');
            if(pfpElement) {
                if (userData.pfpUrl) {
                    pfpElement.style.backgroundImage = `url(${userData.pfpUrl})`;
                    pfpElement.textContent = '';
                } else if (userData.pfpText) {
                    pfpElement.style.backgroundImage = 'none';
                    pfpElement.textContent = userData.pfpText;
                } else {
                    pfpElement.style.backgroundImage = 'none';
                    pfpElement.textContent = '';
                }
                
                pfpElement.style.backgroundColor = isNight ? '#1e293b' : 'var(--primary-light)';
                pfpElement.style.borderColor = accent;
            }

            const bannerEl = document.getElementById('org-banner');
            if(bannerEl) {
                bannerEl.style.backgroundImage = orgData?.verified && orgData.bannerUrl ? `url(${orgData.bannerUrl})` : 'none';
                bannerEl.style.backgroundColor = orgData?.verified ? orgData.brandColor || 'var(--input-bg)' : 'var(--input-bg)';
            }
        }

        function renderProfile(data, orgData = null) {
            if (!data) return;
            const profileNameEl = document.getElementById('profile-name');
            const membershipEl = document.getElementById('membership-tier-display');
            const name = data.displayName || 'Unnamed User';

            profileNameEl.innerHTML = name;

            const orgVerifiedIcon = `<svg class="inline-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.97 4.27a2.25 2.25 0 0 0-1.94 0l-7.5 4.22a2.25 2.25 0 0 0-1.16 1.95v7.22c0 .98.623 1.822 1.524 2.148l6.75 2.455a2.25 2.25 0 0 0 2.252 0l6.75-2.455A2.25 2.25 0 0 0 21.75 17.7v-7.22a2.25 2.25 0 0 0-1.16-1.95l-7.5-4.22ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75ZM12 16.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"></path></svg>`;
            const userVerifiedIcon = `<svg class="inline-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.06-1.06l-3.103 3.103-1.53-1.53a.75.75 0 0 0-1.06 1.06l2.06 2.06a.75.75 0 0 0 1.06 0l3.64-3.64Z" clip-rule="evenodd" /></svg>`;

            if (data.verified) {
                profileNameEl.innerHTML += userVerifiedIcon;
            } else if (orgData?.verified) {
                profileNameEl.innerHTML += orgVerifiedIcon;
            }

            const tier = data.role === 'Owner' ? 'Owner' : (data.membershipTier || 'Member');
            membershipEl.textContent = TIER_CONFIG[tier]?.name || tier;
            membershipEl.className = 'membership-badge';
            membershipEl.classList.add(`tier-${tier}`);

            document.getElementById('profile-emoji').textContent = data.status || '‚ùì';
            document.getElementById('profile-message').textContent = data.message || 'No message set.';
            
            renderPersonalDetails(data, orgData);
            const timeData = getLocalTimeData();
            document.getElementById('local-time-info').textContent = `Local Time: ${timeData.time} (${timeData.offset})`;

            renderCustomLinks(data.links, document.getElementById('profile-links'));
            renderActionLinks(data);
        }

        function findActiveSchedule(user) {
            if (!user || !user.timetable || user.timetable.length === 0) return null;
            const now = new Date();
            const currentDay = now.getDay();
            const currentTimeInMinutes = now.getHours() * 60 + now.getMinutes();
            return user.timetable.find(entry => entry.day === currentDay && currentTimeInMinutes >= timeToMinutes(entry.start) && currentTimeInMinutes < timeToMinutes(entry.end));
        }
        
        function renderPersonalDetails(data, orgData = null) {
            const container = document.getElementById('personal-details-list');
            if (!container) return;
            let detailsHtml = '';
            
            const addDetail = (label, value) => {
                if (value) detailsHtml += `<div class="personal-detail-item"><strong>${label}:</strong> ${value}</div>`;
            };

            if (data.countryCode) {
                const country = COUNTRY_LIST.find(c => c.code === data.countryCode);
                if (country) {
                    detailsHtml += `<div class="personal-detail-item profile-country"><span class="flag-emoji">${getCountryFlagEmoji(country.code)}</span> ${country.name}</div>`;
                }
            }
            if(orgData){
                const orgLink = `<a href="?org=${data.organizationId}">${orgData.name}</a>`;
                addDetail('Organization', orgLink);
            }
            addDetail('Bio', data.bio);
            if(isPublicView && orgData?.verified){
                addDetail('Organization Phone', orgData.phone ? `<a href="tel:${orgData.phone}">${orgData.phone}</a>` : null);
                addDetail('Organization Email', orgData.email ? `<a href="mailto:${orgData.email}">${orgData.email}</a>` : null);
            } else {
                if(!isPublicView || (App.currentUser && App.currentUser.userId === data.userId)) {
                    addDetail('Phone', data.phone ? `<a href="tel:${data.phone}">${data.phone}</a>` : null);
                    addDetail('Email', data.email ? `<a href="mailto:${data.email}">${data.email}</a>` : null);
                }
            }

            container.innerHTML = detailsHtml || '<p class="muted">No public details shared.</p>';
        }

        async function checkTimetableAndApplyStatus() {
            if (!App.currentUser || !App.currentProfileData) return;
            const data = App.currentProfileData;
            
            const activeSchedule = findActiveSchedule(data);
            if (activeSchedule) {
                if (data.status !== activeSchedule.status || data.message !== activeSchedule.message) {
                    const statusUpdate = { 
                        status: activeSchedule.status, 
                        message: activeSchedule.message,
                    };
                    await update(ref(db, `users/${App.currentUser.userId}`), statusUpdate);
                    showToast(`Timetable activated: ${statusUpdate.status}`);
                    App.currentProfileData.status = statusUpdate.status;
                    App.currentProfileData.message = statusUpdate.message;
                    renderProfile(App.currentProfileData);
                }
            }
        }
        
        function renderCustomLinks(links, container) {
            if (!container) return;
            container.innerHTML = '';
            const validLinks = links ? links.filter(l => l && l.url && l.label) : [];
            
            if (validLinks.length === 0) {
                container.innerHTML = '<p class="muted">No links provided.</p>';
                return;
            }
            let html = '';
            validLinks.forEach(link => {
                html += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="custom-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg><span>${link.label}</span></a>`;
            });
            container.innerHTML = html;
        }
        
        function renderActionLinks(data) {
            const container = document.getElementById('profile-action-links');
            if (!container) return;
            container.innerHTML = '';
            let html = '';
            if (data.schedulingLink) html += `<a href="${data.schedulingLink}" target="_blank" rel="noopener noreferrer" class="btn secondary" style="max-width: 250px;">Book a Meeting</a>`;
            container.innerHTML = html;
        }

        function populateSettings(data) {
            if (!data || !document.getElementById('display-name')) return;
            const tier = data.membershipTier || 'Member';
            const tierConfig = TIER_CONFIG[tier] || TIER_CONFIG['Member'];

            document.getElementById('display-name').value = data.displayName || '';
            document.getElementById('themeSelect').value = data.theme || 'auto';
            document.getElementById('display-font').value = data.displayNameFont || 'Inter, sans-serif';
            document.getElementById('accent-color').value = data.profileAccentColor || '#0ea5e9';
            document.getElementById('link-text-color').value = data.linkTextColor || '#0369a1';
            document.getElementById('scheduling-link').value = data.schedulingLink || '';
            document.getElementById('bio').value = data.bio || '';
            document.getElementById('birthday').value = data.birthday || '';
            document.getElementById('phone-number').value = data.phone || '';
            
            const countrySearch = document.getElementById('country-search'), countryCodeInput = document.getElementById('country-code');
            if(data.countryCode) {
                const country = COUNTRY_LIST.find(c => c.code === data.countryCode);
                if (country) { countrySearch.value = `${getCountryFlagEmoji(country.code)} ${country.name}`; countryCodeInput.value = country.code; }
            } else { countrySearch.value = ''; countryCodeInput.value = ''; }
            
            document.getElementById('font-customization-field').classList.toggle('form-field-disabled', !tierConfig.customFont);
            document.getElementById('scheduling-link-field').classList.toggle('form-field-disabled', !tierConfig.scheduling);
            document.getElementById('accent-color-field').classList.toggle('form-field-disabled', !tierConfig.customColor);
            document.getElementById('link-text-color-field').classList.toggle('form-field-disabled', !tierConfig.customColor);
            document.getElementById('automatic-timetable-card').classList.toggle('form-field-disabled', !tierConfig.timetable);
            document.getElementById('analytics-nav-btn').classList.toggle('hidden', !tierConfig.analytics && data.role !== 'Owner');
            
            const linksContainer = document.getElementById('custom-links-container');
            linksContainer.innerHTML = '';
            const linkLimit = tierConfig.linkLimit;
            for (let i = 0; i < linkLimit; i++) {
                const link = data.links ? data.links[i] : null;
                linksContainer.innerHTML += `<div class="link-group"><input type="text" id="link-label-${i}" placeholder="Link Label ${i + 1}" value="${link?.label || ''}"><input type="url" id="link-url-${i}" placeholder="URL (https://...)" value="${link?.url || ''}"></div>`;
            }
            if (tier !== 'Max' && tier !== 'Owner') {
                linksContainer.innerHTML += `<p class="muted">Upgrade your tier to add more links!</p>`;
            }
            
            document.getElementById('status-emoji').value = data.status || 'üü¢';
            document.getElementById('status-message').value = data.message || '';

            renderTimetableSettings(data.timetable);
            renderVerificationSettings(data);
        }

        // --- EVENT HANDLERS & INITIALIZATION ---
        function handlePageLoad() {
            App.pages.forEach(pId => App.elements[pId] = document.getElementById(pId));
            App.elements.mainHeader = document.getElementById('mainHeader');
            App.elements.toast = document.getElementById('toast');
            
            window.addEventListener('hashchange', hashChangeRouter);
            addEventListeners();
        }
        
        async function handleDeleteAccount() {
             if (!App.currentUser) return;
             const confirmation = confirm("Are you sure you want to permanently delete your account and all associated data? This action cannot be undone.");
             if (!confirmation) return showToast("Account deletion cancelled.");
            
             const userId = App.currentUser.userId;
             const user = auth.currentUser;

             if (!user) return showToast("Error: No authenticated user found.", "error");

             try {
                await set(ref(db, `users/${userId}`), null);
                await set(ref(db, `history/${userId}`), null);
                await set(ref(db, `analytics/${userId}`), null);
                
                if(App.currentProfileData.organizationId) {
                    await set(ref(db, `organizations/${App.currentProfileData.organizationId}/members/${userId}`), null);
                }
                
                await deleteUser(user);
                showToast("Account successfully deleted. üëã");
             } catch (error) {
                console.error("Account Deletion Error:", error);
                if (error.code === 'auth/requires-recent-login') {
                    showToast("Security Alert: Please log in again to confirm this action.", "error");
                    handleLogout(); 
                } else {
                    showToast(`Deletion failed: ${error.message}`, "error");
                }
             }
        }
        
        async function handleSaveSettings() {
            if (!App.currentUser) return;
            const saveBtn = document.getElementById('save-settings-btn');
            saveBtn.textContent = 'Saving...';
            saveBtn.classList.add('btn-loading');

            const tier = App.currentProfileData.membershipTier || 'Member';
            const linkLimit = TIER_CONFIG[tier]?.linkLimit || 1;
            
            const customLinks = [];
            for (let i = 0; i < linkLimit; i++) {
                const label = document.getElementById(`link-label-${i}`)?.value.trim();
                const url = document.getElementById(`link-url-${i}`)?.value.trim();
                if (label && url) {
                   customLinks.push({ label, url });
                }
            }
            
            const dataToSave = {
                displayName: document.getElementById('display-name').value, 
                theme: document.getElementById('themeSelect').value,
                displayNameFont: document.getElementById('display-font').value,
                profileAccentColor: document.getElementById('accent-color').value, 
                linkTextColor: document.getElementById('link-text-color').value,
                schedulingLink: document.getElementById('scheduling-link').value, 
                bio: document.getElementById('bio').value,
                birthday: document.getElementById('birthday').value,
                countryCode: document.getElementById('country-code').value,
                phone: document.getElementById('phone-number').value,
                status: document.getElementById('status-emoji').value,
                message: document.getElementById('status-message').value,
                links: customLinks
            };
            
            try {
                const pfpFile = document.getElementById('pfp-upload').files[0];
                if (pfpFile) {
                    const pfpRef = storageRef(storage, `pfps/${App.currentUser.userId}/${pfpFile.name}`);
                    await uploadBytes(pfpRef, pfpFile);
                    dataToSave.pfpUrl = await getDownloadURL(pfpRef);
                    dataToSave.pfpText = null;
                }
                await saveAndLogStatus(dataToSave); 
                populateSettings(App.currentProfileData); 
            } catch (error) {
                console.error("Save settings error:", error);
                showToast("Failed to save settings.", "error");
            } finally {
                saveBtn.textContent = 'Save All Changes';
                saveBtn.classList.remove('btn-loading');
            }
        }

        function handleGenerateQrCode() {
            if (!App.currentUser) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?user=${App.currentUser.userId}`;
            const img = document.getElementById('profile-qrcode-img'), placeholder = document.getElementById('qrcode-placeholder');
            img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;
            img.onload = () => { img.style.display = 'block'; placeholder.classList.add('hidden'); showToast('QR Code generated! üñºÔ∏è'); };
        }
        function handleShareStatus() {
            if (!App.currentUser) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?user=${App.currentUser.userId}&ref=${App.currentUser.userId}`;
            navigator.clipboard.writeText(shareUrl).then(() => showToast('Profile link copied to clipboard! üîó'));
            
            if (!App.currentProfileData.achievements.firstShare) {
                update(ref(db, `users/${App.currentUser.userId}/achievements`), { firstShare: 1 });
            }
        }
        function renderTimetableSettings(timetable = []) {
            const container = document.getElementById('timetable-entries-container');
            container.innerHTML = (!timetable || timetable.length === 0) ? '<p class="muted" id="no-timetable-message">No scheduled entries yet.</p>' : '';
            if (timetable && timetable.length > 0) document.getElementById('no-timetable-message')?.remove();
            
            timetable.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'timetable-entry-card';
                entryDiv.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><strong>${entry.status} ${entry.message || ''}</strong><button data-index="${index}" class="remove-timetable-btn btn secondary" style="padding: 5px 10px; width: auto; font-size: 0.8rem;">Remove</button></div><p style="color: var(--primary);">${DAYS_OF_WEEK[entry.day]} ${entry.start} - ${entry.end}</p>`;
                container.appendChild(entryDiv);
            });
            document.querySelectorAll('.remove-timetable-btn').forEach(btn => btn.addEventListener('click', handleRemoveTimetableEntry));
        }
        async function handleAddTimetableEntry() {
            const day = parseInt(prompt("Enter Day (0=Sun, 1=Mon...):"), 10);
            if (isNaN(day) || day < 0 || day > 6) return showToast("Invalid day.");
            const start = prompt("Start Time (HH:MM 24hr):"), end = prompt("End Time (HH:MM 24hr):"), status = prompt("Status Emoji:");
            if (!start || !end || !status) return showToast("All fields required.");
            const newEntry = { day, start, end, status, message: prompt("Message:") || '' };
            const newTimetable = [...(App.currentProfileData.timetable || []), newEntry];
            
            const userRef = ref(db, `users/${App.currentUser.userId}`);
            await update(userRef, { timetable: newTimetable });
            
            App.currentProfileData.timetable = newTimetable;
            renderTimetableSettings(newTimetable); showToast("Schedule added! üóìÔ∏è");

            const newSchedulerCount = newTimetable.length;
            update(ref(db, `users/${App.currentUser.userId}/achievements`), { scheduler: newSchedulerCount });
        }
        async function handleRemoveTimetableEntry(e) {
            const index = parseInt(e.currentTarget.dataset.index, 10);
            const newTimetable = App.currentProfileData.timetable.filter((_, i) => i !== index);

            const userRef = ref(db, `users/${App.currentUser.userId}`);
            await update(userRef, { timetable: newTimetable });

            App.currentProfileData.timetable = newTimetable;
            renderTimetableSettings(newTimetable); showToast("Schedule removed.");
            
            const newSchedulerCount = newTimetable.length;
            update(ref(db, `users/${App.currentUser.userId}/achievements`), { scheduler: newSchedulerCount });
        }
        
        async function fetchAndRenderAnalytics() {
            if (!App.currentUser) return;
            const userId = App.currentUser.userId;
            const historyLog = document.getElementById('history-log');

            try {
                const historyQuery = query(ref(db, `history/${userId}`), orderByKey(), limitToLast(10));
                const snapshot = await get(historyQuery);
                const historyData = snapshot.val();
                
                historyLog.innerHTML = '';
                if (historyData) {
                    const historyList = Object.values(historyData).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    historyList.forEach(item => {
                        const date = new Date(item.timestamp);
                        historyLog.innerHTML += `<div class="history-item"><span class="history-status">${item.status} ${item.message || ''}</span><span class="history-time">${date.toLocaleTimeString()} - ${date.toLocaleDateString()}</span></div>`;
                    });
                } else { historyLog.innerHTML = '<p class="muted">No status history found.</p>'; }
            } catch (error) { historyLog.innerHTML = '<p class="muted">Error loading history.</p>'; }
            
            const totalViews = App.currentProfileData.achievements.views || 0;
            document.getElementById('views-total').textContent = totalViews;
            document.getElementById('views-today').textContent = 'N/A'; // Simplified for demo
            document.getElementById('views-week').textContent = 'N/A';
            document.getElementById('views-month').textContent = 'N/A';
        }

        async function handleSearchUsers() {
            const queryText = document.getElementById('user-search-input').value.toLowerCase().trim();
            const resultsList = document.getElementById('search-results-list');
            resultsList.innerHTML = '<p class="muted">Searching...</p>';

            try {
                const usersSnap = await get(ref(db, 'users'));
                const allUsers = usersSnap.val() || {};

                const orgsSnap = await get(ref(db, 'organizations'));
                const allOrgs = orgsSnap.val() || {};
                
                let results = [];
                
                for (const userId in allUsers) {
                    const user = allUsers[userId];
                    if (user.displayName && (!queryText || user.displayName.toLowerCase().includes(queryText))) {
                        results.push({ type: 'user', id: userId, ...user });
                    }
                }
                for (const orgId in allOrgs) {
                    const org = allOrgs[orgId];
                    if (org.name && (!queryText || org.name.toLowerCase().includes(queryText))) {
                        results.push({ type: 'org', id: orgId, ...org });
                    }
                }
                
                const rank = { 'Owner': 0, 'Max': 1, 'VIP': 2, 'MemberPlus': 3, 'Member': 4 };
                results.sort((a, b) => {
                    const prioA = a.type === 'org' && a.verified ? -2 : (a.type === 'user' && a.role === 'Owner' ? -1 : rank[a.membershipTier]);
                    const prioB = b.type === 'org' && b.verified ? -2 : (b.type === 'user' && b.role === 'Owner' ? -1 : rank[b.membershipTier]);
                    if (prioA !== prioB) return prioA - prioB;
                    return (a.displayName || a.name).localeCompare(b.displayName || b.name);
                });

                if (results.length > 0) {
                    resultsList.innerHTML = results.map(item => {
                        if (item.type === 'user') {
                            const userVerifiedIcon = `<svg class="inline-verified-icon" style="width:20px; height:20px;" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.06-1.06l-3.103 3.103-1.53-1.53a.75.75 0 0 0-1.06 1.06l2.06 2.06a.75.75 0 0 0 1.06 0l3.64-3.64Z" clip-rule="evenodd" /></svg>`;
                            const tierName = item.role === 'Owner' ? 'Owner' : (item.membershipTier || 'Member');
                            const tierClass = tierName;
                            const verifiedTick = item.verified ? userVerifiedIcon : '';
                            return `<div class="search-result-item">
                                        <div>
                                            <div style="display: flex; align-items: center;">
                                                <strong style="font-size: 1.1rem;">${item.displayName}</strong>${verifiedTick}
                                            </div>
                                            <div style="display:flex; gap: 8px; margin-top: 4px;">
                                                <div class="membership-badge tier-${tierClass}" style="font-size: 0.7rem; padding: 2px 8px;">${TIER_CONFIG[tierName]?.name || tierName}</div>
                                                <span style="font-size: 0.9rem; color: var(--muted);">${item.status} ${item.message || ''}</span>
                                            </div>
                                        </div>
                                        <a href="?user=${item.id}" class="btn secondary" style="padding: 8px 12px; width: auto; font-size: 0.9rem;">View</a>
                                    </div>`;
                        }
                        if (item.type === 'org') {
                            const orgVerifiedIcon = `<svg class="inline-verified-icon" style="width:20px; height:20px;" viewBox="0 0 24 24" fill="currentColor"><path d="M12.97 4.27a2.25 2.25 0 0 0-1.94 0l-7.5 4.22a2.25 2.25 0 0 0-1.16 1.95v7.22c0 .98.623 1.822 1.524 2.148l6.75 2.455a2.25 2.25 0 0 0 2.252 0l6.75-2.455A2.25 2.25 0 0 0 21.75 17.7v-7.22a2.25 2.25 0 0 0-1.16-1.95l-7.5-4.22Z"></path></svg>`;
                            const verifiedTick = item.verified ? orgVerifiedIcon : '';
                            return `<div class="search-result-item">
                                        <div>
                                            <div style="display: flex; align-items: center;">
                                                <strong style="font-size: 1.1rem;">${item.name}</strong>${verifiedTick}
                                            </div>
                                            <p class="muted" style="margin: 4px 0 0 0;">${item.tagline || 'Organization'}</p>
                                        </div>
                                        <a href="?org=${item.id}" class="btn secondary" style="padding: 8px 12px; width: auto; font-size: 0.9rem;">View Page</a>
                                    </div>`;
                        }
                    }).join('');
                } else { resultsList.innerHTML = '<p class="muted">No results found.</p>'; }
            } catch(e) { 
                resultsList.innerHTML = '<p class="muted">Error performing search.</p>'; 
                console.error(e);
            }
        }

        async function trackProfileView(profileId) {
             try {
                let visitorId = localStorage.getItem('hapVisitorId');
                if (!visitorId) {
                    visitorId = 'visitor_' + Date.now() + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('hapVisitorId', visitorId);
                }
                const today = new Date().toISOString().split('T')[0];
                const viewRef = ref(db, `analytics/${profileId}/viewsByDay/${today}/${visitorId}`);
                const snapshot = await get(viewRef);
                
                if (!snapshot.exists()) {
                    await set(viewRef, true);
                    const totalViewsRef = ref(db, `users/${profileId}/achievements/views`);
                    const totalViewsSnap = await get(totalViewsRef);
                    await set(totalViewsRef, (totalViewsSnap.val() || 0) + 1);
                }
             } catch (error) { console.error("Failed to track profile view:", error); }
        }

        function filterCountries() {
            const searchTerm = document.getElementById('country-search').value.toLowerCase();
            const dropdown = document.getElementById('country-dropdown');
            dropdown.innerHTML = '';
            COUNTRY_LIST.filter(c => c.name.toLowerCase().includes(searchTerm)).slice(0, 50).forEach(country => {
                const option = document.createElement('div');
                option.className = 'country-option';
                option.innerHTML = `<span class="flag-emoji">${getCountryFlagEmoji(country.code)}</span> <span>${country.name}</span>`;
                option.onclick = () => {
                    document.getElementById('country-search').value = `${getCountryFlagEmoji(country.code)} ${country.name}`;
                    document.getElementById('country-code').value = country.code;
                    dropdown.classList.add('hidden');
                };
                dropdown.appendChild(option);
            });
        }
        
        // --- FEATURE IMPLEMENTATIONS: Tiers, Verification, Orgs ---
        async function updateMembershipTier(userId) {
            const userRef = ref(db, `users/${userId}`);
            const snap = await get(userRef);
            if (!snap.exists()) return;
            const data = snap.val();
            const achievements = data.achievements || {};
            let newTier = 'Member';

            const isProfileComplete = (achievements.profileComplete || 0) >= 1;
            
            const check = (reqs) => reqs.every(req => {
                if (req.id === 'profileComplete') {
                    return isProfileComplete;
                }
                return (achievements[req.id] || 0) >= req.goal;
            });

            if (check(ACHIEVEMENT_CONFIG.toMemberPlus)) newTier = 'MemberPlus';
            if (newTier === 'MemberPlus' && check(ACHIEVEMENT_CONFIG.toVIP)) newTier = 'VIP';
            if (newTier === 'VIP' && check(ACHIEVEMENT_CONFIG.toMax)) newTier = 'Max';
            
            if (data.role === 'Owner') newTier = 'Owner';

            if (data.membershipTier !== newTier) {
                await update(userRef, { membershipTier: newTier });
                if(userId === App.currentUser?.userId) showToast(`Congratulations! You've been promoted to ${TIER_CONFIG[newTier].name}! üéâ`);
                App.currentProfileData.membershipTier = newTier;
                populateSettings(App.currentProfileData);
            }
        }

        function renderVerificationSettings(data) {
            const container = document.getElementById('verification-section');
            let html = `<h3>Individual Verification ‚úîÔ∏è</h3>`;
            const tier = data.membershipTier || 'Member';
            const tierConfig = TIER_CONFIG[tier];
            
            if (data.verified) {
                html += `<p style="color: green; font-weight: bold;">Your account is officially verified.</p>`;
            } else if (data.verificationRequested) {
                html += `<p style="color: orange;">Your verification request is pending review.</p>`;
            } else if (tierConfig.verification) {
                html += `<p>As a ${TIER_CONFIG[tier].name} tier member, you are eligible to apply for verification.</p><button id="request-verification-btn" class="btn secondary">Apply for Verification</button>`;
            } else {
                 html += `<p>Reach the <b>VIP</b> membership tier to become eligible for verification. You are currently on **${TIER_CONFIG[tier].name}**.</p>`;
            }
            container.innerHTML = html;
            document.getElementById('request-verification-btn')?.addEventListener('click', handleRequestVerification);
        }

        async function handleRequestVerification() {
            if (confirm("You are about to submit your profile for manual review. Continue?")) {
                const updates = { verificationRequested: true };
                await update(ref(db, `users/${App.currentUser.userId}`), updates);
                showToast("Verification request submitted!");
                renderVerificationSettings({ ...App.currentProfileData, ...updates });
            }
        }
        
        async function renderOrganizationsPage(publicOrgId = null) {
            const pageContainer = document.getElementById('organizationsPage');
            pageContainer.innerHTML = '<div class="card"><p>Loading...</p></div>';

            const orgId = publicOrgId || App.currentProfileData?.organizationId;

            if (orgId) {
                const orgSnap = await get(ref(db, `organizations/${orgId}`));
                if (!orgSnap.exists()) {
                    pageContainer.innerHTML = '<div class="card"><h2>Organization Not Found</h2></div>';
                    if (!publicOrgId && App.currentProfileData?.organizationId) {
                        await update(ref(db, `users/${App.currentUser.userId}`), { organizationId: null });
                    }
                    return;
                }
                const orgData = orgSnap.val();
                
                if (publicOrgId) {
                    App.currentProfileData = {
                        type: 'org', 
                        verified: orgData.verified,
                        membershipTier: 'Max',
                        ...orgData
                    }; 
                }

                const isOrgAdmin = !publicOrgId && orgData.adminId === App.currentUser.userId;
                
                const memberIds = Object.keys(orgData.members || {});
                const memberPromises = memberIds.map(id => get(ref(db, `users/${id}`)));
                const memberSnaps = await Promise.all(memberPromises);
                const membersHtml = memberSnaps.map(snap => {
                    if (!snap.exists()) return '';
                    const memberData = snap.val();
                    const pfpUrl = memberData.pfpUrl || ''; 
                    return `<div class="org-member-item">
                                <div class="org-member-pfp" style="background-image: url(${pfpUrl})"></div>
                                <div>
                                    <strong><a href="?user=${snap.key}">${memberData.displayName}</a></strong>
                                    <p style="margin:0; color: var(--muted);">${memberData.status} ${memberData.message || ''}</p>
                                </div>
                            </div>`;
                }).join('');
                
                let adminActions = '';
                if(isOrgAdmin) {
                    adminActions = `<div class="card">
                        <h2>Admin Actions</h2>
                        <button id="invite-member-btn" class="btn secondary">Invite Member</button>
                        ${!orgData.verified && !orgData.verificationRequested ? '<button id="request-org-verify-btn" class="btn secondary" style="margin-top: 10px;">Request Verification</button>' : ''}
                        ${orgData.verificationRequested && !orgData.verified ? '<p style="color:orange; margin-top:10px;">Verification pending review.</p>' : ''}
                       </div>`;
                }

                pageContainer.innerHTML = `
                    <div class="card" style="text-align:center; padding-bottom: 50px;">
                        <div id="org-banner" style="background-image: url(${orgData.verified ? orgData.bannerUrl || '' : ''}); background-color: ${orgData.verified ? orgData.brandColor || 'var(--input-bg)' : 'var(--input-bg)'};"></div>
                        <img id="org-logo" src="${orgData.logoUrl || ''}" alt="Logo">
                        <h2 style="margin-top: -20px;">${orgData.name} ${orgData.verified ? '<svg class="inline-verified-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.97 4.27a2.25 2.25 0 0 0-1.94 0l-7.5 4.22a2.25 2.25 0 0 0-1.16 1.95v7.22c0 .98.623 1.822 1.524 2.148l6.75 2.455a2.25 2.25 0 0 0 2.252 0l6.75-2.455A2.25 2.25 0 0 0 21.75 17.7v-7.22a2.25 2.25 0 0 0-1.16-1.95l-7.5-4.22Z"></path></svg>' : ''}</h2>
                        <p>${orgData.tagline}</p>
                        ${orgData.verified && orgData.about ? `<p>${orgData.about}</p>`: ''}
                    </div>
                    <div class="card">
                        <h3>Members (${memberIds.length}/${orgData.verified ? 50 : 5})</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                           ${membersHtml || '<p class="muted">No members yet.</p>'}
                        </div>
                    </div>
                    ${adminActions}
                `;
                document.getElementById('invite-member-btn')?.addEventListener('click', () => {
                    const email = prompt("Enter the email of the user to invite:");
                    if(email) handleInviteMember(email, orgId, orgData);
                });
                document.getElementById('request-org-verify-btn')?.addEventListener('click', () => handleRequestOrgVerification(orgId));

            } else {
                pageContainer.innerHTML = `
                    <div class="card">
                        <h2>Join or Create an Organization</h2>
                        <p>Create a central directory for your team to showcase members and their real-time availability.</p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button id="create-org-btn" class="btn">Create New Organization</button>
                            <button id="join-org-btn" class="btn secondary">Join Existing Organization</button>
                        </div>
                    </div>
                `;
                document.getElementById('create-org-btn').addEventListener('click', showCreateOrgForm);
                document.getElementById('join-org-btn').addEventListener('click', handleJoinOrganization);
            }
        }
        
        async function handleJoinOrganization() {
            const orgId = prompt("Enter Organization ID (Ask your Admin):");
            if (!orgId) return;

            const orgRef = ref(db, `organizations/${orgId}`);
            const orgSnap = await get(orgRef);
            if (!orgSnap.exists()) return showToast("Invalid Organization ID.", "error");

            const orgData = orgSnap.val();
            const userId = App.currentUser.userId;

            if (orgData.members && orgData.members[userId]) {
                return showToast("You are already a member of this organization.", "error");
            }
            if(Object.keys(orgData.members || {}).length >= (orgData.verified ? 50 : 5)) {
                return showToast("Organization member limit reached.", "error");
            }

            await update(ref(db, `users/${userId}`), { organizationId: orgId });
            await update(ref(db, `organizations/${orgId}/members`), { [userId]: true });
            
            App.currentProfileData.organizationId = orgId;
            showToast(`Joined ${orgData.name} successfully!`);
            renderOrganizationsPage();
        }

        function showCreateOrgForm() {
             const pageContainer = document.getElementById('organizationsPage');
             pageContainer.innerHTML = `
                <div class="card">
                    <h2>Create New Organization</h2>
                    <form id="create-org-form">
                        <div class="form-group"><label>Organization Name</label><input type="text" id="org-name" required></div>
                        <div class="form-group"><label>Industry</label><input type="text" id="org-industry" required></div>
                        <div class="form-group"><label>Tagline (Short Slogan)</label><input type="text" id="org-tagline" required></div>
                        <div class="form-group"><label>Website URL</label><input type="url" id="org-website" required></div>
                        <div class="form-group"><label>Logo (Upload)</label><input type="file" id="org-logo-upload" accept="image/*" required></div>
                        <button type="submit" class="btn">Create</button>
                        <button type="button" id="cancel-create-org" class="btn secondary" style="margin-top:10px;">Cancel</button>
                    </form>
                </div>
              `;
             document.getElementById('create-org-form').addEventListener('submit', handleCreateOrganization);
             document.getElementById('cancel-create-org').addEventListener('click', renderOrganizationsPage);
        }
        
        async function handleCreateOrganization(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            
            const orgName = document.getElementById('org-name').value.trim();
            const industry = document.getElementById('org-industry').value.trim();
            const tagline = document.getElementById('org-tagline').value.trim();
            const website = document.getElementById('org-website').value.trim();
            const logoFile = document.getElementById('org-logo-upload').files[0];
            
            if(!orgName || !logoFile || !industry || !tagline || !website) return showToast('All fields are required.', 'error');
            
            btn.classList.add('btn-loading');
            btn.textContent = 'Creating...';
            
            try {
                const logoRef = storageRef(storage, `org_logos/${App.currentUser.userId}_${Date.now()}_${logoFile.name}`); 
                await uploadBytes(logoRef, logoFile);
                const logoUrl = await getDownloadURL(logoRef);
                
                const orgsRef = ref(db, 'organizations');
                const newOrgRef = push(orgsRef);
                const newOrgData = {
                    id: newOrgRef.key,
                    name: orgName,
                    industry: industry,
                    tagline: tagline,
                    website: website,
                    logoUrl: logoUrl,
                    adminId: App.currentUser.userId,
                    members: { [App.currentUser.userId]: true },
                    verified: false,
                    createdAt: new Date().toISOString()
                };
                await set(newOrgRef, newOrgData);
                
                await update(ref(db, `users/${App.currentUser.userId}`), { organizationId: newOrgData.id });
                App.currentProfileData.organizationId = newOrgData.id;
                
                showToast("Organization created successfully!", "info");
                renderOrganizationsPage();
                
            } catch(err) {
                console.error("Org Creation Failed:", err);
                showToast("Failed to create organization. Please try again.", "error");
                
            } finally {
                btn.classList.remove('btn-loading');
                btn.textContent = 'Create';
            }
        }
        
        async function handleInviteMember(email, orgId, orgData) {
            if(Object.keys(orgData.members).length >= (orgData.verified ? 50 : 5)) {
                return showToast("Member limit reached.", "error");
            }
            
            const usersRef = query(ref(db, 'users'), orderByChild('email'), equalTo(email));
            const snap = await get(usersRef);
            if (!snap.exists()) return showToast("User with that email not found.", "error");

            const [userId, userData] = Object.entries(snap.val())[0];
            if(userData.organizationId) return showToast("User is already in an organization.", "error");
            
            if(userId === orgData.adminId) return showToast("User is already the admin.", "error");

            await update(ref(db, `users/${userId}`), { organizationId: orgId });
            await update(ref(db, `organizations/${orgId}/members`), { [userId]: true });
            
            showToast(`${userData.displayName} has been added to the organization!`);
            renderOrganizationsPage();
        }
        
        async function handleRequestOrgVerification(orgId) {
            if (confirm("Submit this organization for manual verification?")) {
                await update(ref(db, `organizations/${orgId}`), { verificationRequested: true });
                showToast("Verification request submitted!");
                renderOrganizationsPage();
            }
        }


        // --- PAGE-SPECIFIC RENDERERS ---
        function renderTiersPage() {
            const detailsContainer = document.getElementById('my-plan-details');
            const progressContainer = document.getElementById('my-plan-progress');
            const allTiersContainer = document.getElementById('all-tiers-info');
            if (!App.currentProfileData) return;

            const tier = App.currentProfileData.membershipTier || 'Member';
            const achievements = App.currentProfileData.achievements || {};
            const tierConfig = TIER_CONFIG[tier];
            
            detailsContainer.innerHTML = `
                <h3>Current Tier: <span style="color: var(--primary);">${TIER_CONFIG[tier].name}</span></h3>
                <p>You unlock new perks by completing achievements and engaging with the platform.</p>
            `;
            
            let nextTierKey, requirements;
            if (tier === 'Member') { nextTierKey = 'MemberPlus'; requirements = ACHIEVEMENT_CONFIG.toMemberPlus; }
            else if (tier === 'MemberPlus') { nextTierKey = 'VIP'; requirements = ACHIEVEMENT_CONFIG.toVIP; }
            else if (tier === 'VIP') { nextTierKey = 'Max'; requirements = ACHIEVEMENT_CONFIG.toMax; }
            else {
                progressContainer.innerHTML = '<h2>You have reached the highest public tier! üöÄ</h2><p>Thank you for being a power user!</p>';
            }

            if (nextTierKey && requirements) {
                let progressHtml = `<h2>Progress to ${TIER_CONFIG[nextTierKey].name}</h2>`;
                requirements.forEach(req => {
                    let currentValue = achievements[req.id] || 0;
                    const progress = Math.min((currentValue / req.goal) * 100, 100);
                    progressHtml += `
                        <div class="achievement-item">
                            <strong>${req.label} (${currentValue} / ${req.goal})</strong>
                            <div class="achievement-progress">
                                <div class="progress-bar" style="width: ${progress}%; background-color: ${progress >= 100 ? '#22c55e' : 'var(--primary)'};"></div>
                            </div>
                        </div>
                    `;
                });
                progressContainer.innerHTML = progressHtml;
            }

            // Render all tiers info
            let allTiersHtml = '<div class="tier-plan-grid">';
            for (const tierKey of ['Member', 'MemberPlus', 'VIP', 'Max']) {
                const config = TIER_CONFIG[tierKey];
                allTiersHtml += `
                    <div class="tier-plan-card">
                        <h3><div class="membership-badge tier-${tierKey}">${config.name}</div></h3>
                        <ul>
                            <li>${config.linkLimit} Custom Link${config.linkLimit > 1 ? 's' : ''}</li>
                            <li>${config.customFont ? 'Custom Profile Font' : 'Standard Font'}</li>
                            <li>${config.scheduling ? 'Scheduling Link Display' : 'No Scheduling Link'}</li>
                            <li>${config.timetable ? 'Automatic Timetable' : 'Manual Status Only'}</li>
                            <li>${config.customColor ? 'Custom Profile Colors' : 'Standard Colors'}</li>
                            <li>${config.analytics ? 'Profile Analytics' : 'No Analytics'}</li>
                            <li>${config.verification ? 'Verification Eligible' : 'Not Verification Eligible'}</li>
                        </ul>
                    </div>
                `;
            }
            allTiersHtml += '</div>';
            allTiersContainer.innerHTML = allTiersHtml;
        }

        async function renderAdminPanel() {
            const requestsContainer = document.getElementById('admin-verification-requests');
            const usersContainer = document.getElementById('admin-all-users');
            const orgsContainer = document.getElementById('admin-all-orgs');
            
            requestsContainer.innerHTML = '<p class="muted">Loading requests...</p>';
            usersContainer.innerHTML = '<p class="muted">Loading users...</p>';
            orgsContainer.innerHTML = '<p class="muted">Loading organizations...</p>';

            const [usersSnap, orgsSnap] = await Promise.all([get(ref(db, 'users')), get(ref(db, 'organizations'))]);
            const allUsers = usersSnap.val() || {};
            const allOrgs = orgsSnap.val() || {};
            
            const userRequests = Object.entries(allUsers).filter(([uid, user]) => user.verificationRequested && !user.verified).map(([uid, user]) => ({type: 'User', uid, user}));
            const orgRequests = Object.entries(allOrgs).filter(([id, org]) => org.verificationRequested && !org.verified).map(([id, org]) => ({type: 'Organization', id, org}));
            const allRequests = [...userRequests, ...orgRequests];

            if (allRequests.length > 0) {
                requestsContainer.innerHTML = allRequests.map(req => `
                    <div class="verification-request-card">
                        <p><strong>Type:</strong> ${req.type}</p>
                        <p><strong>Name:</strong> ${req.user?.displayName || req.org?.name}</p>
                        <p><strong>ID:</strong> ${req.uid || req.id}</p>
                        <div class="verification-actions">
                            <button class="btn approve-verify-btn" data-id="${req.uid || req.id}" data-type="${req.type.toLowerCase()}">Approve</button>
                            <button class="btn secondary deny-verify-btn" data-id="${req.uid || req.id}" data-type="${req.type.toLowerCase()}">Deny</button>
                        </div>
                    </div>
                `).join('');
            } else {
                requestsContainer.innerHTML = '<p>No active verification requests.</p>';
            }

            usersContainer.innerHTML = `<table class="admin-table"><thead><tr><th>Name</th><th>Email</th><th>Tier</th><th>Role</th></tr></thead><tbody>
                ${Object.entries(allUsers).map(([uid, user]) => `
                    <tr>
                        <td><a href="?user=${uid}" target="_blank">${user.displayName}</a></td>
                        <td>${user.email}</td>
                        <td><select class="admin-edit-field" data-uid="${uid}" data-field="membershipTier">${Object.keys(TIER_CONFIG).map(t => `<option value="${t}" ${user.membershipTier === t ? 'selected' : ''}>${t}</option>`).join('')}</select></td>
                        <td><select class="admin-edit-field" data-uid="${uid}" data-field="role">${['Member', 'Owner'].map(r => `<option value="${r}" ${user.role === r ? 'selected' : ''}>${r}</option>`).join('')}</select></td>
                    </tr>
                `).join('')}
            </tbody></table>`;
            
            orgsContainer.innerHTML = `<table class="admin-table"><thead><tr><th>Name</th><th>Admin</th><th>Members</th><th>Status</th><th>Actions</th></tr></thead><tbody>
                ${Object.entries(allOrgs).map(([id, org]) => `
                    <tr>
                        <td><a href="?org=${id}" target="_blank">${org.name}</a></td>
                        <td>${allUsers[org.adminId]?.displayName || 'N/A'}</td>
                        <td>${Object.keys(org.members || {}).length}</td>
                        <td>${org.verified ? 'Verified' : 'Unverified'}</td>
                        <td><button class="btn secondary delete-org-btn" data-id="${id}" data-name="${org.name}">Delete</button></td>
                    </tr>
                `).join('')}
            </tbody></table>`;

            document.querySelectorAll('.approve-verify-btn, .deny-verify-btn').forEach(btn => btn.addEventListener('click', handleVerificationAction));
            document.querySelectorAll('.admin-edit-field').forEach(sel => sel.addEventListener('change', handleAdminEdit));
            document.querySelectorAll('.delete-org-btn').forEach(btn => btn.addEventListener('click', handleAdminDeleteOrg));
        }

        async function handleVerificationAction(e) {
            const { id, type } = e.target.dataset;
            const isApprove = e.target.classList.contains('approve-verify-btn');
            const path = type === 'user' ? `users/${id}` : `organizations/${id}`;
            const updates = isApprove ? { verified: true, verificationRequested: false } : { verified: false, verificationRequested: false };
            await update(ref(db, path), updates);
            showToast(`${type} request ${isApprove ? 'approved' : 'denied'}.`);
            renderAdminPanel();
            
            if(isApprove && type === 'user') {
                await updateMembershipTier(id); 
            }
        }

        async function handleAdminEdit(e) {
            const { uid, field } = e.target.dataset;
            const value = e.target.value;
            await update(ref(db, `users/${uid}`), { [field]: value });
            showToast(`User ${field} updated.`);
            if (field === 'membershipTier' || field === 'role') {
                await updateMembershipTier(uid);
            }
        }

        async function handleAdminDeleteOrg(e) {
            const { id, name } = e.target.dataset;
            if(confirm(`Really delete organization "${name}"? This will also remove the org link from all its members.`)) {
                const orgSnap = await get(ref(db, `organizations/${id}`));
                const orgData = orgSnap.val();
                if(orgData.members) {
                    const memberUpdates = {};
                    Object.keys(orgData.members).forEach(uid => {
                        memberUpdates[`/users/${uid}/organizationId`] = null;
                    });
                    await update(ref(db), memberUpdates);
                }
                await set(ref(db, `organizations/${id}`), null);
                showToast('Organization deleted.');
                renderAdminPanel();
            }
        }

        // --- GLOBAL EVENT LISTENERS ---
        function addEventListeners() {
            document.querySelector('.auth-tabs')?.addEventListener('click', e => {
                if (e.target.classList.contains('tab')) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    const isLogin = e.target.dataset.tab === 'login';
                    document.getElementById('login-form').classList.toggle('hidden', !isLogin);
                    document.getElementById('signup-form').classList.toggle('hidden', isLogin);
                }
            });
            document.getElementById('signup-form')?.addEventListener('submit', handleEmailSignup);
            document.getElementById('login-form')?.addEventListener('submit', handleEmailLogin);
            document.getElementById('google-login-btn')?.addEventListener('click', handleGoogleLogin);
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('delete-account-btn')?.addEventListener('click', handleDeleteAccount);
            document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
            document.getElementById('share-status-btn')?.addEventListener('click', handleShareStatus);
            document.getElementById('add-timetable-entry-btn')?.addEventListener('click', handleAddTimetableEntry);
            document.getElementById('run-search-btn')?.addEventListener('click', handleSearchUsers);
            document.getElementById('generate-qrcode-btn')?.addEventListener('click', handleGenerateQrCode);
            App.elements.mainHeader?.addEventListener('click', e => {
                const navBtn = e.target.closest('.nav-btn');
                if (navBtn) navigateTo(navBtn.dataset.page);
            });
            const countrySearch = document.getElementById('country-search');
            const countryDropdown = document.getElementById('country-dropdown');
            countrySearch?.addEventListener('focus', () => { countryDropdown.classList.remove('hidden'); filterCountries(); });
            countrySearch?.addEventListener('keyup', filterCountries);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.country-select-wrapper')) countryDropdown.classList.add('hidden');
            });
        }

        document.addEventListener('DOMContentLoaded', handlePageLoad);
    </script>
</body>
</html>
