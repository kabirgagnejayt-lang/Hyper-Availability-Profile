<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyper Availability Profile (HAP)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background-color: #f0f2f5; margin: 0; color: #333;
        }
        .container {
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); width: 90%;
            max-width: 500px; box-sizing: border-box;
        }
        h1, h2, h3 { text-align: center; color: #1c1e21; }
        input, select, button {
            width: 100%; padding: 14px; margin-bottom: 16px;
            box-sizing: border-box; border: 1px solid #dddfe2;
            border-radius: 6px; font-size: 1em;
        }
        button {
            background-color: #007bff; color: white; border: none;
            cursor: pointer; font-weight: bold; transition: background-color 0.2s;
        }
        button:hover { background-color: #0056b3; }
        #logout-btn { background-color: #dc3545; margin-top: 10px; }
        #logout-btn:hover { background-color: #c82333; }
        #profile-link-container {
            margin-top: 25px; padding: 15px; border-radius: 6px;
            word-wrap: break-word; background-color: #f0f2f5;
            border: 1px solid #e0e0e0;
        }
        #error-message { color: red; text-align: center; min-height: 20px; font-weight: bold; }
        #profile-card { text-align: center; }
        #profile-email { font-weight: bold; color: #606770; font-size: 1.5em; }
        #profile-emoji { font-size: 6em; margin: 20px 0; }
        #profile-message { font-size: 1.25em; min-height: 25px; color: #1c1e21; }
        #profile-timer { margin-top: 25px; font-size: 2em; color: #007bff; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login/Signup View -->
        <div id="auth-view">
            <h1>Hyper Availability Profile</h1>
            <h3>Login or create an account</h3>
            <div style="background-color: #fffbe6; border: 1px solid #ffe58f; padding: 10px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
                <strong>Warning:</strong> This login is not secure. Do not use real passwords.
            </div>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn">Login</button>
            <button id="signup-btn" style="background-color: #28a745;">Sign Up</button>
            <p id="error-message"></p>
        </div>

        <!-- Dashboard View (for logged-in users) -->
        <div id="dashboard-view" class="hidden">
            <h2 id="welcome-user"></h2>
            <h3>Update Your Status</h3>
            <select id="status-emoji">
                <option value="üü¢">üü¢ Available</option>
                <option value="üß†">üß† Deep Work</option>
                <option value="üöó">üöó Commuting</option>
                <option value="‚òï">‚òï On a Break</option>
                <option value="üî¥">üî¥ Do Not Disturb</option>
            </select>
            <input type="text" id="status-message" placeholder="Message (e.g., Drafting 2026 Strategy)">
            <input type="number" id="status-duration" placeholder="Duration in minutes (0 for none)">
            <button id="update-status-btn">Set Status</button>
            <div id="profile-link-container">
                <h4>Your Permanent Profile Link:</h4>
                <a href="" id="public-profile-link" target="_blank"></a>
            </div>
            <button id="logout-btn">Logout</button>
        </div>

        <!-- Public Profile View -->
        <div id="profile-view" class="hidden">
            <div id="profile-card">
                <h2 id="profile-email">Loading...</h2>
                <div id="profile-emoji">‚ùì</div>
                <p id="profile-message">Fetching status...</p>
                <div id="profile-timer"></div>
            </div>
        </div>
    </div>
    
    <script>
        const DATABASE_URL = "https://happp-96438-default-rtdb.firebaseio.com/";
        let countdownInterval;

        // --- DOM Elements ---
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const profileView = document.getElementById('profile-view');
        const errorMessage = document.getElementById('error-message');

        /**
         * Converts an email into a safe key for Firebase Realtime Database.
         * Firebase keys cannot contain '.', '#', '$', '[', or ']'.
         */
        function emailToId(email) {
            return btoa(email).replace(/=/g, ''); // Base64 encode for a safe key
        }

        /**
         * Main router to decide which view to show.
         */
        function handlePageLoad() {
            const params = new URLSearchParams(window.location.search);
            const userIdFromUrl = params.get('user');

            if (userIdFromUrl) {
                // Public profile view
                authView.classList.add('hidden');
                dashboardView.classList.add('hidden');
                profileView.classList.remove('hidden');
                displayProfile(userIdFromUrl);
            } else {
                // Check if user is "logged in" via session storage
                const loggedInUser = sessionStorage.getItem('hapUser');
                if (loggedInUser) {
                    const user = JSON.parse(loggedInUser);
                    showDashboard(user.email, user.userId);
                } else {
                    authView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    profileView.classList.add('hidden');
                }
            }
        }

        /**
         * Shows the dashboard for a logged-in user.
         */
        function showDashboard(email, userId) {
            authView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            profileView.classList.add('hidden');
            document.getElementById('welcome-user').textContent = `Welcome, ${email}`;
            
            const profileLink = document.getElementById('public-profile-link');
            const publicUrl = `${window.location.origin}${window.location.pathname}?user=${userId}`;
            profileLink.href = publicUrl;
            profileLink.textContent = publicUrl;
        }

        // --- Event Listeners ---
        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) {
                errorMessage.textContent = 'Email and password cannot be empty.';
                return;
            }

            const userId = emailToId(email);
            const userRef = `${DATABASE_URL}/logins/${userId}.json`;
            
            // DANGEROUS: Storing password in a publicly readable database.
            const userLoginData = { email, password };

            const response = await fetch(userRef);
            const data = await response.json();

            if (data) {
                errorMessage.textContent = 'An account with this email already exists.';
            } else {
                await fetch(userRef, { method: 'PUT', body: JSON.stringify(userLoginData) });
                sessionStorage.setItem('hapUser', JSON.stringify({ email, userId }));
                showDashboard(email, userId);
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) {
                errorMessage.textContent = 'Email and password cannot be empty.';
                return;
            }
            const userId = emailToId(email);
            const userRef = `${DATABASE_URL}/logins/${userId}.json`;
            
            const response = await fetch(userRef);
            const data = await response.json();

            // DANGEROUS: Checking a publicly readable password.
            if (data && data.password === password) {
                sessionStorage.setItem('hapUser', JSON.stringify({ email, userId }));
                showDashboard(email, userId);
            } else {
                errorMessage.textContent = 'Invalid email or password.';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('hapUser');
            // Redirect to the base page to show the login screen
            window.location.href = window.location.origin + window.location.pathname;
        });

        document.getElementById('update-status-btn').addEventListener('click', () => {
            const user = JSON.parse(sessionStorage.getItem('hapUser'));
            if (!user) return;

            const statusData = {
                email: user.email,
                status: document.getElementById('status-emoji').value,
                message: document.getElementById('status-message').value,
                updatedAt: new Date().toISOString()
            };

            const duration = parseInt(document.getElementById('status-duration').value, 10);
            statusData.endTime = duration > 0 ? new Date(Date.now() + duration * 60 * 1000).toISOString() : null;

            fetch(`${DATABASE_URL}/users/${user.userId}.json`, { method: 'PUT', body: JSON.stringify(statusData) })
                .then(response => {
                    if (!response.ok) { throw new Error('Network response was not ok'); }
                    return response.json();
                })
                .then(() => alert('Status updated successfully!'))
                .catch(error => {
                    console.error("Update status error:", error);
                    alert('Error updating status. See console for details.');
                });
        });

        /**
         * Fetches and displays a user's profile.
         */
        function displayProfile(userId) {
            const userStatusRef = `${DATABASE_URL}/users/${userId}.json`;

            const fetchAndUpdate = () => {
                fetch(userStatusRef)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('profile-email').textContent = data.email;
                            document.getElementById('profile-emoji').textContent = data.status || '‚ùì';
                            document.getElementById('profile-message').textContent = data.message || 'No message set.';
                            updateTimer(data.endTime, document.getElementById('profile-timer'));
                        } else {
                            document.getElementById('profile-email').textContent = 'User Not Found';
                            document.getElementById('profile-emoji').textContent = 'üö´';
                        }
                    }).catch(error => {
                        console.error("Display profile error:", error);
                        document.getElementById('profile-email').textContent = 'Error Loading Profile';
                    });
            };
            
            fetchAndUpdate();
            // Using a timer to update the display is a simple way to show real-time changes without full SDK
            setInterval(fetchAndUpdate, 15000); 
        }
        
        function updateTimer(endTimeString, timerEl) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!endTimeString) {
                timerEl.textContent = '';
                return;
            }
            const endTime = new Date(endTimeString).getTime();
            countdownInterval = setInterval(() => {
                const distance = endTime - new Date().getTime();
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    timerEl.textContent = "Time's up!";
                    return;
                }
                const h = Math.floor(distance / (36e5));
                const m = Math.floor((distance % 36e5) / 6e4);
                const s = Math.floor((distance % 6e4) / 1000);
                timerEl.textContent = h > 0 ? `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}` : `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }, 1000);
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', handlePageLoad);
    </script>
</body>
</html>

